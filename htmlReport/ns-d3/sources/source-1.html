


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > FlywayAutoConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.autoconfigure.flyway</a>
</div>

<h1>Coverage Summary for Class: FlywayAutoConfiguration (org.springframework.boot.autoconfigure.flyway)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">FlywayAutoConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
</tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$Extension</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayAutoConfigurationRuntimeHints</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/144)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayDataSourceCondition</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayDataSourceCondition$DataSourceBeanCondition</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayDataSourceCondition$FlywayUrlCondition</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$FlywayDataSourceCondition$JdbcConnectionDetailsCondition</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$LocationResolver</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/19)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$OracleFlywayConfigurationCustomizer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$PostgresqlFlywayConfigurationCustomizer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$PropertiesFlywayConnectionDetails</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$SqlServerFlywayConfigurationCustomizer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">FlywayAutoConfiguration$StringOrNumberToMigrationVersionConverter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/215)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.autoconfigure.flyway;
&nbsp;
&nbsp;import java.sql.DatabaseMetaData;
&nbsp;import java.time.Duration;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.function.BiConsumer;
&nbsp;import java.util.function.Consumer;
&nbsp;
&nbsp;import javax.sql.DataSource;
&nbsp;
&nbsp;import org.flywaydb.core.Flyway;
&nbsp;import org.flywaydb.core.api.MigrationVersion;
&nbsp;import org.flywaydb.core.api.callback.Callback;
&nbsp;import org.flywaydb.core.api.configuration.FluentConfiguration;
&nbsp;import org.flywaydb.core.api.migration.JavaMigration;
&nbsp;import org.flywaydb.core.extensibility.ConfigurationExtension;
&nbsp;import org.flywaydb.core.internal.database.postgresql.PostgreSQLConfigurationExtension;
&nbsp;import org.flywaydb.database.oracle.OracleConfigurationExtension;
&nbsp;import org.flywaydb.database.sqlserver.SQLServerConfigurationExtension;
&nbsp;
&nbsp;import org.springframework.aot.hint.RuntimeHints;
&nbsp;import org.springframework.aot.hint.RuntimeHintsRegistrar;
&nbsp;import org.springframework.beans.factory.ObjectProvider;
&nbsp;import org.springframework.boot.autoconfigure.AutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration.FlywayAutoConfigurationRuntimeHints;
&nbsp;import org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration.FlywayDataSourceCondition;
&nbsp;import org.springframework.boot.autoconfigure.flyway.FlywayProperties.Oracle;
&nbsp;import org.springframework.boot.autoconfigure.flyway.FlywayProperties.Postgresql;
&nbsp;import org.springframework.boot.autoconfigure.flyway.FlywayProperties.Sqlserver;
&nbsp;import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.jdbc.JdbcConnectionDetails;
&nbsp;import org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration;
&nbsp;import org.springframework.boot.context.properties.ConfigurationPropertiesBinding;
&nbsp;import org.springframework.boot.context.properties.EnableConfigurationProperties;
&nbsp;import org.springframework.boot.context.properties.PropertyMapper;
&nbsp;import org.springframework.boot.jdbc.DataSourceBuilder;
&nbsp;import org.springframework.boot.jdbc.DatabaseDriver;
&nbsp;import org.springframework.boot.sql.init.dependency.DatabaseInitializationDependencyConfigurer;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Conditional;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.context.annotation.Import;
&nbsp;import org.springframework.context.annotation.ImportRuntimeHints;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.annotation.Order;
&nbsp;import org.springframework.core.convert.TypeDescriptor;
&nbsp;import org.springframework.core.convert.converter.GenericConverter;
&nbsp;import org.springframework.core.io.ResourceLoader;
&nbsp;import org.springframework.jdbc.datasource.SimpleDriverDataSource;
&nbsp;import org.springframework.jdbc.support.JdbcUtils;
&nbsp;import org.springframework.jdbc.support.MetaDataAccessException;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.springframework.util.ObjectUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import org.springframework.util.function.SingletonSupplier;
&nbsp;
&nbsp;/**
&nbsp; * {@link EnableAutoConfiguration Auto-configuration} for Flyway database migrations.
&nbsp; *
&nbsp; * @author Dave Syer
&nbsp; * @author Phillip Webb
&nbsp; * @author Vedran Pavic
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Jacques-Etienne Beaudet
&nbsp; * @author Eddú Meléndez
&nbsp; * @author Dominic Gunn
&nbsp; * @author Dan Zheng
&nbsp; * @author András Deák
&nbsp; * @author Semyon Danilov
&nbsp; * @author Chris Bono
&nbsp; * @author Moritz Halbritter
&nbsp; * @author Andy Wilkinson
&nbsp; * @since 1.1.0
&nbsp; */
&nbsp;@AutoConfiguration(after = { DataSourceAutoConfiguration.class, JdbcTemplateAutoConfiguration.class,
&nbsp;		HibernateJpaAutoConfiguration.class })
&nbsp;@ConditionalOnClass(Flyway.class)
&nbsp;@Conditional(FlywayDataSourceCondition.class)
&nbsp;@ConditionalOnProperty(prefix = &quot;spring.flyway&quot;, name = &quot;enabled&quot;, matchIfMissing = true)
&nbsp;@Import(DatabaseInitializationDependencyConfigurer.class)
&nbsp;@ImportRuntimeHints(FlywayAutoConfigurationRuntimeHints.class)
<b class="nc">&nbsp;public class FlywayAutoConfiguration {</b>
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConfigurationPropertiesBinding
&nbsp;	public StringOrNumberToMigrationVersionConverter stringOrNumberMigrationVersionConverter() {
<b class="nc">&nbsp;		return new StringOrNumberToMigrationVersionConverter();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	public FlywaySchemaManagementProvider flywayDefaultDdlModeProvider(ObjectProvider&lt;Flyway&gt; flyways) {
<b class="nc">&nbsp;		return new FlywaySchemaManagementProvider(flyways);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Configuration(proxyBeanMethods = false)
&nbsp;	@ConditionalOnClass(JdbcUtils.class)
&nbsp;	@ConditionalOnMissingBean(Flyway.class)
&nbsp;	@EnableConfigurationProperties(FlywayProperties.class)
&nbsp;	public static class FlywayConfiguration {
&nbsp;
&nbsp;		private final FlywayProperties properties;
&nbsp;
<b class="nc">&nbsp;		FlywayConfiguration(FlywayProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		ResourceProviderCustomizer resourceProviderCustomizer() {
<b class="nc">&nbsp;			return new ResourceProviderCustomizer();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnMissingBean(FlywayConnectionDetails.class)
&nbsp;		PropertiesFlywayConnectionDetails flywayConnectionDetails() {
<b class="nc">&nbsp;			return new PropertiesFlywayConnectionDetails(this.properties);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnClass(name = &quot;org.flywaydb.database.sqlserver.SQLServerConfigurationExtension&quot;)
&nbsp;		SqlServerFlywayConfigurationCustomizer sqlServerFlywayConfigurationCustomizer() {
<b class="nc">&nbsp;			return new SqlServerFlywayConfigurationCustomizer(this.properties);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnClass(name = &quot;org.flywaydb.database.oracle.OracleConfigurationExtension&quot;)
&nbsp;		OracleFlywayConfigurationCustomizer oracleFlywayConfigurationCustomizer() {
<b class="nc">&nbsp;			return new OracleFlywayConfigurationCustomizer(this.properties);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnClass(name = &quot;org.flywaydb.core.internal.database.postgresql.PostgreSQLConfigurationExtension&quot;)
&nbsp;		PostgresqlFlywayConfigurationCustomizer postgresqlFlywayConfigurationCustomizer() {
<b class="nc">&nbsp;			return new PostgresqlFlywayConfigurationCustomizer(this.properties);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		Flyway flyway(FlywayConnectionDetails connectionDetails, ResourceLoader resourceLoader,
&nbsp;				ObjectProvider&lt;DataSource&gt; dataSource, @FlywayDataSource ObjectProvider&lt;DataSource&gt; flywayDataSource,
&nbsp;				ObjectProvider&lt;FlywayConfigurationCustomizer&gt; fluentConfigurationCustomizers,
&nbsp;				ObjectProvider&lt;JavaMigration&gt; javaMigrations, ObjectProvider&lt;Callback&gt; callbacks,
&nbsp;				ResourceProviderCustomizer resourceProviderCustomizer) {
<b class="nc">&nbsp;			FluentConfiguration configuration = new FluentConfiguration(resourceLoader.getClassLoader());</b>
<b class="nc">&nbsp;			configureDataSource(configuration, flywayDataSource.getIfAvailable(), dataSource.getIfUnique(),</b>
&nbsp;					connectionDetails);
<b class="nc">&nbsp;			configureProperties(configuration, this.properties);</b>
<b class="nc">&nbsp;			configureCallbacks(configuration, callbacks.orderedStream().toList());</b>
<b class="nc">&nbsp;			configureJavaMigrations(configuration, javaMigrations.orderedStream().toList());</b>
<b class="nc">&nbsp;			fluentConfigurationCustomizers.orderedStream().forEach((customizer) -&gt; customizer.customize(configuration));</b>
<b class="nc">&nbsp;			resourceProviderCustomizer.customize(configuration);</b>
<b class="nc">&nbsp;			return configuration.load();</b>
&nbsp;		}
&nbsp;
&nbsp;		private void configureDataSource(FluentConfiguration configuration, DataSource flywayDataSource,
&nbsp;				DataSource dataSource, FlywayConnectionDetails connectionDetails) {
<b class="nc">&nbsp;			DataSource migrationDataSource = getMigrationDataSource(flywayDataSource, dataSource, connectionDetails);</b>
<b class="nc">&nbsp;			configuration.dataSource(migrationDataSource);</b>
&nbsp;		}
&nbsp;
&nbsp;		private DataSource getMigrationDataSource(DataSource flywayDataSource, DataSource dataSource,
&nbsp;				FlywayConnectionDetails connectionDetails) {
<b class="nc">&nbsp;			if (flywayDataSource != null) {</b>
<b class="nc">&nbsp;				return flywayDataSource;</b>
&nbsp;			}
<b class="nc">&nbsp;			String url = connectionDetails.getJdbcUrl();</b>
<b class="nc">&nbsp;			if (url != null) {</b>
<b class="nc">&nbsp;				DataSourceBuilder&lt;?&gt; builder = DataSourceBuilder.create().type(SimpleDriverDataSource.class);</b>
<b class="nc">&nbsp;				builder.url(url);</b>
<b class="nc">&nbsp;				applyConnectionDetails(connectionDetails, builder);</b>
<b class="nc">&nbsp;				return builder.build();</b>
&nbsp;			}
<b class="nc">&nbsp;			String user = connectionDetails.getUsername();</b>
<b class="nc">&nbsp;			if (user != null &amp;&amp; dataSource != null) {</b>
<b class="nc">&nbsp;				DataSourceBuilder&lt;?&gt; builder = DataSourceBuilder.derivedFrom(dataSource)</b>
<b class="nc">&nbsp;					.type(SimpleDriverDataSource.class);</b>
<b class="nc">&nbsp;				applyConnectionDetails(connectionDetails, builder);</b>
<b class="nc">&nbsp;				return builder.build();</b>
&nbsp;			}
<b class="nc">&nbsp;			Assert.state(dataSource != null, &quot;Flyway migration DataSource missing&quot;);</b>
<b class="nc">&nbsp;			return dataSource;</b>
&nbsp;		}
&nbsp;
&nbsp;		private void applyConnectionDetails(FlywayConnectionDetails connectionDetails, DataSourceBuilder&lt;?&gt; builder) {
<b class="nc">&nbsp;			builder.username(connectionDetails.getUsername());</b>
<b class="nc">&nbsp;			builder.password(connectionDetails.getPassword());</b>
<b class="nc">&nbsp;			String driverClassName = connectionDetails.getDriverClassName();</b>
<b class="nc">&nbsp;			if (StringUtils.hasText(driverClassName)) {</b>
<b class="nc">&nbsp;				builder.driverClassName(driverClassName);</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		/**
&nbsp;		 * Configure the given {@code configuration} using the given {@code properties}.
&nbsp;		 * &lt;p&gt;
&nbsp;		 * To maximize forwards- and backwards-compatibility method references are not
&nbsp;		 * used.
&nbsp;		 * @param configuration the configuration
&nbsp;		 * @param properties the properties
&nbsp;		 */
&nbsp;		private void configureProperties(FluentConfiguration configuration, FlywayProperties properties) {
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			String[] locations = new LocationResolver(configuration.getDataSource())</b>
<b class="nc">&nbsp;				.resolveLocations(properties.getLocations())</b>
<b class="nc">&nbsp;				.toArray(new String[0]);</b>
<b class="nc">&nbsp;			configuration.locations(locations);</b>
<b class="nc">&nbsp;			map.from(properties.isFailOnMissingLocations())</b>
<b class="nc">&nbsp;				.to((failOnMissingLocations) -&gt; configuration.failOnMissingLocations(failOnMissingLocations));</b>
<b class="nc">&nbsp;			map.from(properties.getEncoding()).to((encoding) -&gt; configuration.encoding(encoding));</b>
<b class="nc">&nbsp;			map.from(properties.getConnectRetries())</b>
<b class="nc">&nbsp;				.to((connectRetries) -&gt; configuration.connectRetries(connectRetries));</b>
<b class="nc">&nbsp;			map.from(properties.getConnectRetriesInterval())</b>
<b class="nc">&nbsp;				.as(Duration::getSeconds)</b>
<b class="nc">&nbsp;				.as(Long::intValue)</b>
<b class="nc">&nbsp;				.to((connectRetriesInterval) -&gt; configuration.connectRetriesInterval(connectRetriesInterval));</b>
<b class="nc">&nbsp;			map.from(properties.getLockRetryCount())</b>
<b class="nc">&nbsp;				.to((lockRetryCount) -&gt; configuration.lockRetryCount(lockRetryCount));</b>
<b class="nc">&nbsp;			map.from(properties.getDefaultSchema()).to((schema) -&gt; configuration.defaultSchema(schema));</b>
<b class="nc">&nbsp;			map.from(properties.getSchemas())</b>
<b class="nc">&nbsp;				.as(StringUtils::toStringArray)</b>
<b class="nc">&nbsp;				.to((schemas) -&gt; configuration.schemas(schemas));</b>
<b class="nc">&nbsp;			map.from(properties.isCreateSchemas()).to((createSchemas) -&gt; configuration.createSchemas(createSchemas));</b>
<b class="nc">&nbsp;			map.from(properties.getTable()).to((table) -&gt; configuration.table(table));</b>
<b class="nc">&nbsp;			map.from(properties.getTablespace()).to((tablespace) -&gt; configuration.tablespace(tablespace));</b>
<b class="nc">&nbsp;			map.from(properties.getBaselineDescription())</b>
<b class="nc">&nbsp;				.to((baselineDescription) -&gt; configuration.baselineDescription(baselineDescription));</b>
<b class="nc">&nbsp;			map.from(properties.getBaselineVersion())</b>
<b class="nc">&nbsp;				.to((baselineVersion) -&gt; configuration.baselineVersion(baselineVersion));</b>
<b class="nc">&nbsp;			map.from(properties.getInstalledBy()).to((installedBy) -&gt; configuration.installedBy(installedBy));</b>
<b class="nc">&nbsp;			map.from(properties.getPlaceholders()).to((placeholders) -&gt; configuration.placeholders(placeholders));</b>
<b class="nc">&nbsp;			map.from(properties.getPlaceholderPrefix())</b>
<b class="nc">&nbsp;				.to((placeholderPrefix) -&gt; configuration.placeholderPrefix(placeholderPrefix));</b>
<b class="nc">&nbsp;			map.from(properties.getPlaceholderSuffix())</b>
<b class="nc">&nbsp;				.to((placeholderSuffix) -&gt; configuration.placeholderSuffix(placeholderSuffix));</b>
<b class="nc">&nbsp;			map.from(properties.getPlaceholderSeparator())</b>
<b class="nc">&nbsp;				.to((placeHolderSeparator) -&gt; configuration.placeholderSeparator(placeHolderSeparator));</b>
<b class="nc">&nbsp;			map.from(properties.isPlaceholderReplacement())</b>
<b class="nc">&nbsp;				.to((placeholderReplacement) -&gt; configuration.placeholderReplacement(placeholderReplacement));</b>
<b class="nc">&nbsp;			map.from(properties.getSqlMigrationPrefix())</b>
<b class="nc">&nbsp;				.to((sqlMigrationPrefix) -&gt; configuration.sqlMigrationPrefix(sqlMigrationPrefix));</b>
<b class="nc">&nbsp;			map.from(properties.getSqlMigrationSuffixes())</b>
<b class="nc">&nbsp;				.as(StringUtils::toStringArray)</b>
<b class="nc">&nbsp;				.to((sqlMigrationSuffixes) -&gt; configuration.sqlMigrationSuffixes(sqlMigrationSuffixes));</b>
<b class="nc">&nbsp;			map.from(properties.getSqlMigrationSeparator())</b>
<b class="nc">&nbsp;				.to((sqlMigrationSeparator) -&gt; configuration.sqlMigrationSeparator(sqlMigrationSeparator));</b>
<b class="nc">&nbsp;			map.from(properties.getRepeatableSqlMigrationPrefix())</b>
<b class="nc">&nbsp;				.to((repeatableSqlMigrationPrefix) -&gt; configuration</b>
<b class="nc">&nbsp;					.repeatableSqlMigrationPrefix(repeatableSqlMigrationPrefix));</b>
<b class="nc">&nbsp;			map.from(properties.getTarget()).to((target) -&gt; configuration.target(target));</b>
<b class="nc">&nbsp;			map.from(properties.isBaselineOnMigrate())</b>
<b class="nc">&nbsp;				.to((baselineOnMigrate) -&gt; configuration.baselineOnMigrate(baselineOnMigrate));</b>
<b class="nc">&nbsp;			map.from(properties.isCleanDisabled()).to((cleanDisabled) -&gt; configuration.cleanDisabled(cleanDisabled));</b>
<b class="nc">&nbsp;			map.from(properties.isCleanOnValidationError())</b>
<b class="nc">&nbsp;				.to((cleanOnValidationError) -&gt; configuration.cleanOnValidationError(cleanOnValidationError));</b>
<b class="nc">&nbsp;			map.from(properties.isGroup()).to((group) -&gt; configuration.group(group));</b>
<b class="nc">&nbsp;			map.from(properties.isMixed()).to((mixed) -&gt; configuration.mixed(mixed));</b>
<b class="nc">&nbsp;			map.from(properties.isOutOfOrder()).to((outOfOrder) -&gt; configuration.outOfOrder(outOfOrder));</b>
<b class="nc">&nbsp;			map.from(properties.isSkipDefaultCallbacks())</b>
<b class="nc">&nbsp;				.to((skipDefaultCallbacks) -&gt; configuration.skipDefaultCallbacks(skipDefaultCallbacks));</b>
<b class="nc">&nbsp;			map.from(properties.isSkipDefaultResolvers())</b>
<b class="nc">&nbsp;				.to((skipDefaultResolvers) -&gt; configuration.skipDefaultResolvers(skipDefaultResolvers));</b>
<b class="nc">&nbsp;			map.from(properties.isValidateMigrationNaming())</b>
<b class="nc">&nbsp;				.to((validateMigrationNaming) -&gt; configuration.validateMigrationNaming(validateMigrationNaming));</b>
<b class="nc">&nbsp;			map.from(properties.isValidateOnMigrate())</b>
<b class="nc">&nbsp;				.to((validateOnMigrate) -&gt; configuration.validateOnMigrate(validateOnMigrate));</b>
<b class="nc">&nbsp;			map.from(properties.getInitSqls())</b>
<b class="nc">&nbsp;				.whenNot(CollectionUtils::isEmpty)</b>
<b class="nc">&nbsp;				.as((initSqls) -&gt; StringUtils.collectionToDelimitedString(initSqls, &quot;\n&quot;))</b>
<b class="nc">&nbsp;				.to((initSql) -&gt; configuration.initSql(initSql));</b>
<b class="nc">&nbsp;			map.from(properties.getScriptPlaceholderPrefix())</b>
<b class="nc">&nbsp;				.to((prefix) -&gt; configuration.scriptPlaceholderPrefix(prefix));</b>
<b class="nc">&nbsp;			map.from(properties.getScriptPlaceholderSuffix())</b>
<b class="nc">&nbsp;				.to((suffix) -&gt; configuration.scriptPlaceholderSuffix(suffix));</b>
<b class="nc">&nbsp;			configureExecuteInTransaction(configuration, properties, map);</b>
<b class="nc">&nbsp;			map.from(properties::getLoggers).to((loggers) -&gt; configuration.loggers(loggers));</b>
&nbsp;			// Flyway Teams properties
<b class="nc">&nbsp;			map.from(properties.getBatch()).to((batch) -&gt; configuration.batch(batch));</b>
<b class="nc">&nbsp;			map.from(properties.getDryRunOutput()).to((dryRunOutput) -&gt; configuration.dryRunOutput(dryRunOutput));</b>
<b class="nc">&nbsp;			map.from(properties.getErrorOverrides())</b>
<b class="nc">&nbsp;				.to((errorOverrides) -&gt; configuration.errorOverrides(errorOverrides));</b>
<b class="nc">&nbsp;			map.from(properties.getLicenseKey()).to((licenseKey) -&gt; configuration.licenseKey(licenseKey));</b>
<b class="nc">&nbsp;			map.from(properties.getStream()).to((stream) -&gt; configuration.stream(stream));</b>
<b class="nc">&nbsp;			map.from(properties.getUndoSqlMigrationPrefix())</b>
<b class="nc">&nbsp;				.to((undoSqlMigrationPrefix) -&gt; configuration.undoSqlMigrationPrefix(undoSqlMigrationPrefix));</b>
<b class="nc">&nbsp;			map.from(properties.getCherryPick()).to((cherryPick) -&gt; configuration.cherryPick(cherryPick));</b>
<b class="nc">&nbsp;			map.from(properties.getJdbcProperties())</b>
<b class="nc">&nbsp;				.whenNot(Map::isEmpty)</b>
<b class="nc">&nbsp;				.to((jdbcProperties) -&gt; configuration.jdbcProperties(jdbcProperties));</b>
<b class="nc">&nbsp;			map.from(properties.getKerberosConfigFile())</b>
<b class="nc">&nbsp;				.to((configFile) -&gt; configuration.kerberosConfigFile(configFile));</b>
<b class="nc">&nbsp;			map.from(properties.getOutputQueryResults())</b>
<b class="nc">&nbsp;				.to((outputQueryResults) -&gt; configuration.outputQueryResults(outputQueryResults));</b>
<b class="nc">&nbsp;			map.from(properties.getSkipExecutingMigrations())</b>
<b class="nc">&nbsp;				.to((skipExecutingMigrations) -&gt; configuration.skipExecutingMigrations(skipExecutingMigrations));</b>
<b class="nc">&nbsp;			map.from(properties.getIgnoreMigrationPatterns())</b>
<b class="nc">&nbsp;				.whenNot(List::isEmpty)</b>
<b class="nc">&nbsp;				.to((ignoreMigrationPatterns) -&gt; configuration</b>
<b class="nc">&nbsp;					.ignoreMigrationPatterns(ignoreMigrationPatterns.toArray(new String[0])));</b>
<b class="nc">&nbsp;			map.from(properties.getDetectEncoding())</b>
<b class="nc">&nbsp;				.to((detectEncoding) -&gt; configuration.detectEncoding(detectEncoding));</b>
&nbsp;		}
&nbsp;
&nbsp;		private void configureExecuteInTransaction(FluentConfiguration configuration, FlywayProperties properties,
&nbsp;				PropertyMapper map) {
&nbsp;			try {
<b class="nc">&nbsp;				map.from(properties.isExecuteInTransaction()).to(configuration::executeInTransaction);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (NoSuchMethodError ex) {</b>
&nbsp;				// Flyway &lt; 9.14
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private void configureCallbacks(FluentConfiguration configuration, List&lt;Callback&gt; callbacks) {
<b class="nc">&nbsp;			if (!callbacks.isEmpty()) {</b>
<b class="nc">&nbsp;				configuration.callbacks(callbacks.toArray(new Callback[0]));</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		private void configureJavaMigrations(FluentConfiguration flyway, List&lt;JavaMigration&gt; migrations) {
<b class="nc">&nbsp;			if (!migrations.isEmpty()) {</b>
<b class="nc">&nbsp;				flyway.javaMigrations(migrations.toArray(new JavaMigration[0]));</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnMissingBean
&nbsp;		public FlywayMigrationInitializer flywayInitializer(Flyway flyway,
&nbsp;				ObjectProvider&lt;FlywayMigrationStrategy&gt; migrationStrategy) {
<b class="nc">&nbsp;			return new FlywayMigrationInitializer(flyway, migrationStrategy.getIfAvailable());</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private static class LocationResolver {
&nbsp;
&nbsp;		private static final String VENDOR_PLACEHOLDER = &quot;{vendor}&quot;;
&nbsp;
&nbsp;		private final DataSource dataSource;
&nbsp;
<b class="nc">&nbsp;		LocationResolver(DataSource dataSource) {</b>
<b class="nc">&nbsp;			this.dataSource = dataSource;</b>
&nbsp;		}
&nbsp;
&nbsp;		List&lt;String&gt; resolveLocations(List&lt;String&gt; locations) {
<b class="nc">&nbsp;			if (usesVendorLocation(locations)) {</b>
<b class="nc">&nbsp;				DatabaseDriver databaseDriver = getDatabaseDriver();</b>
<b class="nc">&nbsp;				return replaceVendorLocations(locations, databaseDriver);</b>
&nbsp;			}
<b class="nc">&nbsp;			return locations;</b>
&nbsp;		}
&nbsp;
&nbsp;		private List&lt;String&gt; replaceVendorLocations(List&lt;String&gt; locations, DatabaseDriver databaseDriver) {
<b class="nc">&nbsp;			if (databaseDriver == DatabaseDriver.UNKNOWN) {</b>
<b class="nc">&nbsp;				return locations;</b>
&nbsp;			}
<b class="nc">&nbsp;			String vendor = databaseDriver.getId();</b>
<b class="nc">&nbsp;			return locations.stream().map((location) -&gt; location.replace(VENDOR_PLACEHOLDER, vendor)).toList();</b>
&nbsp;		}
&nbsp;
&nbsp;		private DatabaseDriver getDatabaseDriver() {
&nbsp;			try {
<b class="nc">&nbsp;				String url = JdbcUtils.extractDatabaseMetaData(this.dataSource, DatabaseMetaData::getURL);</b>
<b class="nc">&nbsp;				return DatabaseDriver.fromJdbcUrl(url);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (MetaDataAccessException ex) {</b>
<b class="nc">&nbsp;				throw new IllegalStateException(ex);</b>
&nbsp;			}
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		private boolean usesVendorLocation(Collection&lt;String&gt; locations) {
<b class="nc">&nbsp;			for (String location : locations) {</b>
<b class="nc">&nbsp;				if (location.contains(VENDOR_PLACEHOLDER)) {</b>
<b class="nc">&nbsp;					return true;</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Convert a String or Number to a {@link MigrationVersion}.
&nbsp;	 */
<b class="nc">&nbsp;	static class StringOrNumberToMigrationVersionConverter implements GenericConverter {</b>
&nbsp;
&nbsp;		private static final Set&lt;ConvertiblePair&gt; CONVERTIBLE_TYPES;
&nbsp;
&nbsp;		static {
<b class="nc">&nbsp;			Set&lt;ConvertiblePair&gt; types = new HashSet&lt;&gt;(2);</b>
<b class="nc">&nbsp;			types.add(new ConvertiblePair(String.class, MigrationVersion.class));</b>
<b class="nc">&nbsp;			types.add(new ConvertiblePair(Number.class, MigrationVersion.class));</b>
<b class="nc">&nbsp;			CONVERTIBLE_TYPES = Collections.unmodifiableSet(types);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Set&lt;ConvertiblePair&gt; getConvertibleTypes() {
<b class="nc">&nbsp;			return CONVERTIBLE_TYPES;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Object convert(Object source, TypeDescriptor sourceType, TypeDescriptor targetType) {
<b class="nc">&nbsp;			String value = ObjectUtils.nullSafeToString(source);</b>
<b class="nc">&nbsp;			return MigrationVersion.fromVersion(value);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	static final class FlywayDataSourceCondition extends AnyNestedCondition {
&nbsp;
&nbsp;		FlywayDataSourceCondition() {
<b class="nc">&nbsp;			super(ConfigurationPhase.REGISTER_BEAN);</b>
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnBean(DataSource.class)
&nbsp;		private static final class DataSourceBeanCondition {
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnBean(JdbcConnectionDetails.class)
&nbsp;		private static final class JdbcConnectionDetailsCondition {
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnProperty(prefix = &quot;spring.flyway&quot;, name = &quot;url&quot;)
&nbsp;		private static final class FlywayUrlCondition {
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	static class FlywayAutoConfigurationRuntimeHints implements RuntimeHintsRegistrar {</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public void registerHints(RuntimeHints hints, ClassLoader classLoader) {
<b class="nc">&nbsp;			hints.resources().registerPattern(&quot;db/migration/*&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Adapts {@link FlywayProperties} to {@link FlywayConnectionDetails}.
&nbsp;	 */
&nbsp;	static final class PropertiesFlywayConnectionDetails implements FlywayConnectionDetails {
&nbsp;
&nbsp;		private final FlywayProperties properties;
&nbsp;
<b class="nc">&nbsp;		PropertiesFlywayConnectionDetails(FlywayProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getUsername() {
<b class="nc">&nbsp;			return this.properties.getUser();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getPassword() {
<b class="nc">&nbsp;			return this.properties.getPassword();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getJdbcUrl() {
<b class="nc">&nbsp;			return this.properties.getUrl();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getDriverClassName() {
<b class="nc">&nbsp;			return this.properties.getDriverClassName();</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Order(Ordered.HIGHEST_PRECEDENCE)
&nbsp;	static final class OracleFlywayConfigurationCustomizer implements FlywayConfigurationCustomizer {
&nbsp;
&nbsp;		private final FlywayProperties properties;
&nbsp;
<b class="nc">&nbsp;		OracleFlywayConfigurationCustomizer(FlywayProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void customize(FluentConfiguration configuration) {
<b class="nc">&nbsp;			Extension&lt;OracleConfigurationExtension&gt; extension = new Extension&lt;&gt;(configuration,</b>
&nbsp;					OracleConfigurationExtension.class, &quot;Oracle&quot;);
<b class="nc">&nbsp;			Oracle properties = this.properties.getOracle();</b>
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			map.from(properties::getSqlplus).to(extension.via((ext, sqlplus) -&gt; ext.setSqlplus(sqlplus)));</b>
<b class="nc">&nbsp;			map.from(properties::getSqlplusWarn)</b>
<b class="nc">&nbsp;				.to(extension.via((ext, sqlplusWarn) -&gt; ext.setSqlplusWarn(sqlplusWarn)));</b>
<b class="nc">&nbsp;			map.from(properties::getWalletLocation)</b>
<b class="nc">&nbsp;				.to(extension.via((ext, walletLocation) -&gt; ext.setWalletLocation(walletLocation)));</b>
<b class="nc">&nbsp;			map.from(properties::getKerberosCacheFile)</b>
<b class="nc">&nbsp;				.to(extension.via((ext, kerberosCacheFile) -&gt; ext.setKerberosCacheFile(kerberosCacheFile)));</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Order(Ordered.HIGHEST_PRECEDENCE)
&nbsp;	static final class PostgresqlFlywayConfigurationCustomizer implements FlywayConfigurationCustomizer {
&nbsp;
&nbsp;		private final FlywayProperties properties;
&nbsp;
<b class="nc">&nbsp;		PostgresqlFlywayConfigurationCustomizer(FlywayProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void customize(FluentConfiguration configuration) {
<b class="nc">&nbsp;			Extension&lt;PostgreSQLConfigurationExtension&gt; extension = new Extension&lt;&gt;(configuration,</b>
&nbsp;					PostgreSQLConfigurationExtension.class, &quot;PostgreSQL&quot;);
<b class="nc">&nbsp;			Postgresql properties = this.properties.getPostgresql();</b>
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			map.from(properties::getTransactionalLock)</b>
<b class="nc">&nbsp;				.to(extension.via((ext, transactionalLock) -&gt; ext.setTransactionalLock(transactionalLock)));</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Order(Ordered.HIGHEST_PRECEDENCE)
&nbsp;	static final class SqlServerFlywayConfigurationCustomizer implements FlywayConfigurationCustomizer {
&nbsp;
&nbsp;		private final FlywayProperties properties;
&nbsp;
<b class="nc">&nbsp;		SqlServerFlywayConfigurationCustomizer(FlywayProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void customize(FluentConfiguration configuration) {
<b class="nc">&nbsp;			Extension&lt;SQLServerConfigurationExtension&gt; extension = new Extension&lt;&gt;(configuration,</b>
&nbsp;					SQLServerConfigurationExtension.class, &quot;SQL Server&quot;);
<b class="nc">&nbsp;			Sqlserver properties = this.properties.getSqlserver();</b>
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			map.from(properties::getKerberosLoginFile).to(extension.via(this::setKerberosLoginFile));</b>
&nbsp;		}
&nbsp;
&nbsp;		private void setKerberosLoginFile(SQLServerConfigurationExtension configuration, String file) {
<b class="nc">&nbsp;			configuration.getKerberos().getLogin().setFile(file);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Helper class used to map properties to a {@link ConfigurationExtension}.
&nbsp;	 *
&nbsp;	 * @param &lt;E&gt; the extension type
&nbsp;	 */
&nbsp;	static class Extension&lt;E extends ConfigurationExtension&gt; {
&nbsp;
&nbsp;		private SingletonSupplier&lt;E&gt; extension;
&nbsp;
<b class="nc">&nbsp;		Extension(FluentConfiguration configuration, Class&lt;E&gt; type, String name) {</b>
<b class="nc">&nbsp;			this.extension = SingletonSupplier.of(() -&gt; {</b>
<b class="nc">&nbsp;				E extension = configuration.getPluginRegister().getPlugin(type);</b>
<b class="nc">&nbsp;				Assert.notNull(extension, () -&gt; &quot;Flyway %s extension missing&quot;.formatted(name));</b>
<b class="nc">&nbsp;				return extension;</b>
&nbsp;			});
&nbsp;		}
&nbsp;
&nbsp;		&lt;T&gt; Consumer&lt;T&gt; via(BiConsumer&lt;E, T&gt; action) {
<b class="nc">&nbsp;			return (value) -&gt; action.accept(this.extension.get(), value);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
