


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > HealthEndpointConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.actuate.autoconfigure.health</a>
</div>

<h1>Coverage Summary for Class: HealthEndpointConfiguration (org.springframework.boot.actuate.autoconfigure.health)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">HealthEndpointConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
</tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$AdaptedReactiveHealthContributors</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$AdaptedReactiveHealthContributors$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$AdaptedReactiveHealthContributors$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$AdaptedReactiveHealthContributors$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$HealthEndpointGroupMembershipValidator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$HealthEndpointGroupMembershipValidator$NoSuchHealthContributorException</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">HealthEndpointConfiguration$HealthEndpointGroupsBeanPostProcessor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/32)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/65)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.actuate.autoconfigure.health;
&nbsp;
&nbsp;import java.util.Collections;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import org.springframework.beans.BeansException;
&nbsp;import org.springframework.beans.factory.ObjectProvider;
&nbsp;import org.springframework.beans.factory.SmartInitializingSingleton;
&nbsp;import org.springframework.beans.factory.config.BeanPostProcessor;
&nbsp;import org.springframework.boot.actuate.health.CompositeHealthContributor;
&nbsp;import org.springframework.boot.actuate.health.CompositeReactiveHealthContributor;
&nbsp;import org.springframework.boot.actuate.health.Health;
&nbsp;import org.springframework.boot.actuate.health.HealthContributor;
&nbsp;import org.springframework.boot.actuate.health.HealthContributorRegistry;
&nbsp;import org.springframework.boot.actuate.health.HealthEndpoint;
&nbsp;import org.springframework.boot.actuate.health.HealthEndpointGroups;
&nbsp;import org.springframework.boot.actuate.health.HealthEndpointGroupsPostProcessor;
&nbsp;import org.springframework.boot.actuate.health.HealthIndicator;
&nbsp;import org.springframework.boot.actuate.health.HttpCodeStatusMapper;
&nbsp;import org.springframework.boot.actuate.health.NamedContributor;
&nbsp;import org.springframework.boot.actuate.health.NamedContributors;
&nbsp;import org.springframework.boot.actuate.health.ReactiveHealthContributor;
&nbsp;import org.springframework.boot.actuate.health.ReactiveHealthIndicator;
&nbsp;import org.springframework.boot.actuate.health.SimpleHttpCodeStatusMapper;
&nbsp;import org.springframework.boot.actuate.health.SimpleStatusAggregator;
&nbsp;import org.springframework.boot.actuate.health.StatusAggregator;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.context.ApplicationContext;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;
&nbsp;/**
&nbsp; * Configuration for {@link HealthEndpoint} infrastructure beans.
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @see HealthEndpointAutoConfiguration
&nbsp; */
&nbsp;@Configuration(proxyBeanMethods = false)
<b class="nc">&nbsp;class HealthEndpointConfiguration {</b>
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	StatusAggregator healthStatusAggregator(HealthEndpointProperties properties) {
<b class="nc">&nbsp;		return new SimpleStatusAggregator(properties.getStatus().getOrder());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	HttpCodeStatusMapper healthHttpCodeStatusMapper(HealthEndpointProperties properties) {
<b class="nc">&nbsp;		return new SimpleHttpCodeStatusMapper(properties.getStatus().getHttpMapping());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	HealthEndpointGroups healthEndpointGroups(ApplicationContext applicationContext,
&nbsp;			HealthEndpointProperties properties) {
<b class="nc">&nbsp;		return new AutoConfiguredHealthEndpointGroups(applicationContext, properties);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	HealthContributorRegistry healthContributorRegistry(ApplicationContext applicationContext,
&nbsp;			HealthEndpointGroups groups, Map&lt;String, HealthContributor&gt; healthContributors,
&nbsp;			Map&lt;String, ReactiveHealthContributor&gt; reactiveHealthContributors) {
<b class="nc">&nbsp;		if (ClassUtils.isPresent(&quot;reactor.core.publisher.Flux&quot;, applicationContext.getClassLoader())) {</b>
<b class="nc">&nbsp;			healthContributors.putAll(new AdaptedReactiveHealthContributors(reactiveHealthContributors).get());</b>
&nbsp;		}
<b class="nc">&nbsp;		return new AutoConfiguredHealthContributorRegistry(healthContributors, groups.getNames());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnProperty(name = &quot;management.endpoint.health.validate-group-membership&quot;, havingValue = &quot;true&quot;,
&nbsp;			matchIfMissing = true)
&nbsp;	HealthEndpointGroupMembershipValidator healthEndpointGroupMembershipValidator(HealthEndpointProperties properties,
&nbsp;			HealthContributorRegistry healthContributorRegistry) {
<b class="nc">&nbsp;		return new HealthEndpointGroupMembershipValidator(properties, healthContributorRegistry);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	HealthEndpoint healthEndpoint(HealthContributorRegistry registry, HealthEndpointGroups groups,
&nbsp;			HealthEndpointProperties properties) {
<b class="nc">&nbsp;		return new HealthEndpoint(registry, groups, properties.getLogging().getSlowIndicatorThreshold());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	static HealthEndpointGroupsBeanPostProcessor healthEndpointGroupsBeanPostProcessor(
&nbsp;			ObjectProvider&lt;HealthEndpointGroupsPostProcessor&gt; healthEndpointGroupsPostProcessors) {
<b class="nc">&nbsp;		return new HealthEndpointGroupsBeanPostProcessor(healthEndpointGroupsPostProcessors);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link BeanPostProcessor} to invoke {@link HealthEndpointGroupsPostProcessor}
&nbsp;	 * beans.
&nbsp;	 */
&nbsp;	static class HealthEndpointGroupsBeanPostProcessor implements BeanPostProcessor {
&nbsp;
&nbsp;		private final ObjectProvider&lt;HealthEndpointGroupsPostProcessor&gt; postProcessors;
&nbsp;
<b class="nc">&nbsp;		HealthEndpointGroupsBeanPostProcessor(ObjectProvider&lt;HealthEndpointGroupsPostProcessor&gt; postProcessors) {</b>
<b class="nc">&nbsp;			this.postProcessors = postProcessors;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
<b class="nc">&nbsp;			if (bean instanceof HealthEndpointGroups groups) {</b>
<b class="nc">&nbsp;				return applyPostProcessors(groups);</b>
&nbsp;			}
<b class="nc">&nbsp;			return bean;</b>
&nbsp;		}
&nbsp;
&nbsp;		private Object applyPostProcessors(HealthEndpointGroups bean) {
<b class="nc">&nbsp;			for (HealthEndpointGroupsPostProcessor postProcessor : this.postProcessors.orderedStream()</b>
<b class="nc">&nbsp;				.toArray(HealthEndpointGroupsPostProcessor[]::new)) {</b>
<b class="nc">&nbsp;				bean = postProcessor.postProcessHealthEndpointGroups(bean);</b>
&nbsp;			}
<b class="nc">&nbsp;			return bean;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Adapter to expose {@link ReactiveHealthContributor} beans as
&nbsp;	 * {@link HealthContributor} instances.
&nbsp;	 */
&nbsp;	private static class AdaptedReactiveHealthContributors {
&nbsp;
&nbsp;		private final Map&lt;String, HealthContributor&gt; adapted;
&nbsp;
<b class="nc">&nbsp;		AdaptedReactiveHealthContributors(Map&lt;String, ReactiveHealthContributor&gt; reactiveContributors) {</b>
<b class="nc">&nbsp;			Map&lt;String, HealthContributor&gt; adapted = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;			reactiveContributors.forEach((name, contributor) -&gt; adapted.put(name, adapt(contributor)));</b>
<b class="nc">&nbsp;			this.adapted = Collections.unmodifiableMap(adapted);</b>
&nbsp;		}
&nbsp;
&nbsp;		private HealthContributor adapt(ReactiveHealthContributor contributor) {
<b class="nc">&nbsp;			if (contributor instanceof ReactiveHealthIndicator healthIndicator) {</b>
<b class="nc">&nbsp;				return adapt(healthIndicator);</b>
&nbsp;			}
<b class="nc">&nbsp;			if (contributor instanceof CompositeReactiveHealthContributor healthContributor) {</b>
<b class="nc">&nbsp;				return adapt(healthContributor);</b>
&nbsp;			}
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Unsupported ReactiveHealthContributor type &quot; + contributor.getClass());</b>
&nbsp;		}
&nbsp;
&nbsp;		private HealthIndicator adapt(ReactiveHealthIndicator indicator) {
<b class="nc">&nbsp;			return new HealthIndicator() {</b>
&nbsp;
&nbsp;				@Override
&nbsp;				public Health getHealth(boolean includeDetails) {
<b class="nc">&nbsp;					return indicator.getHealth(includeDetails).block();</b>
&nbsp;				}
&nbsp;
&nbsp;				@Override
&nbsp;				public Health health() {
<b class="nc">&nbsp;					return indicator.health().block();</b>
&nbsp;				}
&nbsp;
&nbsp;			};
&nbsp;		}
&nbsp;
&nbsp;		private CompositeHealthContributor adapt(CompositeReactiveHealthContributor composite) {
<b class="nc">&nbsp;			return new CompositeHealthContributor() {</b>
&nbsp;
&nbsp;				@Override
&nbsp;				public Iterator&lt;NamedContributor&lt;HealthContributor&gt;&gt; iterator() {
<b class="nc">&nbsp;					Iterator&lt;NamedContributor&lt;ReactiveHealthContributor&gt;&gt; iterator = composite.iterator();</b>
<b class="nc">&nbsp;					return new Iterator&lt;&gt;() {</b>
&nbsp;
&nbsp;						@Override
&nbsp;						public boolean hasNext() {
<b class="nc">&nbsp;							return iterator.hasNext();</b>
&nbsp;						}
&nbsp;
&nbsp;						@Override
&nbsp;						public NamedContributor&lt;HealthContributor&gt; next() {
<b class="nc">&nbsp;							NamedContributor&lt;ReactiveHealthContributor&gt; next = iterator.next();</b>
<b class="nc">&nbsp;							return NamedContributor.of(next.getName(), adapt(next.getContributor()));</b>
&nbsp;						}
&nbsp;
&nbsp;					};
&nbsp;				}
&nbsp;
&nbsp;				@Override
&nbsp;				public HealthContributor getContributor(String name) {
<b class="nc">&nbsp;					return adapt(composite.getContributor(name));</b>
&nbsp;				}
&nbsp;
&nbsp;			};
&nbsp;		}
&nbsp;
&nbsp;		Map&lt;String, HealthContributor&gt; get() {
<b class="nc">&nbsp;			return this.adapted;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link SmartInitializingSingleton} that validates health endpoint group membership,
&nbsp;	 * throwing a {@link NoSuchHealthContributorException} if an included or excluded
&nbsp;	 * contributor does not exist.
&nbsp;	 */
&nbsp;	static class HealthEndpointGroupMembershipValidator implements SmartInitializingSingleton {
&nbsp;
&nbsp;		private final HealthEndpointProperties properties;
&nbsp;
&nbsp;		private final HealthContributorRegistry registry;
&nbsp;
&nbsp;		HealthEndpointGroupMembershipValidator(HealthEndpointProperties properties,
<b class="nc">&nbsp;				HealthContributorRegistry registry) {</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
<b class="nc">&nbsp;			this.registry = registry;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void afterSingletonsInstantiated() {
<b class="nc">&nbsp;			validateGroups();</b>
&nbsp;		}
&nbsp;
&nbsp;		private void validateGroups() {
<b class="nc">&nbsp;			this.properties.getGroup().forEach((name, group) -&gt; {</b>
<b class="nc">&nbsp;				validate(group.getInclude(), &quot;Included&quot;, name);</b>
<b class="nc">&nbsp;				validate(group.getExclude(), &quot;Excluded&quot;, name);</b>
&nbsp;			});
&nbsp;		}
&nbsp;
&nbsp;		private void validate(Set&lt;String&gt; names, String type, String group) {
<b class="nc">&nbsp;			if (CollectionUtils.isEmpty(names)) {</b>
&nbsp;				return;
&nbsp;			}
<b class="nc">&nbsp;			for (String name : names) {</b>
<b class="nc">&nbsp;				if (&quot;*&quot;.equals(name)) {</b>
&nbsp;					return;
&nbsp;				}
<b class="nc">&nbsp;				String[] path = name.split(&quot;/&quot;);</b>
<b class="nc">&nbsp;				if (!contributorExists(path)) {</b>
<b class="nc">&nbsp;					throw new NoSuchHealthContributorException(type, name, group);</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean contributorExists(String[] path) {
<b class="nc">&nbsp;			int pathOffset = 0;</b>
<b class="nc">&nbsp;			Object contributor = this.registry;</b>
<b class="nc">&nbsp;			while (pathOffset &lt; path.length) {</b>
<b class="nc">&nbsp;				if (!(contributor instanceof NamedContributors)) {</b>
<b class="nc">&nbsp;					return false;</b>
&nbsp;				}
<b class="nc">&nbsp;				contributor = ((NamedContributors&lt;?&gt;) contributor).getContributor(path[pathOffset]);</b>
<b class="nc">&nbsp;				pathOffset++;</b>
&nbsp;			}
<b class="nc">&nbsp;			return (contributor != null);</b>
&nbsp;		}
&nbsp;
&nbsp;		/**
&nbsp;		 * Thrown when a contributor that does not exist is included in or excluded from a
&nbsp;		 * group.
&nbsp;		 */
&nbsp;		static class NoSuchHealthContributorException extends RuntimeException {
&nbsp;
&nbsp;			NoSuchHealthContributorException(String type, String name, String group) {
<b class="nc">&nbsp;				super(type + &quot; health contributor &#39;&quot; + name + &quot;&#39; in group &#39;&quot; + group + &quot;&#39; does not exist&quot;);</b>
&nbsp;			}
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
