


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > MetricsEndpoint</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.actuate.metrics</a>
</div>

<h1>Coverage Summary for Class: MetricsEndpoint (org.springframework.boot.actuate.metrics)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MetricsEndpoint</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
</tr>
  <tr>
    <td class="name">MetricsEndpoint$AvailableTag</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MetricsEndpoint$MetricDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MetricsEndpoint$MetricNamesDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">MetricsEndpoint$Sample</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/33)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/76)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.actuate.metrics;
&nbsp;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Set;
&nbsp;import java.util.TreeSet;
&nbsp;import java.util.function.BiFunction;
&nbsp;
&nbsp;import io.micrometer.core.instrument.Meter;
&nbsp;import io.micrometer.core.instrument.MeterRegistry;
&nbsp;import io.micrometer.core.instrument.Statistic;
&nbsp;import io.micrometer.core.instrument.Tag;
&nbsp;import io.micrometer.core.instrument.composite.CompositeMeterRegistry;
&nbsp;
&nbsp;import org.springframework.boot.actuate.endpoint.InvalidEndpointRequestException;
&nbsp;import org.springframework.boot.actuate.endpoint.OperationResponseBody;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.Endpoint;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.ReadOperation;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.Selector;
&nbsp;import org.springframework.lang.Nullable;
&nbsp;
&nbsp;/**
&nbsp; * An {@link Endpoint @Endpoint} for exposing the metrics held by a {@link MeterRegistry}.
&nbsp; *
&nbsp; * @author Jon Schneider
&nbsp; * @author Phillip Webb
&nbsp; * @since 2.0.0
&nbsp; */
&nbsp;@Endpoint(id = &quot;metrics&quot;)
&nbsp;public class MetricsEndpoint {
&nbsp;
&nbsp;	private final MeterRegistry registry;
&nbsp;
<b class="nc">&nbsp;	public MetricsEndpoint(MeterRegistry registry) {</b>
<b class="nc">&nbsp;		this.registry = registry;</b>
&nbsp;	}
&nbsp;
&nbsp;	@ReadOperation
&nbsp;	public MetricNamesDescriptor listNames() {
<b class="nc">&nbsp;		Set&lt;String&gt; names = new TreeSet&lt;&gt;();</b>
<b class="nc">&nbsp;		collectNames(names, this.registry);</b>
<b class="nc">&nbsp;		return new MetricNamesDescriptor(names);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void collectNames(Set&lt;String&gt; names, MeterRegistry registry) {
<b class="nc">&nbsp;		if (registry instanceof CompositeMeterRegistry compositeMeterRegistry) {</b>
<b class="nc">&nbsp;			compositeMeterRegistry.getRegistries().forEach((member) -&gt; collectNames(names, member));</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			registry.getMeters().stream().map(this::getName).forEach(names::add);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private String getName(Meter meter) {
<b class="nc">&nbsp;		return meter.getId().getName();</b>
&nbsp;	}
&nbsp;
&nbsp;	@ReadOperation
&nbsp;	public MetricDescriptor metric(@Selector String requiredMetricName, @Nullable List&lt;String&gt; tag) {
<b class="nc">&nbsp;		List&lt;Tag&gt; tags = parseTags(tag);</b>
<b class="nc">&nbsp;		Collection&lt;Meter&gt; meters = findFirstMatchingMeters(this.registry, requiredMetricName, tags);</b>
<b class="nc">&nbsp;		if (meters.isEmpty()) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		Map&lt;Statistic, Double&gt; samples = getSamples(meters);</b>
<b class="nc">&nbsp;		Map&lt;String, Set&lt;String&gt;&gt; availableTags = getAvailableTags(meters);</b>
<b class="nc">&nbsp;		tags.forEach((t) -&gt; availableTags.remove(t.getKey()));</b>
<b class="nc">&nbsp;		Meter.Id meterId = meters.iterator().next().getId();</b>
<b class="nc">&nbsp;		return new MetricDescriptor(requiredMetricName, meterId.getDescription(), meterId.getBaseUnit(),</b>
<b class="nc">&nbsp;				asList(samples, Sample::new), asList(availableTags, AvailableTag::new));</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;Tag&gt; parseTags(List&lt;String&gt; tags) {
<b class="nc">&nbsp;		return (tags != null) ? tags.stream().map(this::parseTag).toList() : Collections.emptyList();</b>
&nbsp;	}
&nbsp;
&nbsp;	private Tag parseTag(String tag) {
<b class="nc">&nbsp;		String[] parts = tag.split(&quot;:&quot;, 2);</b>
<b class="nc">&nbsp;		if (parts.length != 2) {</b>
<b class="nc">&nbsp;			throw new InvalidEndpointRequestException(</b>
&nbsp;					&quot;Each tag parameter must be in the form &#39;key:value&#39; but was: &quot; + tag,
&nbsp;					&quot;Each tag parameter must be in the form &#39;key:value&#39;&quot;);
&nbsp;		}
<b class="nc">&nbsp;		return Tag.of(parts[0], parts[1]);</b>
&nbsp;	}
&nbsp;
&nbsp;	private Collection&lt;Meter&gt; findFirstMatchingMeters(MeterRegistry registry, String name, Iterable&lt;Tag&gt; tags) {
<b class="nc">&nbsp;		if (registry instanceof CompositeMeterRegistry compositeMeterRegistry) {</b>
<b class="nc">&nbsp;			return findFirstMatchingMeters(compositeMeterRegistry, name, tags);</b>
&nbsp;		}
<b class="nc">&nbsp;		return registry.find(name).tags(tags).meters();</b>
&nbsp;	}
&nbsp;
&nbsp;	private Collection&lt;Meter&gt; findFirstMatchingMeters(CompositeMeterRegistry composite, String name,
&nbsp;			Iterable&lt;Tag&gt; tags) {
<b class="nc">&nbsp;		return composite.getRegistries()</b>
<b class="nc">&nbsp;			.stream()</b>
<b class="nc">&nbsp;			.map((registry) -&gt; findFirstMatchingMeters(registry, name, tags))</b>
<b class="nc">&nbsp;			.filter((matching) -&gt; !matching.isEmpty())</b>
<b class="nc">&nbsp;			.findFirst()</b>
<b class="nc">&nbsp;			.orElse(Collections.emptyList());</b>
&nbsp;	}
&nbsp;
&nbsp;	private Map&lt;Statistic, Double&gt; getSamples(Collection&lt;Meter&gt; meters) {
<b class="nc">&nbsp;		Map&lt;Statistic, Double&gt; samples = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;		meters.forEach((meter) -&gt; mergeMeasurements(samples, meter));</b>
<b class="nc">&nbsp;		return samples;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void mergeMeasurements(Map&lt;Statistic, Double&gt; samples, Meter meter) {
<b class="nc">&nbsp;		meter.measure()</b>
<b class="nc">&nbsp;			.forEach((measurement) -&gt; samples.merge(measurement.getStatistic(), measurement.getValue(),</b>
<b class="nc">&nbsp;					mergeFunction(measurement.getStatistic())));</b>
&nbsp;	}
&nbsp;
&nbsp;	private BiFunction&lt;Double, Double, Double&gt; mergeFunction(Statistic statistic) {
<b class="nc">&nbsp;		return Statistic.MAX.equals(statistic) ? Double::max : Double::sum;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Map&lt;String, Set&lt;String&gt;&gt; getAvailableTags(Collection&lt;Meter&gt; meters) {
<b class="nc">&nbsp;		Map&lt;String, Set&lt;String&gt;&gt; availableTags = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;		meters.forEach((meter) -&gt; mergeAvailableTags(availableTags, meter));</b>
<b class="nc">&nbsp;		return availableTags;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void mergeAvailableTags(Map&lt;String, Set&lt;String&gt;&gt; availableTags, Meter meter) {
<b class="nc">&nbsp;		meter.getId().getTags().forEach((tag) -&gt; {</b>
<b class="nc">&nbsp;			Set&lt;String&gt; value = Collections.singleton(tag.getValue());</b>
<b class="nc">&nbsp;			availableTags.merge(tag.getKey(), value, this::merge);</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	private &lt;T&gt; Set&lt;T&gt; merge(Set&lt;T&gt; set1, Set&lt;T&gt; set2) {
<b class="nc">&nbsp;		Set&lt;T&gt; result = new HashSet&lt;&gt;(set1.size() + set2.size());</b>
<b class="nc">&nbsp;		result.addAll(set1);</b>
<b class="nc">&nbsp;		result.addAll(set2);</b>
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	private &lt;K, V, T&gt; List&lt;T&gt; asList(Map&lt;K, V&gt; map, BiFunction&lt;K, V, T&gt; mapper) {
<b class="nc">&nbsp;		return map.entrySet().stream().map((entry) -&gt; mapper.apply(entry.getKey(), entry.getValue())).toList();</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Description of metric names.
&nbsp;	 */
&nbsp;	public static final class MetricNamesDescriptor implements OperationResponseBody {
&nbsp;
&nbsp;		private final Set&lt;String&gt; names;
&nbsp;
<b class="nc">&nbsp;		MetricNamesDescriptor(Set&lt;String&gt; names) {</b>
<b class="nc">&nbsp;			this.names = names;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Set&lt;String&gt; getNames() {
<b class="nc">&nbsp;			return this.names;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Description of a metric.
&nbsp;	 */
&nbsp;	public static final class MetricDescriptor implements OperationResponseBody {
&nbsp;
&nbsp;		private final String name;
&nbsp;
&nbsp;		private final String description;
&nbsp;
&nbsp;		private final String baseUnit;
&nbsp;
&nbsp;		private final List&lt;Sample&gt; measurements;
&nbsp;
&nbsp;		private final List&lt;AvailableTag&gt; availableTags;
&nbsp;
&nbsp;		MetricDescriptor(String name, String description, String baseUnit, List&lt;Sample&gt; measurements,
<b class="nc">&nbsp;				List&lt;AvailableTag&gt; availableTags) {</b>
<b class="nc">&nbsp;			this.name = name;</b>
<b class="nc">&nbsp;			this.description = description;</b>
<b class="nc">&nbsp;			this.baseUnit = baseUnit;</b>
<b class="nc">&nbsp;			this.measurements = measurements;</b>
<b class="nc">&nbsp;			this.availableTags = availableTags;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getName() {
<b class="nc">&nbsp;			return this.name;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getDescription() {
<b class="nc">&nbsp;			return this.description;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getBaseUnit() {
<b class="nc">&nbsp;			return this.baseUnit;</b>
&nbsp;		}
&nbsp;
&nbsp;		public List&lt;Sample&gt; getMeasurements() {
<b class="nc">&nbsp;			return this.measurements;</b>
&nbsp;		}
&nbsp;
&nbsp;		public List&lt;AvailableTag&gt; getAvailableTags() {
<b class="nc">&nbsp;			return this.availableTags;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * A set of tags for further dimensional drill-down and their potential values.
&nbsp;	 */
&nbsp;	public static final class AvailableTag {
&nbsp;
&nbsp;		private final String tag;
&nbsp;
&nbsp;		private final Set&lt;String&gt; values;
&nbsp;
<b class="nc">&nbsp;		AvailableTag(String tag, Set&lt;String&gt; values) {</b>
<b class="nc">&nbsp;			this.tag = tag;</b>
<b class="nc">&nbsp;			this.values = values;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getTag() {
<b class="nc">&nbsp;			return this.tag;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Set&lt;String&gt; getValues() {
<b class="nc">&nbsp;			return this.values;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * A measurement sample combining a {@link Statistic statistic} and a value.
&nbsp;	 */
&nbsp;	public static final class Sample {
&nbsp;
&nbsp;		private final Statistic statistic;
&nbsp;
&nbsp;		private final Double value;
&nbsp;
<b class="nc">&nbsp;		Sample(Statistic statistic, Double value) {</b>
<b class="nc">&nbsp;			this.statistic = statistic;</b>
<b class="nc">&nbsp;			this.value = value;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Statistic getStatistic() {
<b class="nc">&nbsp;			return this.statistic;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Double getValue() {
<b class="nc">&nbsp;			return this.value;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String toString() {
<b class="nc">&nbsp;			return &quot;MeasurementSample{statistic=&quot; + this.statistic + &quot;, value=&quot; + this.value + &#39;}&#39;;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
