


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > LogbackLoggingSystem</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.logging.logback</a>
</div>

<h1>Coverage Summary for Class: LogbackLoggingSystem (org.springframework.boot.logging.logback)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">LogbackLoggingSystem</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/42)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/188)
  </span>
</td>
</tr>
  <tr>
    <td class="name">LogbackLoggingSystem$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">LogbackLoggingSystem$Factory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/47)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.logging.logback;
&nbsp;
&nbsp;import java.net.URL;
&nbsp;import java.security.CodeSource;
&nbsp;import java.security.ProtectionDomain;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;import java.util.logging.ConsoleHandler;
&nbsp;import java.util.logging.Handler;
&nbsp;import java.util.logging.LogManager;
&nbsp;
&nbsp;import ch.qos.logback.classic.Level;
&nbsp;import ch.qos.logback.classic.LoggerContext;
&nbsp;import ch.qos.logback.classic.joran.JoranConfigurator;
&nbsp;import ch.qos.logback.classic.jul.LevelChangePropagator;
&nbsp;import ch.qos.logback.classic.spi.TurboFilterList;
&nbsp;import ch.qos.logback.classic.turbo.TurboFilter;
&nbsp;import ch.qos.logback.core.joran.spi.JoranException;
&nbsp;import ch.qos.logback.core.spi.FilterReply;
&nbsp;import ch.qos.logback.core.status.OnConsoleStatusListener;
&nbsp;import ch.qos.logback.core.status.Status;
&nbsp;import ch.qos.logback.core.status.StatusUtil;
&nbsp;import ch.qos.logback.core.util.StatusListenerConfigHelper;
&nbsp;import ch.qos.logback.core.util.StatusPrinter;
&nbsp;import org.slf4j.ILoggerFactory;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.slf4j.Marker;
&nbsp;import org.slf4j.bridge.SLF4JBridgeHandler;
&nbsp;import org.slf4j.helpers.SubstituteLoggerFactory;
&nbsp;
&nbsp;import org.springframework.aot.AotDetector;
&nbsp;import org.springframework.beans.factory.aot.BeanFactoryInitializationAotContribution;
&nbsp;import org.springframework.beans.factory.aot.BeanFactoryInitializationAotProcessor;
&nbsp;import org.springframework.beans.factory.config.ConfigurableListableBeanFactory;
&nbsp;import org.springframework.boot.logging.AbstractLoggingSystem;
&nbsp;import org.springframework.boot.logging.LogFile;
&nbsp;import org.springframework.boot.logging.LogLevel;
&nbsp;import org.springframework.boot.logging.LoggerConfiguration;
&nbsp;import org.springframework.boot.logging.LoggingInitializationContext;
&nbsp;import org.springframework.boot.logging.LoggingSystem;
&nbsp;import org.springframework.boot.logging.LoggingSystemFactory;
&nbsp;import org.springframework.boot.logging.LoggingSystemProperties;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.annotation.Order;
&nbsp;import org.springframework.core.env.ConfigurableEnvironment;
&nbsp;import org.springframework.core.env.Environment;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.ResourceUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * {@link LoggingSystem} for &lt;a href=&quot;https://logback.qos.ch&quot;&gt;logback&lt;/a&gt;.
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @author Dave Syer
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Ben Hale
&nbsp; * @since 1.0.0
&nbsp; */
&nbsp;public class LogbackLoggingSystem extends AbstractLoggingSystem implements BeanFactoryInitializationAotProcessor {
&nbsp;
&nbsp;	private static final String BRIDGE_HANDLER = &quot;org.slf4j.bridge.SLF4JBridgeHandler&quot;;
&nbsp;
&nbsp;	private static final String CONFIGURATION_FILE_PROPERTY = &quot;logback.configurationFile&quot;;
&nbsp;
<b class="nc">&nbsp;	private static final LogLevels&lt;Level&gt; LEVELS = new LogLevels&lt;&gt;();</b>
&nbsp;
&nbsp;	static {
<b class="nc">&nbsp;		LEVELS.map(LogLevel.TRACE, Level.TRACE);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.TRACE, Level.ALL);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.DEBUG, Level.DEBUG);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.INFO, Level.INFO);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.WARN, Level.WARN);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.ERROR, Level.ERROR);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.FATAL, Level.ERROR);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.OFF, Level.OFF);</b>
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	private static final TurboFilter FILTER = new TurboFilter() {</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public FilterReply decide(Marker marker, ch.qos.logback.classic.Logger logger, Level level, String format,
&nbsp;				Object[] params, Throwable t) {
<b class="nc">&nbsp;			return FilterReply.DENY;</b>
&nbsp;		}
&nbsp;
&nbsp;	};
&nbsp;
&nbsp;	public LogbackLoggingSystem(ClassLoader classLoader) {
<b class="nc">&nbsp;		super(classLoader);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public LoggingSystemProperties getSystemProperties(ConfigurableEnvironment environment) {
<b class="nc">&nbsp;		return new LogbackLoggingSystemProperties(environment, getDefaultValueResolver(environment), null);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String[] getStandardConfigLocations() {
<b class="nc">&nbsp;		return new String[] { &quot;logback-test.groovy&quot;, &quot;logback-test.xml&quot;, &quot;logback.groovy&quot;, &quot;logback.xml&quot; };</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void beforeInitialize() {
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		if (isAlreadyInitialized(loggerContext)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		super.beforeInitialize();</b>
<b class="nc">&nbsp;		configureJdkLoggingBridgeHandler();</b>
<b class="nc">&nbsp;		loggerContext.getTurboFilterList().add(FILTER);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureJdkLoggingBridgeHandler() {
&nbsp;		try {
<b class="nc">&nbsp;			if (isBridgeJulIntoSlf4j()) {</b>
<b class="nc">&nbsp;				removeJdkLoggingBridgeHandler();</b>
<b class="nc">&nbsp;				SLF4JBridgeHandler.install();</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (Throwable ex) {</b>
&nbsp;			// Ignore. No java.util.logging bridge is installed.
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isBridgeJulIntoSlf4j() {
<b class="nc">&nbsp;		return isBridgeHandlerAvailable() &amp;&amp; isJulUsingASingleConsoleHandlerAtMost();</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isBridgeHandlerAvailable() {
<b class="nc">&nbsp;		return ClassUtils.isPresent(BRIDGE_HANDLER, getClassLoader());</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isJulUsingASingleConsoleHandlerAtMost() {
<b class="nc">&nbsp;		java.util.logging.Logger rootLogger = LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;		Handler[] handlers = rootLogger.getHandlers();</b>
<b class="nc">&nbsp;		return handlers.length == 0 || (handlers.length == 1 &amp;&amp; handlers[0] instanceof ConsoleHandler);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void removeJdkLoggingBridgeHandler() {
&nbsp;		try {
<b class="nc">&nbsp;			removeDefaultRootHandler();</b>
<b class="nc">&nbsp;			SLF4JBridgeHandler.uninstall();</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Throwable ex) {</b>
&nbsp;			// Ignore and continue
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private void removeDefaultRootHandler() {
&nbsp;		try {
<b class="nc">&nbsp;			java.util.logging.Logger rootLogger = LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;			Handler[] handlers = rootLogger.getHandlers();</b>
<b class="nc">&nbsp;			if (handlers.length == 1 &amp;&amp; handlers[0] instanceof ConsoleHandler) {</b>
<b class="nc">&nbsp;				rootLogger.removeHandler(handlers[0]);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (Throwable ex) {</b>
&nbsp;			// Ignore and continue
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile) {
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		if (isAlreadyInitialized(loggerContext)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		if (!initializeFromAotGeneratedArtifactsIfPossible(initializationContext, logFile)) {</b>
<b class="nc">&nbsp;			super.initialize(initializationContext, configLocation, logFile);</b>
&nbsp;		}
<b class="nc">&nbsp;		loggerContext.putObject(Environment.class.getName(), initializationContext.getEnvironment());</b>
<b class="nc">&nbsp;		loggerContext.getTurboFilterList().remove(FILTER);</b>
<b class="nc">&nbsp;		markAsInitialized(loggerContext);</b>
<b class="nc">&nbsp;		if (StringUtils.hasText(System.getProperty(CONFIGURATION_FILE_PROPERTY))) {</b>
<b class="nc">&nbsp;			getLogger(LogbackLoggingSystem.class.getName()).warn(&quot;Ignoring &#39;&quot; + CONFIGURATION_FILE_PROPERTY</b>
&nbsp;					+ &quot;&#39; system property. Please use &#39;logging.config&#39; instead.&quot;);
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private boolean initializeFromAotGeneratedArtifactsIfPossible(LoggingInitializationContext initializationContext,
&nbsp;			LogFile logFile) {
<b class="nc">&nbsp;		if (!AotDetector.useGeneratedArtifacts()) {</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (initializationContext != null) {</b>
<b class="nc">&nbsp;			applySystemProperties(initializationContext.getEnvironment(), logFile);</b>
&nbsp;		}
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		stopAndReset(loggerContext);</b>
<b class="nc">&nbsp;		SpringBootJoranConfigurator configurator = new SpringBootJoranConfigurator(initializationContext);</b>
<b class="nc">&nbsp;		configurator.setContext(loggerContext);</b>
<b class="nc">&nbsp;		boolean configuredUsingAotGeneratedArtifacts = configurator.configureUsingAotGeneratedArtifacts();</b>
<b class="nc">&nbsp;		if (configuredUsingAotGeneratedArtifacts) {</b>
<b class="nc">&nbsp;			reportConfigurationErrorsIfNecessary(loggerContext);</b>
&nbsp;		}
<b class="nc">&nbsp;		return configuredUsingAotGeneratedArtifacts;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void loadDefaults(LoggingInitializationContext initializationContext, LogFile logFile) {
<b class="nc">&nbsp;		LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;		stopAndReset(context);</b>
<b class="nc">&nbsp;		withLoggingSuppressed(() -&gt; {</b>
<b class="nc">&nbsp;			boolean debug = Boolean.getBoolean(&quot;logback.debug&quot;);</b>
<b class="nc">&nbsp;			if (debug) {</b>
<b class="nc">&nbsp;				StatusListenerConfigHelper.addOnConsoleListenerInstance(context, new OnConsoleStatusListener());</b>
&nbsp;			}
<b class="nc">&nbsp;			Environment environment = initializationContext.getEnvironment();</b>
&nbsp;			// Apply system properties directly in case the same JVM runs multiple apps
<b class="nc">&nbsp;			new LogbackLoggingSystemProperties(environment, getDefaultValueResolver(environment), context::putProperty)</b>
<b class="nc">&nbsp;				.apply(logFile);</b>
<b class="nc">&nbsp;			LogbackConfigurator configurator = debug ? new DebugLogbackConfigurator(context)</b>
<b class="nc">&nbsp;					: new LogbackConfigurator(context);</b>
<b class="nc">&nbsp;			new DefaultLogbackConfiguration(logFile).apply(configurator);</b>
<b class="nc">&nbsp;			context.setPackagingDataEnabled(true);</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void loadConfiguration(LoggingInitializationContext initializationContext, String location,
&nbsp;			LogFile logFile) {
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		stopAndReset(loggerContext);</b>
<b class="nc">&nbsp;		withLoggingSuppressed(() -&gt; {</b>
<b class="nc">&nbsp;			if (initializationContext != null) {</b>
<b class="nc">&nbsp;				applySystemProperties(initializationContext.getEnvironment(), logFile);</b>
&nbsp;			}
&nbsp;			try {
<b class="nc">&nbsp;				configureByResourceUrl(initializationContext, loggerContext, ResourceUtils.getURL(location));</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception ex) {</b>
<b class="nc">&nbsp;				throw new IllegalStateException(&quot;Could not initialize Logback logging from &quot; + location, ex);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		});
<b class="nc">&nbsp;		reportConfigurationErrorsIfNecessary(loggerContext);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void reportConfigurationErrorsIfNecessary(LoggerContext loggerContext) {
<b class="nc">&nbsp;		StringBuilder errors = new StringBuilder();</b>
<b class="nc">&nbsp;		List&lt;Throwable&gt; suppressedExceptions = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for (Status status : loggerContext.getStatusManager().getCopyOfStatusList()) {</b>
<b class="nc">&nbsp;			if (status.getLevel() == Status.ERROR) {</b>
<b class="nc">&nbsp;				errors.append((!errors.isEmpty()) ? String.format(&quot;%n&quot;) : &quot;&quot;);</b>
<b class="nc">&nbsp;				errors.append(status);</b>
<b class="nc">&nbsp;				if (status.getThrowable() != null) {</b>
<b class="nc">&nbsp;					suppressedExceptions.add(status.getThrowable());</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		if (errors.isEmpty()) {</b>
<b class="nc">&nbsp;			if (!StatusUtil.contextHasStatusListener(loggerContext)) {</b>
<b class="nc">&nbsp;				StatusPrinter.printInCaseOfErrorsOrWarnings(loggerContext);</b>
&nbsp;			}
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		IllegalStateException ex = new IllegalStateException(</b>
<b class="nc">&nbsp;				String.format(&quot;Logback configuration error detected: %n%s&quot;, errors));</b>
<b class="nc">&nbsp;		suppressedExceptions.forEach(ex::addSuppressed);</b>
<b class="nc">&nbsp;		throw ex;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureByResourceUrl(LoggingInitializationContext initializationContext, LoggerContext loggerContext,
&nbsp;			URL url) throws JoranException {
<b class="nc">&nbsp;		if (url.getPath().endsWith(&quot;.xml&quot;)) {</b>
<b class="nc">&nbsp;			JoranConfigurator configurator = new SpringBootJoranConfigurator(initializationContext);</b>
<b class="nc">&nbsp;			configurator.setContext(loggerContext);</b>
<b class="nc">&nbsp;			configurator.doConfigure(url);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;		else {
<b class="nc">&nbsp;			throw new IllegalArgumentException(&quot;Unsupported file extension in &#39;&quot; + url + &quot;&#39;. Only .xml is supported&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void stopAndReset(LoggerContext loggerContext) {
<b class="nc">&nbsp;		loggerContext.stop();</b>
<b class="nc">&nbsp;		loggerContext.reset();</b>
<b class="nc">&nbsp;		if (isBridgeHandlerInstalled()) {</b>
<b class="nc">&nbsp;			addLevelChangePropagator(loggerContext);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private boolean isBridgeHandlerInstalled() {
<b class="nc">&nbsp;		if (!isBridgeHandlerAvailable()) {</b>
<b class="nc">&nbsp;			return false;</b>
&nbsp;		}
<b class="nc">&nbsp;		java.util.logging.Logger rootLogger = LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;		Handler[] handlers = rootLogger.getHandlers();</b>
<b class="nc">&nbsp;		return handlers.length == 1 &amp;&amp; handlers[0] instanceof SLF4JBridgeHandler;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addLevelChangePropagator(LoggerContext loggerContext) {
<b class="nc">&nbsp;		LevelChangePropagator levelChangePropagator = new LevelChangePropagator();</b>
<b class="nc">&nbsp;		levelChangePropagator.setResetJUL(true);</b>
<b class="nc">&nbsp;		levelChangePropagator.setContext(loggerContext);</b>
<b class="nc">&nbsp;		loggerContext.addListener(levelChangePropagator);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void cleanUp() {
<b class="nc">&nbsp;		LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;		markAsUninitialized(context);</b>
<b class="nc">&nbsp;		super.cleanUp();</b>
<b class="nc">&nbsp;		if (isBridgeHandlerAvailable()) {</b>
<b class="nc">&nbsp;			removeJdkLoggingBridgeHandler();</b>
&nbsp;		}
<b class="nc">&nbsp;		context.getStatusManager().clear();</b>
<b class="nc">&nbsp;		context.getTurboFilterList().remove(FILTER);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void reinitialize(LoggingInitializationContext initializationContext) {
<b class="nc">&nbsp;		getLoggerContext().reset();</b>
<b class="nc">&nbsp;		getLoggerContext().getStatusManager().clear();</b>
<b class="nc">&nbsp;		loadConfiguration(initializationContext, getSelfInitializationConfig(), null);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public List&lt;LoggerConfiguration&gt; getLoggerConfigurations() {
<b class="nc">&nbsp;		List&lt;LoggerConfiguration&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for (ch.qos.logback.classic.Logger logger : getLoggerContext().getLoggerList()) {</b>
<b class="nc">&nbsp;			result.add(getLoggerConfiguration(logger));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		result.sort(CONFIGURATION_COMPARATOR);</b>
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public LoggerConfiguration getLoggerConfiguration(String loggerName) {
<b class="nc">&nbsp;		String name = getLoggerName(loggerName);</b>
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		return getLoggerConfiguration(loggerContext.exists(name));</b>
&nbsp;	}
&nbsp;
&nbsp;	private String getLoggerName(String name) {
<b class="nc">&nbsp;		if (!StringUtils.hasLength(name) || Logger.ROOT_LOGGER_NAME.equals(name)) {</b>
<b class="nc">&nbsp;			return ROOT_LOGGER_NAME;</b>
&nbsp;		}
<b class="nc">&nbsp;		return name;</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerConfiguration getLoggerConfiguration(ch.qos.logback.classic.Logger logger) {
<b class="nc">&nbsp;		if (logger == null) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		LogLevel level = LEVELS.convertNativeToSystem(logger.getLevel());</b>
<b class="nc">&nbsp;		LogLevel effectiveLevel = LEVELS.convertNativeToSystem(logger.getEffectiveLevel());</b>
<b class="nc">&nbsp;		String name = getLoggerName(logger.getName());</b>
<b class="nc">&nbsp;		return new LoggerConfiguration(name, level, effectiveLevel);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Set&lt;LogLevel&gt; getSupportedLogLevels() {
<b class="nc">&nbsp;		return LEVELS.getSupported();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setLogLevel(String loggerName, LogLevel level) {
<b class="nc">&nbsp;		ch.qos.logback.classic.Logger logger = getLogger(loggerName);</b>
<b class="nc">&nbsp;		if (logger != null) {</b>
<b class="nc">&nbsp;			logger.setLevel(LEVELS.convertSystemToNative(level));</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Runnable getShutdownHandler() {
<b class="nc">&nbsp;		return () -&gt; getLoggerContext().stop();</b>
&nbsp;	}
&nbsp;
&nbsp;	private ch.qos.logback.classic.Logger getLogger(String name) {
<b class="nc">&nbsp;		LoggerContext factory = getLoggerContext();</b>
<b class="nc">&nbsp;		return factory.getLogger(getLoggerName(name));</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerContext getLoggerContext() {
<b class="nc">&nbsp;		ILoggerFactory factory = getLoggerFactory();</b>
<b class="nc">&nbsp;		Assert.isInstanceOf(LoggerContext.class, factory,</b>
<b class="nc">&nbsp;				() -&gt; String.format(</b>
&nbsp;						&quot;LoggerFactory is not a Logback LoggerContext but Logback is on &quot;
&nbsp;								+ &quot;the classpath. Either remove Logback or the competing &quot;
&nbsp;								+ &quot;implementation (%s loaded from %s). If you are using &quot;
&nbsp;								+ &quot;WebLogic you will need to add &#39;org.slf4j&#39; to &quot;
&nbsp;								+ &quot;prefer-application-packages in WEB-INF/weblogic.xml&quot;,
<b class="nc">&nbsp;						factory.getClass(), getLocation(factory)));</b>
<b class="nc">&nbsp;		return (LoggerContext) factory;</b>
&nbsp;	}
&nbsp;
&nbsp;	private ILoggerFactory getLoggerFactory() {
<b class="nc">&nbsp;		ILoggerFactory factory = LoggerFactory.getILoggerFactory();</b>
<b class="nc">&nbsp;		while (factory instanceof SubstituteLoggerFactory) {</b>
&nbsp;			try {
<b class="nc">&nbsp;				Thread.sleep(50);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (InterruptedException ex) {</b>
<b class="nc">&nbsp;				Thread.currentThread().interrupt();</b>
<b class="nc">&nbsp;				throw new IllegalStateException(&quot;Interrupted while waiting for non-substitute logger factory&quot;, ex);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			factory = LoggerFactory.getILoggerFactory();</b>
&nbsp;		}
<b class="nc">&nbsp;		return factory;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Object getLocation(ILoggerFactory factory) {
&nbsp;		try {
<b class="nc">&nbsp;			ProtectionDomain protectionDomain = factory.getClass().getProtectionDomain();</b>
<b class="nc">&nbsp;			CodeSource codeSource = protectionDomain.getCodeSource();</b>
<b class="nc">&nbsp;			if (codeSource != null) {</b>
<b class="nc">&nbsp;				return codeSource.getLocation();</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (SecurityException ex) {</b>
&nbsp;			// Unable to determine location
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return &quot;unknown location&quot;;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isAlreadyInitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		return loggerContext.getObject(LoggingSystem.class.getName()) != null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void markAsInitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		loggerContext.putObject(LoggingSystem.class.getName(), new Object());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void markAsUninitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		loggerContext.removeObject(LoggingSystem.class.getName());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String getDefaultLogCorrelationPattern() {
<b class="nc">&nbsp;		return &quot;%correlationId&quot;;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public BeanFactoryInitializationAotContribution processAheadOfTime(ConfigurableListableBeanFactory beanFactory) {
<b class="nc">&nbsp;		String key = BeanFactoryInitializationAotContribution.class.getName();</b>
<b class="nc">&nbsp;		LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;		BeanFactoryInitializationAotContribution contribution = (BeanFactoryInitializationAotContribution) context</b>
<b class="nc">&nbsp;			.getObject(key);</b>
<b class="nc">&nbsp;		context.removeObject(key);</b>
<b class="nc">&nbsp;		return contribution;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void withLoggingSuppressed(Runnable action) {
<b class="nc">&nbsp;		TurboFilterList turboFilters = getLoggerContext().getTurboFilterList();</b>
<b class="nc">&nbsp;		turboFilters.add(FILTER);</b>
&nbsp;		try {
<b class="nc">&nbsp;			action.run();</b>
&nbsp;		}
&nbsp;		finally {
<b class="nc">&nbsp;			turboFilters.remove(FILTER);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link LoggingSystemFactory} that returns {@link LogbackLoggingSystem} if possible.
&nbsp;	 */
&nbsp;	@Order(Ordered.LOWEST_PRECEDENCE)
<b class="nc">&nbsp;	public static class Factory implements LoggingSystemFactory {</b>
&nbsp;
<b class="nc">&nbsp;		private static final boolean PRESENT = ClassUtils.isPresent(&quot;ch.qos.logback.classic.LoggerContext&quot;,</b>
<b class="nc">&nbsp;				Factory.class.getClassLoader());</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public LoggingSystem getLoggingSystem(ClassLoader classLoader) {
<b class="nc">&nbsp;			if (PRESENT) {</b>
<b class="nc">&nbsp;				return new LogbackLoggingSystem(classLoader);</b>
&nbsp;			}
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-28 21:28</div>
</div>
</body>
</html>
