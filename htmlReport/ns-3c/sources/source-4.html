


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > Log4J2LoggingSystem</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.logging.log4j2</a>
</div>

<h1>Coverage Summary for Class: Log4J2LoggingSystem (org.springframework.boot.logging.log4j2)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Log4J2LoggingSystem</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/184)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Log4J2LoggingSystem$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Log4J2LoggingSystem$Factory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Log4J2LoggingSystem$LevelSetLoggerConfig</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/196)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.logging.log4j2;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLConnection;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Properties;
&nbsp;import java.util.Set;
&nbsp;import java.util.logging.ConsoleHandler;
&nbsp;import java.util.logging.Handler;
&nbsp;
&nbsp;import org.apache.logging.log4j.Level;
&nbsp;import org.apache.logging.log4j.LogManager;
&nbsp;import org.apache.logging.log4j.Marker;
&nbsp;import org.apache.logging.log4j.core.Filter;
&nbsp;import org.apache.logging.log4j.core.LogEvent;
&nbsp;import org.apache.logging.log4j.core.Logger;
&nbsp;import org.apache.logging.log4j.core.LoggerContext;
&nbsp;import org.apache.logging.log4j.core.config.AbstractConfiguration;
&nbsp;import org.apache.logging.log4j.core.config.Configuration;
&nbsp;import org.apache.logging.log4j.core.config.ConfigurationFactory;
&nbsp;import org.apache.logging.log4j.core.config.ConfigurationSource;
&nbsp;import org.apache.logging.log4j.core.config.LoggerConfig;
&nbsp;import org.apache.logging.log4j.core.config.composite.CompositeConfiguration;
&nbsp;import org.apache.logging.log4j.core.filter.AbstractFilter;
&nbsp;import org.apache.logging.log4j.core.net.UrlConnectionFactory;
&nbsp;import org.apache.logging.log4j.core.net.ssl.SslConfiguration;
&nbsp;import org.apache.logging.log4j.core.net.ssl.SslConfigurationFactory;
&nbsp;import org.apache.logging.log4j.core.util.AuthorizationProvider;
&nbsp;import org.apache.logging.log4j.core.util.NameUtil;
&nbsp;import org.apache.logging.log4j.jul.Log4jBridgeHandler;
&nbsp;import org.apache.logging.log4j.message.Message;
&nbsp;import org.apache.logging.log4j.util.PropertiesUtil;
&nbsp;
&nbsp;import org.springframework.boot.context.properties.bind.BindResult;
&nbsp;import org.springframework.boot.context.properties.bind.Bindable;
&nbsp;import org.springframework.boot.context.properties.bind.Binder;
&nbsp;import org.springframework.boot.logging.AbstractLoggingSystem;
&nbsp;import org.springframework.boot.logging.LogFile;
&nbsp;import org.springframework.boot.logging.LogLevel;
&nbsp;import org.springframework.boot.logging.LoggerConfiguration;
&nbsp;import org.springframework.boot.logging.LoggerConfiguration.LevelConfiguration;
&nbsp;import org.springframework.boot.logging.LoggingInitializationContext;
&nbsp;import org.springframework.boot.logging.LoggingSystem;
&nbsp;import org.springframework.boot.logging.LoggingSystemFactory;
&nbsp;import org.springframework.core.Conventions;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.annotation.Order;
&nbsp;import org.springframework.core.env.Environment;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.springframework.util.ResourceUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * {@link LoggingSystem} for &lt;a href=&quot;https://logging.apache.org/log4j/2.x/&quot;&gt;Log4j 2&lt;/a&gt;.
&nbsp; *
&nbsp; * @author Daniel Fullarton
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Alexander Heusingfeld
&nbsp; * @author Ben Hale
&nbsp; * @author Ralph Goers
&nbsp; * @since 1.2.0
&nbsp; */
&nbsp;public class Log4J2LoggingSystem extends AbstractLoggingSystem {
&nbsp;
&nbsp;	private static final String FILE_PROTOCOL = &quot;file&quot;;
&nbsp;
&nbsp;	private static final String LOG4J_BRIDGE_HANDLER = &quot;org.apache.logging.log4j.jul.Log4jBridgeHandler&quot;;
&nbsp;
&nbsp;	private static final String LOG4J_LOG_MANAGER = &quot;org.apache.logging.log4j.jul.LogManager&quot;;
&nbsp;
<b class="nc">&nbsp;	static final String ENVIRONMENT_KEY = Conventions.getQualifiedAttributeName(Log4J2LoggingSystem.class,</b>
&nbsp;			&quot;environment&quot;);
&nbsp;
<b class="nc">&nbsp;	private static final LogLevels&lt;Level&gt; LEVELS = new LogLevels&lt;&gt;();</b>
&nbsp;
&nbsp;	static {
<b class="nc">&nbsp;		LEVELS.map(LogLevel.TRACE, Level.TRACE);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.DEBUG, Level.DEBUG);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.INFO, Level.INFO);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.WARN, Level.WARN);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.ERROR, Level.ERROR);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.FATAL, Level.FATAL);</b>
<b class="nc">&nbsp;		LEVELS.map(LogLevel.OFF, Level.OFF);</b>
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	private static final Filter FILTER = new AbstractFilter() {</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public Result filter(LogEvent event) {
<b class="nc">&nbsp;			return Result.DENY;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Result filter(Logger logger, Level level, Marker marker, Message msg, Throwable t) {
<b class="nc">&nbsp;			return Result.DENY;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Result filter(Logger logger, Level level, Marker marker, Object msg, Throwable t) {
<b class="nc">&nbsp;			return Result.DENY;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Result filter(Logger logger, Level level, Marker marker, String msg, Object... params) {
<b class="nc">&nbsp;			return Result.DENY;</b>
&nbsp;		}
&nbsp;
&nbsp;	};
&nbsp;
&nbsp;	public Log4J2LoggingSystem(ClassLoader classLoader) {
<b class="nc">&nbsp;		super(classLoader);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String[] getStandardConfigLocations() {
<b class="nc">&nbsp;		List&lt;String&gt; locations = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		locations.add(&quot;log4j2-test.properties&quot;);</b>
<b class="nc">&nbsp;		if (isClassAvailable(&quot;com.fasterxml.jackson.dataformat.yaml.YAMLParser&quot;)) {</b>
<b class="nc">&nbsp;			Collections.addAll(locations, &quot;log4j2-test.yaml&quot;, &quot;log4j2-test.yml&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (isClassAvailable(&quot;com.fasterxml.jackson.databind.ObjectMapper&quot;)) {</b>
<b class="nc">&nbsp;			Collections.addAll(locations, &quot;log4j2-test.json&quot;, &quot;log4j2-test.jsn&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		locations.add(&quot;log4j2-test.xml&quot;);</b>
<b class="nc">&nbsp;		locations.add(&quot;log4j2.properties&quot;);</b>
<b class="nc">&nbsp;		if (isClassAvailable(&quot;com.fasterxml.jackson.dataformat.yaml.YAMLParser&quot;)) {</b>
<b class="nc">&nbsp;			Collections.addAll(locations, &quot;log4j2.yaml&quot;, &quot;log4j2.yml&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (isClassAvailable(&quot;com.fasterxml.jackson.databind.ObjectMapper&quot;)) {</b>
<b class="nc">&nbsp;			Collections.addAll(locations, &quot;log4j2.json&quot;, &quot;log4j2.jsn&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		locations.add(&quot;log4j2.xml&quot;);</b>
<b class="nc">&nbsp;		String propertyDefinedLocation = new PropertiesUtil(new Properties())</b>
<b class="nc">&nbsp;			.getStringProperty(ConfigurationFactory.CONFIGURATION_FILE_PROPERTY);</b>
<b class="nc">&nbsp;		if (propertyDefinedLocation != null) {</b>
<b class="nc">&nbsp;			locations.add(propertyDefinedLocation);</b>
&nbsp;		}
<b class="nc">&nbsp;		return StringUtils.toStringArray(locations);</b>
&nbsp;	}
&nbsp;
&nbsp;	protected boolean isClassAvailable(String className) {
<b class="nc">&nbsp;		return ClassUtils.isPresent(className, getClassLoader());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void beforeInitialize() {
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		if (isAlreadyInitialized(loggerContext)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		if (!configureJdkLoggingBridgeHandler()) {</b>
<b class="nc">&nbsp;			super.beforeInitialize();</b>
&nbsp;		}
<b class="nc">&nbsp;		loggerContext.getConfiguration().addFilter(FILTER);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean configureJdkLoggingBridgeHandler() {
&nbsp;		try {
<b class="nc">&nbsp;			if (isJulUsingASingleConsoleHandlerAtMost() &amp;&amp; !isLog4jLogManagerInstalled()</b>
<b class="nc">&nbsp;					&amp;&amp; isLog4jBridgeHandlerAvailable()) {</b>
<b class="nc">&nbsp;				removeDefaultRootHandler();</b>
<b class="nc">&nbsp;				Log4jBridgeHandler.install(false, null, true);</b>
<b class="nc">&nbsp;				return true;</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (Throwable ex) {</b>
&nbsp;			// Ignore. No java.util.logging bridge is installed.
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return false;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isJulUsingASingleConsoleHandlerAtMost() {
<b class="nc">&nbsp;		java.util.logging.Logger rootLogger = java.util.logging.LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;		Handler[] handlers = rootLogger.getHandlers();</b>
<b class="nc">&nbsp;		return handlers.length == 0 || (handlers.length == 1 &amp;&amp; handlers[0] instanceof ConsoleHandler);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isLog4jLogManagerInstalled() {
<b class="nc">&nbsp;		final String logManagerClassName = java.util.logging.LogManager.getLogManager().getClass().getName();</b>
<b class="nc">&nbsp;		return LOG4J_LOG_MANAGER.equals(logManagerClassName);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isLog4jBridgeHandlerAvailable() {
<b class="nc">&nbsp;		return ClassUtils.isPresent(LOG4J_BRIDGE_HANDLER, getClassLoader());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void removeLog4jBridgeHandler() {
<b class="nc">&nbsp;		removeDefaultRootHandler();</b>
<b class="nc">&nbsp;		java.util.logging.Logger rootLogger = java.util.logging.LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;		for (final Handler handler : rootLogger.getHandlers()) {</b>
<b class="nc">&nbsp;			if (handler instanceof Log4jBridgeHandler) {</b>
<b class="nc">&nbsp;				handler.close();</b>
<b class="nc">&nbsp;				rootLogger.removeHandler(handler);</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void removeDefaultRootHandler() {
&nbsp;		try {
<b class="nc">&nbsp;			java.util.logging.Logger rootLogger = java.util.logging.LogManager.getLogManager().getLogger(&quot;&quot;);</b>
<b class="nc">&nbsp;			Handler[] handlers = rootLogger.getHandlers();</b>
<b class="nc">&nbsp;			if (handlers.length == 1 &amp;&amp; handlers[0] instanceof ConsoleHandler) {</b>
<b class="nc">&nbsp;				rootLogger.removeHandler(handlers[0]);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		catch (Throwable ex) {</b>
&nbsp;			// Ignore and continue
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void initialize(LoggingInitializationContext initializationContext, String configLocation, LogFile logFile) {
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		if (isAlreadyInitialized(loggerContext)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		Environment environment = initializationContext.getEnvironment();</b>
<b class="nc">&nbsp;		if (environment != null) {</b>
<b class="nc">&nbsp;			getLoggerContext().putObjectIfAbsent(ENVIRONMENT_KEY, environment);</b>
<b class="nc">&nbsp;			PropertiesUtil.getProperties().addPropertySource(new SpringEnvironmentPropertySource(environment));</b>
&nbsp;		}
<b class="nc">&nbsp;		loggerContext.getConfiguration().removeFilter(FILTER);</b>
<b class="nc">&nbsp;		super.initialize(initializationContext, configLocation, logFile);</b>
<b class="nc">&nbsp;		markAsInitialized(loggerContext);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void loadDefaults(LoggingInitializationContext initializationContext, LogFile logFile) {
<b class="nc">&nbsp;		String location = getPackagedConfigFile((logFile != null) ? &quot;log4j2-file.xml&quot; : &quot;log4j2.xml&quot;);</b>
<b class="nc">&nbsp;		load(initializationContext, location, logFile);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void loadConfiguration(LoggingInitializationContext initializationContext, String location,
&nbsp;			LogFile logFile) {
<b class="nc">&nbsp;		load(initializationContext, location, logFile);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void load(LoggingInitializationContext initializationContext, String location, LogFile logFile) {
<b class="nc">&nbsp;		List&lt;String&gt; overrides = getOverrides(initializationContext);</b>
<b class="nc">&nbsp;		if (initializationContext != null) {</b>
<b class="nc">&nbsp;			applySystemProperties(initializationContext.getEnvironment(), logFile);</b>
&nbsp;		}
<b class="nc">&nbsp;		loadConfiguration(location, logFile, overrides);</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;String&gt; getOverrides(LoggingInitializationContext initializationContext) {
<b class="nc">&nbsp;		BindResult&lt;List&lt;String&gt;&gt; overrides = Binder.get(initializationContext.getEnvironment())</b>
<b class="nc">&nbsp;			.bind(&quot;logging.log4j2.config.override&quot;, Bindable.listOf(String.class));</b>
<b class="nc">&nbsp;		return overrides.orElse(Collections.emptyList());</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Load the configuration from the given {@code location}, creating a composite using
&nbsp;	 * the configuration from the given {@code overrides}.
&nbsp;	 * @param location the location
&nbsp;	 * @param logFile log file configuration
&nbsp;	 * @param overrides the overriding locations
&nbsp;	 * @since 2.6.0
&nbsp;	 */
&nbsp;	protected void loadConfiguration(String location, LogFile logFile, List&lt;String&gt; overrides) {
<b class="nc">&nbsp;		Assert.notNull(location, &quot;Location must not be null&quot;);</b>
&nbsp;		try {
<b class="nc">&nbsp;			List&lt;Configuration&gt; configurations = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;			LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;			configurations.add(load(location, context));</b>
<b class="nc">&nbsp;			for (String override : overrides) {</b>
<b class="nc">&nbsp;				configurations.add(load(override, context));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			Configuration configuration = (configurations.size() &gt; 1) ? createComposite(configurations)</b>
<b class="nc">&nbsp;					: configurations.iterator().next();</b>
<b class="nc">&nbsp;			context.start(configuration);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Could not initialize Log4J2 logging from &quot; + location, ex);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private Configuration load(String location, LoggerContext context) throws IOException {
<b class="nc">&nbsp;		URL url = ResourceUtils.getURL(location);</b>
<b class="nc">&nbsp;		ConfigurationSource source = getConfigurationSource(url);</b>
<b class="nc">&nbsp;		return ConfigurationFactory.getInstance().getConfiguration(context, source);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ConfigurationSource getConfigurationSource(URL url) throws IOException {
<b class="nc">&nbsp;		if (FILE_PROTOCOL.equals(url.getProtocol())) {</b>
<b class="nc">&nbsp;			return new ConfigurationSource(url.openStream(), ResourceUtils.getFile(url));</b>
&nbsp;		}
&nbsp;		AuthorizationProvider authorizationProvider = ConfigurationFactory
<b class="nc">&nbsp;			.authorizationProvider(PropertiesUtil.getProperties());</b>
<b class="nc">&nbsp;		SslConfiguration sslConfiguration = url.getProtocol().equals(&quot;https&quot;)</b>
<b class="nc">&nbsp;				? SslConfigurationFactory.getSslConfiguration() : null;</b>
<b class="nc">&nbsp;		URLConnection connection = UrlConnectionFactory.createConnection(url, 0, sslConfiguration,</b>
&nbsp;				authorizationProvider);
<b class="nc">&nbsp;		return new ConfigurationSource(connection.getInputStream(), url, connection.getLastModified());</b>
&nbsp;	}
&nbsp;
&nbsp;	private CompositeConfiguration createComposite(List&lt;Configuration&gt; configurations) {
<b class="nc">&nbsp;		return new CompositeConfiguration(configurations.stream().map(AbstractConfiguration.class::cast).toList());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected void reinitialize(LoggingInitializationContext initializationContext) {
<b class="nc">&nbsp;		List&lt;String&gt; overrides = getOverrides(initializationContext);</b>
<b class="nc">&nbsp;		if (!CollectionUtils.isEmpty(overrides)) {</b>
<b class="nc">&nbsp;			reinitializeWithOverrides(overrides);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;			context.reconfigure();</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void reinitializeWithOverrides(List&lt;String&gt; overrides) {
<b class="nc">&nbsp;		LoggerContext context = getLoggerContext();</b>
<b class="nc">&nbsp;		Configuration base = context.getConfiguration();</b>
<b class="nc">&nbsp;		List&lt;AbstractConfiguration&gt; configurations = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		configurations.add((AbstractConfiguration) base);</b>
<b class="nc">&nbsp;		for (String override : overrides) {</b>
&nbsp;			try {
<b class="nc">&nbsp;				configurations.add((AbstractConfiguration) load(override, context));</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (IOException ex) {</b>
<b class="nc">&nbsp;				throw new RuntimeException(&quot;Failed to load overriding configuration from &#39;&quot; + override + &quot;&#39;&quot;, ex);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		CompositeConfiguration composite = new CompositeConfiguration(configurations);</b>
<b class="nc">&nbsp;		context.reconfigure(composite);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Set&lt;LogLevel&gt; getSupportedLogLevels() {
<b class="nc">&nbsp;		return LEVELS.getSupported();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setLogLevel(String loggerName, LogLevel logLevel) {
<b class="nc">&nbsp;		setLogLevel(loggerName, LEVELS.convertSystemToNative(logLevel));</b>
&nbsp;	}
&nbsp;
&nbsp;	private void setLogLevel(String loggerName, Level level) {
<b class="nc">&nbsp;		LoggerConfig logger = getLogger(loggerName);</b>
<b class="nc">&nbsp;		if (level == null) {</b>
<b class="nc">&nbsp;			clearLogLevel(loggerName, logger);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			setLogLevel(loggerName, logger, level);</b>
&nbsp;		}
<b class="nc">&nbsp;		getLoggerContext().updateLoggers();</b>
&nbsp;	}
&nbsp;
&nbsp;	private void clearLogLevel(String loggerName, LoggerConfig logger) {
<b class="nc">&nbsp;		if (logger instanceof LevelSetLoggerConfig) {</b>
<b class="nc">&nbsp;			getLoggerContext().getConfiguration().removeLogger(loggerName);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			logger.setLevel(null);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void setLogLevel(String loggerName, LoggerConfig logger, Level level) {
<b class="nc">&nbsp;		if (logger == null) {</b>
<b class="nc">&nbsp;			getLoggerContext().getConfiguration()</b>
<b class="nc">&nbsp;				.addLogger(loggerName, new LevelSetLoggerConfig(loggerName, level, true));</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			logger.setLevel(level);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public List&lt;LoggerConfiguration&gt; getLoggerConfigurations() {
<b class="nc">&nbsp;		List&lt;LoggerConfiguration&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		getAllLoggers().forEach((name, loggerConfig) -&gt; result.add(convertLoggerConfig(name, loggerConfig)));</b>
<b class="nc">&nbsp;		result.sort(CONFIGURATION_COMPARATOR);</b>
<b class="nc">&nbsp;		return result;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public LoggerConfiguration getLoggerConfiguration(String loggerName) {
<b class="nc">&nbsp;		LoggerConfig loggerConfig = getAllLoggers().get(loggerName);</b>
<b class="nc">&nbsp;		return (loggerConfig != null) ? convertLoggerConfig(loggerName, loggerConfig) : null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Map&lt;String, LoggerConfig&gt; getAllLoggers() {
<b class="nc">&nbsp;		Map&lt;String, LoggerConfig&gt; loggers = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;		for (Logger logger : getLoggerContext().getLoggers()) {</b>
<b class="nc">&nbsp;			addLogger(loggers, logger.getName());</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		getLoggerContext().getConfiguration().getLoggers().keySet().forEach((name) -&gt; addLogger(loggers, name));</b>
<b class="nc">&nbsp;		return loggers;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addLogger(Map&lt;String, LoggerConfig&gt; loggers, String name) {
<b class="nc">&nbsp;		Configuration configuration = getLoggerContext().getConfiguration();</b>
<b class="nc">&nbsp;		while (name != null) {</b>
<b class="nc">&nbsp;			loggers.computeIfAbsent(name, configuration::getLoggerConfig);</b>
<b class="nc">&nbsp;			name = getSubName(name);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private String getSubName(String name) {
<b class="nc">&nbsp;		if (!StringUtils.hasLength(name)) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		int nested = name.lastIndexOf(&#39;$&#39;);</b>
<b class="nc">&nbsp;		return (nested != -1) ? name.substring(0, nested) : NameUtil.getSubName(name);</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerConfiguration convertLoggerConfig(String name, LoggerConfig loggerConfig) {
<b class="nc">&nbsp;		if (loggerConfig == null) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		LevelConfiguration effectiveLevelConfiguration = getLevelConfiguration(loggerConfig.getLevel());</b>
<b class="nc">&nbsp;		if (!StringUtils.hasLength(name) || LogManager.ROOT_LOGGER_NAME.equals(name)) {</b>
<b class="nc">&nbsp;			name = ROOT_LOGGER_NAME;</b>
&nbsp;		}
<b class="nc">&nbsp;		boolean isAssigned = loggerConfig.getName().equals(name);</b>
<b class="nc">&nbsp;		LevelConfiguration assignedLevelConfiguration = (!isAssigned) ? null : effectiveLevelConfiguration;</b>
<b class="nc">&nbsp;		return new LoggerConfiguration(name, assignedLevelConfiguration, effectiveLevelConfiguration);</b>
&nbsp;	}
&nbsp;
&nbsp;	private LevelConfiguration getLevelConfiguration(Level level) {
<b class="nc">&nbsp;		LogLevel logLevel = LEVELS.convertNativeToSystem(level);</b>
<b class="nc">&nbsp;		return (logLevel != null) ? LevelConfiguration.of(logLevel) : LevelConfiguration.ofCustom(level.name());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Runnable getShutdownHandler() {
<b class="nc">&nbsp;		return () -&gt; getLoggerContext().stop();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void cleanUp() {
<b class="nc">&nbsp;		if (isLog4jBridgeHandlerAvailable()) {</b>
<b class="nc">&nbsp;			removeLog4jBridgeHandler();</b>
&nbsp;		}
<b class="nc">&nbsp;		super.cleanUp();</b>
<b class="nc">&nbsp;		LoggerContext loggerContext = getLoggerContext();</b>
<b class="nc">&nbsp;		markAsUninitialized(loggerContext);</b>
<b class="nc">&nbsp;		loggerContext.getConfiguration().removeFilter(FILTER);</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerConfig getLogger(String name) {
<b class="nc">&nbsp;		boolean isRootLogger = !StringUtils.hasLength(name) || ROOT_LOGGER_NAME.equals(name);</b>
<b class="nc">&nbsp;		return findLogger(isRootLogger ? LogManager.ROOT_LOGGER_NAME : name);</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerConfig findLogger(String name) {
<b class="nc">&nbsp;		Configuration configuration = getLoggerContext().getConfiguration();</b>
<b class="nc">&nbsp;		if (configuration instanceof AbstractConfiguration abstractConfiguration) {</b>
<b class="nc">&nbsp;			return abstractConfiguration.getLogger(name);</b>
&nbsp;		}
<b class="nc">&nbsp;		return configuration.getLoggers().get(name);</b>
&nbsp;	}
&nbsp;
&nbsp;	private LoggerContext getLoggerContext() {
<b class="nc">&nbsp;		return (LoggerContext) LogManager.getContext(false);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isAlreadyInitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		return LoggingSystem.class.getName().equals(loggerContext.getExternalContext());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void markAsInitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		loggerContext.setExternalContext(LoggingSystem.class.getName());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void markAsUninitialized(LoggerContext loggerContext) {
<b class="nc">&nbsp;		loggerContext.setExternalContext(null);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String getDefaultLogCorrelationPattern() {
<b class="nc">&nbsp;		return &quot;%correlationId&quot;;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Get the Spring {@link Environment} attached to the given {@link LoggerContext} or
&nbsp;	 * {@code null} if no environment is available.
&nbsp;	 * @param loggerContext the logger context
&nbsp;	 * @return the Spring {@link Environment} or {@code null}
&nbsp;	 * @since 3.0.0
&nbsp;	 */
&nbsp;	public static Environment getEnvironment(LoggerContext loggerContext) {
<b class="nc">&nbsp;		return (Environment) ((loggerContext != null) ? loggerContext.getObject(ENVIRONMENT_KEY) : null);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link LoggingSystemFactory} that returns {@link Log4J2LoggingSystem} if possible.
&nbsp;	 */
&nbsp;	@Order(Ordered.LOWEST_PRECEDENCE)
<b class="nc">&nbsp;	public static class Factory implements LoggingSystemFactory {</b>
&nbsp;
<b class="nc">&nbsp;		private static final boolean PRESENT = ClassUtils</b>
<b class="nc">&nbsp;			.isPresent(&quot;org.apache.logging.log4j.core.impl.Log4jContextFactory&quot;, Factory.class.getClassLoader());</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public LoggingSystem getLoggingSystem(ClassLoader classLoader) {
<b class="nc">&nbsp;			if (PRESENT) {</b>
<b class="nc">&nbsp;				return new Log4J2LoggingSystem(classLoader);</b>
&nbsp;			}
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link LoggerConfig} used when the user has set a specific {@link Level}.
&nbsp;	 */
&nbsp;	private static class LevelSetLoggerConfig extends LoggerConfig {
&nbsp;
&nbsp;		LevelSetLoggerConfig(String name, Level level, boolean additive) {
<b class="nc">&nbsp;			super(name, level, additive);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-28 21:28</div>
</div>
</body>
</html>
