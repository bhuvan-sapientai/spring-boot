


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SpringBootContextLoader</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.test.context</a>
</div>

<h1>Coverage Summary for Class: SpringBootContextLoader (org.springframework.boot.test.context)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SpringBootContextLoader</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/112)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SpringBootContextLoader$ContextCustomizerAdapter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$ContextLoaderHook</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/25)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$ContextLoaderHook$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$Mode</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$ParentContextApplicationContextInitializer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$PrepareEnvironmentListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$WebConfigurer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">SpringBootContextLoader$WebConfigurer$DefensiveWebApplicationContextInitializer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/171)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2024 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.test.context;
&nbsp;
&nbsp;import java.lang.reflect.Method;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.function.Consumer;
&nbsp;
&nbsp;import org.springframework.beans.BeanUtils;
&nbsp;import org.springframework.boot.ApplicationContextFactory;
&nbsp;import org.springframework.boot.Banner;
&nbsp;import org.springframework.boot.ConfigurableBootstrapContext;
&nbsp;import org.springframework.boot.SpringApplication;
&nbsp;import org.springframework.boot.SpringApplication.AbandonedRunException;
&nbsp;import org.springframework.boot.SpringApplicationHook;
&nbsp;import org.springframework.boot.SpringApplicationRunListener;
&nbsp;import org.springframework.boot.SpringBootConfiguration;
&nbsp;import org.springframework.boot.WebApplicationType;
&nbsp;import org.springframework.boot.context.event.ApplicationEnvironmentPreparedEvent;
&nbsp;import org.springframework.boot.test.context.SpringBootTest.UseMainMethod;
&nbsp;import org.springframework.boot.test.mock.web.SpringBootMockServletContext;
&nbsp;import org.springframework.boot.test.util.TestPropertyValues;
&nbsp;import org.springframework.boot.test.util.TestPropertyValues.Type;
&nbsp;import org.springframework.boot.web.reactive.context.GenericReactiveWebApplicationContext;
&nbsp;import org.springframework.boot.web.servlet.support.ServletContextApplicationContextInitializer;
&nbsp;import org.springframework.context.ApplicationContext;
&nbsp;import org.springframework.context.ApplicationContextInitializer;
&nbsp;import org.springframework.context.ApplicationListener;
&nbsp;import org.springframework.context.ConfigurableApplicationContext;
&nbsp;import org.springframework.context.aot.AotApplicationContextInitializer;
&nbsp;import org.springframework.core.KotlinDetector;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.PriorityOrdered;
&nbsp;import org.springframework.core.SpringVersion;
&nbsp;import org.springframework.core.annotation.MergedAnnotations;
&nbsp;import org.springframework.core.annotation.MergedAnnotations.SearchStrategy;
&nbsp;import org.springframework.core.annotation.Order;
&nbsp;import org.springframework.core.env.ConfigurableEnvironment;
&nbsp;import org.springframework.core.io.DefaultResourceLoader;
&nbsp;import org.springframework.core.io.ResourceLoader;
&nbsp;import org.springframework.test.context.ContextConfigurationAttributes;
&nbsp;import org.springframework.test.context.ContextCustomizer;
&nbsp;import org.springframework.test.context.ContextLoadException;
&nbsp;import org.springframework.test.context.ContextLoader;
&nbsp;import org.springframework.test.context.MergedContextConfiguration;
&nbsp;import org.springframework.test.context.SmartContextLoader;
&nbsp;import org.springframework.test.context.aot.AotContextLoader;
&nbsp;import org.springframework.test.context.support.AbstractContextLoader;
&nbsp;import org.springframework.test.context.support.AnnotationConfigContextLoaderUtils;
&nbsp;import org.springframework.test.context.support.TestPropertySourceUtils;
&nbsp;import org.springframework.test.context.web.WebMergedContextConfiguration;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.ObjectUtils;
&nbsp;import org.springframework.util.ReflectionUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import org.springframework.util.function.ThrowingSupplier;
&nbsp;import org.springframework.web.context.ConfigurableWebApplicationContext;
&nbsp;import org.springframework.web.context.support.GenericWebApplicationContext;
&nbsp;
&nbsp;/**
&nbsp; * A {@link ContextLoader} that can be used to test Spring Boot applications (those that
&nbsp; * normally startup using {@link SpringApplication}). Although this loader can be used
&nbsp; * directly, most test will instead want to use it with
&nbsp; * {@link SpringBootTest @SpringBootTest}.
&nbsp; * &lt;p&gt;
&nbsp; * The loader supports both standard {@link MergedContextConfiguration} as well as
&nbsp; * {@link WebMergedContextConfiguration}. If {@link WebMergedContextConfiguration} is used
&nbsp; * the context will either use a mock servlet environment, or start the full embedded web
&nbsp; * server.
&nbsp; * &lt;p&gt;
&nbsp; * If {@code @ActiveProfiles} are provided in the test class they will be used to create
&nbsp; * the application context.
&nbsp; *
&nbsp; * @author Dave Syer
&nbsp; * @author Phillip Webb
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Madhura Bhave
&nbsp; * @author Scott Frederick
&nbsp; * @since 1.4.0
&nbsp; * @see SpringBootTest
&nbsp; */
<b class="nc">&nbsp;public class SpringBootContextLoader extends AbstractContextLoader implements AotContextLoader {</b>
&nbsp;
<b class="nc">&nbsp;	private static final Consumer&lt;SpringApplication&gt; ALREADY_CONFIGURED = (springApplication) -&gt; {</b>
<b class="nc">&nbsp;	};</b>
&nbsp;
&nbsp;	@Override
&nbsp;	public ApplicationContext loadContext(MergedContextConfiguration mergedConfig) throws Exception {
<b class="nc">&nbsp;		return loadContext(mergedConfig, Mode.STANDARD, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public ApplicationContext loadContextForAotProcessing(MergedContextConfiguration mergedConfig) throws Exception {
<b class="nc">&nbsp;		return loadContext(mergedConfig, Mode.AOT_PROCESSING, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public ApplicationContext loadContextForAotRuntime(MergedContextConfiguration mergedConfig,
&nbsp;			ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; initializer) throws Exception {
<b class="nc">&nbsp;		return loadContext(mergedConfig, Mode.AOT_RUNTIME, initializer);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ApplicationContext loadContext(MergedContextConfiguration mergedConfig, Mode mode,
&nbsp;			ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; initializer) throws Exception {
<b class="nc">&nbsp;		assertHasClassesOrLocations(mergedConfig);</b>
<b class="nc">&nbsp;		SpringBootTestAnnotation annotation = SpringBootTestAnnotation.get(mergedConfig);</b>
<b class="nc">&nbsp;		String[] args = annotation.getArgs();</b>
<b class="nc">&nbsp;		UseMainMethod useMainMethod = annotation.getUseMainMethod();</b>
<b class="nc">&nbsp;		Method mainMethod = getMainMethod(mergedConfig, useMainMethod);</b>
<b class="nc">&nbsp;		if (mainMethod != null) {</b>
<b class="nc">&nbsp;			ContextLoaderHook hook = new ContextLoaderHook(mode, initializer,</b>
<b class="nc">&nbsp;					(application) -&gt; configure(mergedConfig, application));</b>
<b class="nc">&nbsp;			return hook.runMain(() -&gt; ReflectionUtils.invokeMethod(mainMethod, null, new Object[] { args }));</b>
&nbsp;		}
<b class="nc">&nbsp;		SpringApplication application = getSpringApplication();</b>
<b class="nc">&nbsp;		configure(mergedConfig, application);</b>
<b class="nc">&nbsp;		ContextLoaderHook hook = new ContextLoaderHook(mode, initializer, ALREADY_CONFIGURED);</b>
<b class="nc">&nbsp;		return hook.run(() -&gt; application.run(args));</b>
&nbsp;	}
&nbsp;
&nbsp;	private void assertHasClassesOrLocations(MergedContextConfiguration mergedConfig) {
<b class="nc">&nbsp;		boolean hasClasses = !ObjectUtils.isEmpty(mergedConfig.getClasses());</b>
<b class="nc">&nbsp;		boolean hasLocations = !ObjectUtils.isEmpty(mergedConfig.getLocations());</b>
<b class="nc">&nbsp;		Assert.state(hasClasses || hasLocations,</b>
&nbsp;				() -&gt; &quot;No configuration classes or locations found in @SpringApplicationConfiguration. &quot;
&nbsp;						+ &quot;For default configuration detection to work you need Spring 4.0.3 or better (found &quot;
<b class="nc">&nbsp;						+ SpringVersion.getVersion() + &quot;).&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private Method getMainMethod(MergedContextConfiguration mergedConfig, UseMainMethod useMainMethod) {
<b class="nc">&nbsp;		if (useMainMethod == UseMainMethod.NEVER) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		Assert.state(mergedConfig.getParent() == null,</b>
<b class="nc">&nbsp;				() -&gt; &quot;UseMainMethod.%s cannot be used with @ContextHierarchy tests&quot;.formatted(useMainMethod));</b>
<b class="nc">&nbsp;		Class&lt;?&gt; springBootConfiguration = Arrays.stream(mergedConfig.getClasses())</b>
<b class="nc">&nbsp;			.filter(this::isSpringBootConfiguration)</b>
<b class="nc">&nbsp;			.findFirst()</b>
<b class="nc">&nbsp;			.orElse(null);</b>
<b class="nc">&nbsp;		Assert.state(springBootConfiguration != null || useMainMethod == UseMainMethod.WHEN_AVAILABLE,</b>
&nbsp;				&quot;Cannot use main method as no @SpringBootConfiguration-annotated class is available&quot;);
<b class="nc">&nbsp;		Method mainMethod = (springBootConfiguration != null)</b>
<b class="nc">&nbsp;				? ReflectionUtils.findMethod(springBootConfiguration, &quot;main&quot;, String[].class) : null;</b>
<b class="nc">&nbsp;		if (mainMethod == null &amp;&amp; KotlinDetector.isKotlinPresent()) {</b>
&nbsp;			try {
<b class="nc">&nbsp;				Class&lt;?&gt; kotlinClass = ClassUtils.forName(springBootConfiguration.getName() + &quot;Kt&quot;,</b>
<b class="nc">&nbsp;						springBootConfiguration.getClassLoader());</b>
<b class="nc">&nbsp;				mainMethod = ReflectionUtils.findMethod(kotlinClass, &quot;main&quot;, String[].class);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (ClassNotFoundException ex) {</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
<b class="nc">&nbsp;		Assert.state(mainMethod != null || useMainMethod == UseMainMethod.WHEN_AVAILABLE,</b>
<b class="nc">&nbsp;				() -&gt; &quot;Main method not found on &#39;%s&#39;&quot;.formatted(springBootConfiguration.getName()));</b>
<b class="nc">&nbsp;		return mainMethod;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isSpringBootConfiguration(Class&lt;?&gt; candidate) {
<b class="nc">&nbsp;		return MergedAnnotations.from(candidate, SearchStrategy.TYPE_HIERARCHY)</b>
<b class="nc">&nbsp;			.isPresent(SpringBootConfiguration.class);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configure(MergedContextConfiguration mergedConfig, SpringApplication application) {
<b class="nc">&nbsp;		application.setMainApplicationClass(mergedConfig.getTestClass());</b>
<b class="nc">&nbsp;		application.addPrimarySources(Arrays.asList(mergedConfig.getClasses()));</b>
<b class="nc">&nbsp;		application.getSources().addAll(Arrays.asList(mergedConfig.getLocations()));</b>
<b class="nc">&nbsp;		List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers = getInitializers(mergedConfig, application);</b>
<b class="nc">&nbsp;		if (mergedConfig instanceof WebMergedContextConfiguration) {</b>
<b class="nc">&nbsp;			application.setWebApplicationType(WebApplicationType.SERVLET);</b>
<b class="nc">&nbsp;			if (!isEmbeddedWebEnvironment(mergedConfig)) {</b>
<b class="nc">&nbsp;				new WebConfigurer().configure(mergedConfig, initializers);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		else if (mergedConfig instanceof ReactiveWebMergedContextConfiguration) {</b>
<b class="nc">&nbsp;			application.setWebApplicationType(WebApplicationType.REACTIVE);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			application.setWebApplicationType(WebApplicationType.NONE);</b>
&nbsp;		}
<b class="nc">&nbsp;		application.setApplicationContextFactory(getApplicationContextFactory(mergedConfig));</b>
<b class="nc">&nbsp;		if (mergedConfig.getParent() != null) {</b>
<b class="nc">&nbsp;			application.setBannerMode(Banner.Mode.OFF);</b>
&nbsp;		}
<b class="nc">&nbsp;		application.setInitializers(initializers);</b>
<b class="nc">&nbsp;		ConfigurableEnvironment environment = getEnvironment();</b>
<b class="nc">&nbsp;		if (environment != null) {</b>
<b class="nc">&nbsp;			prepareEnvironment(mergedConfig, application, environment, false);</b>
<b class="nc">&nbsp;			application.setEnvironment(environment);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			application.addListeners(new PrepareEnvironmentListener(mergedConfig));</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Return the {@link ApplicationContextFactory} that should be used for the test. By
&nbsp;	 * default this method will return a factory that will create an appropriate
&nbsp;	 * {@link ApplicationContext} for the {@link WebApplicationType}.
&nbsp;	 * @param mergedConfig the merged context configuration
&nbsp;	 * @return the application context factory to use
&nbsp;	 * @since 3.2.0
&nbsp;	 */
&nbsp;	protected ApplicationContextFactory getApplicationContextFactory(MergedContextConfiguration mergedConfig) {
<b class="nc">&nbsp;		return (webApplicationType) -&gt; {</b>
<b class="nc">&nbsp;			if (webApplicationType != WebApplicationType.NONE &amp;&amp; !isEmbeddedWebEnvironment(mergedConfig)) {</b>
<b class="nc">&nbsp;				if (webApplicationType == WebApplicationType.REACTIVE) {</b>
<b class="nc">&nbsp;					return new GenericReactiveWebApplicationContext();</b>
&nbsp;				}
<b class="nc">&nbsp;				if (webApplicationType == WebApplicationType.SERVLET) {</b>
<b class="nc">&nbsp;					return new GenericWebApplicationContext();</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			return ApplicationContextFactory.DEFAULT.create(webApplicationType);</b>
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	private void prepareEnvironment(MergedContextConfiguration mergedConfig, SpringApplication application,
&nbsp;			ConfigurableEnvironment environment, boolean applicationEnvironment) {
<b class="nc">&nbsp;		setActiveProfiles(environment, mergedConfig.getActiveProfiles(), applicationEnvironment);</b>
<b class="nc">&nbsp;		ResourceLoader resourceLoader = (application.getResourceLoader() != null) ? application.getResourceLoader()</b>
<b class="nc">&nbsp;				: new DefaultResourceLoader(null);</b>
<b class="nc">&nbsp;		TestPropertySourceUtils.addPropertySourcesToEnvironment(environment, resourceLoader,</b>
<b class="nc">&nbsp;				mergedConfig.getPropertySourceDescriptors());</b>
<b class="nc">&nbsp;		TestPropertySourceUtils.addInlinedPropertiesToEnvironment(environment, getInlinedProperties(mergedConfig));</b>
&nbsp;	}
&nbsp;
&nbsp;	private void setActiveProfiles(ConfigurableEnvironment environment, String[] profiles,
&nbsp;			boolean applicationEnvironment) {
<b class="nc">&nbsp;		if (ObjectUtils.isEmpty(profiles)) {</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		if (!applicationEnvironment) {</b>
<b class="nc">&nbsp;			environment.setActiveProfiles(profiles);</b>
&nbsp;		}
<b class="nc">&nbsp;		String[] pairs = new String[profiles.length];</b>
<b class="nc">&nbsp;		for (int i = 0; i &lt; profiles.length; i++) {</b>
<b class="nc">&nbsp;			pairs[i] = &quot;spring.profiles.active[&quot; + i + &quot;]=&quot; + profiles[i];</b>
&nbsp;		}
<b class="nc">&nbsp;		TestPropertyValues.of(pairs).applyTo(environment, Type.MAP, &quot;active-test-profiles&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Builds new {@link org.springframework.boot.SpringApplication} instance. This method
&nbsp;	 * is only called when a {@code main} method isn&#39;t being used to create the
&nbsp;	 * {@link SpringApplication}.
&nbsp;	 * @return a {@link SpringApplication} instance
&nbsp;	 */
&nbsp;	protected SpringApplication getSpringApplication() {
<b class="nc">&nbsp;		return new SpringApplication();</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns the {@link ConfigurableEnvironment} instance that should be applied to
&nbsp;	 * {@link SpringApplication} or {@code null} to use the default. You can override this
&nbsp;	 * method if you need a custom environment.
&nbsp;	 * @return a {@link ConfigurableEnvironment} instance
&nbsp;	 */
&nbsp;	protected ConfigurableEnvironment getEnvironment() {
<b class="nc">&nbsp;		return null;</b>
&nbsp;	}
&nbsp;
&nbsp;	protected String[] getInlinedProperties(MergedContextConfiguration mergedConfig) {
<b class="nc">&nbsp;		ArrayList&lt;String&gt; properties = new ArrayList&lt;&gt;();</b>
&nbsp;		// JMX bean names will clash if the same bean is used in multiple contexts
<b class="nc">&nbsp;		properties.add(&quot;spring.jmx.enabled=false&quot;);</b>
<b class="nc">&nbsp;		properties.addAll(Arrays.asList(mergedConfig.getPropertySourceProperties()));</b>
<b class="nc">&nbsp;		return StringUtils.toStringArray(properties);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Return the {@link ApplicationContextInitializer initializers} that will be applied
&nbsp;	 * to the context. By default this method will adapt {@link ContextCustomizer context
&nbsp;	 * customizers}, add {@link SpringApplication#getInitializers() application
&nbsp;	 * initializers} and add
&nbsp;	 * {@link MergedContextConfiguration#getContextInitializerClasses() initializers
&nbsp;	 * specified on the test}.
&nbsp;	 * @param mergedConfig the source context configuration
&nbsp;	 * @param application the application instance
&nbsp;	 * @return the initializers to apply
&nbsp;	 * @since 2.0.0
&nbsp;	 */
&nbsp;	protected List&lt;ApplicationContextInitializer&lt;?&gt;&gt; getInitializers(MergedContextConfiguration mergedConfig,
&nbsp;			SpringApplication application) {
<b class="nc">&nbsp;		List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for (ContextCustomizer contextCustomizer : mergedConfig.getContextCustomizers()) {</b>
<b class="nc">&nbsp;			initializers.add(new ContextCustomizerAdapter(contextCustomizer, mergedConfig));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		initializers.addAll(application.getInitializers());</b>
<b class="nc">&nbsp;		for (Class&lt;? extends ApplicationContextInitializer&lt;?&gt;&gt; initializerClass : mergedConfig</b>
<b class="nc">&nbsp;			.getContextInitializerClasses()) {</b>
<b class="nc">&nbsp;			initializers.add(BeanUtils.instantiateClass(initializerClass));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		if (mergedConfig.getParent() != null) {</b>
<b class="nc">&nbsp;			ApplicationContext parentApplicationContext = mergedConfig.getParentApplicationContext();</b>
<b class="nc">&nbsp;			initializers.add(new ParentContextApplicationContextInitializer(parentApplicationContext));</b>
&nbsp;		}
<b class="nc">&nbsp;		return initializers;</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isEmbeddedWebEnvironment(MergedContextConfiguration mergedConfig) {
<b class="nc">&nbsp;		return SpringBootTestAnnotation.get(mergedConfig).getWebEnvironment().isEmbedded();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void processContextConfiguration(ContextConfigurationAttributes configAttributes) {
<b class="nc">&nbsp;		super.processContextConfiguration(configAttributes);</b>
<b class="nc">&nbsp;		if (!configAttributes.hasResources()) {</b>
<b class="nc">&nbsp;			Class&lt;?&gt;[] defaultConfigClasses = detectDefaultConfigurationClasses(configAttributes.getDeclaringClass());</b>
<b class="nc">&nbsp;			configAttributes.setClasses(defaultConfigClasses);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Detect the default configuration classes for the supplied test class. By default
&nbsp;	 * simply delegates to
&nbsp;	 * {@link AnnotationConfigContextLoaderUtils#detectDefaultConfigurationClasses}.
&nbsp;	 * @param declaringClass the test class that declared {@code @ContextConfiguration}
&nbsp;	 * @return an array of default configuration classes, potentially empty but never
&nbsp;	 * {@code null}
&nbsp;	 * @see AnnotationConfigContextLoaderUtils
&nbsp;	 */
&nbsp;	protected Class&lt;?&gt;[] detectDefaultConfigurationClasses(Class&lt;?&gt; declaringClass) {
<b class="nc">&nbsp;		return AnnotationConfigContextLoaderUtils.detectDefaultConfigurationClasses(declaringClass);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String[] getResourceSuffixes() {
<b class="nc">&nbsp;		return new String[] { &quot;-context.xml&quot;, &quot;Context.groovy&quot; };</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected String getResourceSuffix() {
<b class="nc">&nbsp;		throw new IllegalStateException();</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Modes that the {@link SpringBootContextLoader} can operate.
&nbsp;	 */
<b class="nc">&nbsp;	private enum Mode {</b>
&nbsp;
&nbsp;		/**
&nbsp;		 * Load for regular usage.
&nbsp;		 * @see SmartContextLoader#loadContext
&nbsp;		 */
<b class="nc">&nbsp;		STANDARD,</b>
&nbsp;
&nbsp;		/**
&nbsp;		 * Load for AOT processing.
&nbsp;		 * @see AotContextLoader#loadContextForAotProcessing
&nbsp;		 */
<b class="nc">&nbsp;		AOT_PROCESSING,</b>
&nbsp;
&nbsp;		/**
&nbsp;		 * Load for AOT runtime.
&nbsp;		 * @see AotContextLoader#loadContextForAotRuntime
&nbsp;		 */
<b class="nc">&nbsp;		AOT_RUNTIME</b>
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Inner class to configure {@link WebMergedContextConfiguration}.
&nbsp;	 */
<b class="nc">&nbsp;	private static final class WebConfigurer {</b>
&nbsp;
&nbsp;		void configure(MergedContextConfiguration mergedConfig, List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers) {
<b class="nc">&nbsp;			WebMergedContextConfiguration webMergedConfig = (WebMergedContextConfiguration) mergedConfig;</b>
<b class="nc">&nbsp;			addMockServletContext(initializers, webMergedConfig);</b>
&nbsp;		}
&nbsp;
&nbsp;		private void addMockServletContext(List&lt;ApplicationContextInitializer&lt;?&gt;&gt; initializers,
&nbsp;				WebMergedContextConfiguration webMergedConfig) {
<b class="nc">&nbsp;			SpringBootMockServletContext servletContext = new SpringBootMockServletContext(</b>
<b class="nc">&nbsp;					webMergedConfig.getResourceBasePath());</b>
<b class="nc">&nbsp;			initializers.add(0, new DefensiveWebApplicationContextInitializer(</b>
&nbsp;					new ServletContextApplicationContextInitializer(servletContext, true)));
&nbsp;		}
&nbsp;
&nbsp;		/**
&nbsp;		 * Decorator for {@link ServletContextApplicationContextInitializer} that prevents
&nbsp;		 * a failure when the context type is not as was predicted when the initializer
&nbsp;		 * was registered. This can occur when spring.main.web-application-type is set to
&nbsp;		 * something other than servlet.
&nbsp;		 */
&nbsp;		private static final class DefensiveWebApplicationContextInitializer
&nbsp;				implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
&nbsp;
&nbsp;			private final ServletContextApplicationContextInitializer delegate;
&nbsp;
<b class="nc">&nbsp;			private DefensiveWebApplicationContextInitializer(ServletContextApplicationContextInitializer delegate) {</b>
<b class="nc">&nbsp;				this.delegate = delegate;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public void initialize(ConfigurableApplicationContext applicationContext) {
<b class="nc">&nbsp;				if (applicationContext instanceof ConfigurableWebApplicationContext webApplicationContext) {</b>
<b class="nc">&nbsp;					this.delegate.initialize(webApplicationContext);</b>
&nbsp;				}
&nbsp;			}
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Adapts a {@link ContextCustomizer} to a {@link ApplicationContextInitializer} so
&nbsp;	 * that it can be triggered through {@link SpringApplication}.
&nbsp;	 */
&nbsp;	private static class ContextCustomizerAdapter
&nbsp;			implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
&nbsp;
&nbsp;		private final ContextCustomizer contextCustomizer;
&nbsp;
&nbsp;		private final MergedContextConfiguration mergedConfig;
&nbsp;
<b class="nc">&nbsp;		ContextCustomizerAdapter(ContextCustomizer contextCustomizer, MergedContextConfiguration mergedConfig) {</b>
<b class="nc">&nbsp;			this.contextCustomizer = contextCustomizer;</b>
<b class="nc">&nbsp;			this.mergedConfig = mergedConfig;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void initialize(ConfigurableApplicationContext applicationContext) {
<b class="nc">&nbsp;			this.contextCustomizer.customizeContext(applicationContext, this.mergedConfig);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link ApplicationContextInitializer} used to set the parent context.
&nbsp;	 */
&nbsp;	@Order(Ordered.HIGHEST_PRECEDENCE)
&nbsp;	private static class ParentContextApplicationContextInitializer
&nbsp;			implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
&nbsp;
&nbsp;		private final ApplicationContext parent;
&nbsp;
<b class="nc">&nbsp;		ParentContextApplicationContextInitializer(ApplicationContext parent) {</b>
<b class="nc">&nbsp;			this.parent = parent;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void initialize(ConfigurableApplicationContext applicationContext) {
<b class="nc">&nbsp;			applicationContext.setParent(this.parent);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link ApplicationListener} used to prepare the application created environment.
&nbsp;	 */
&nbsp;	private class PrepareEnvironmentListener
&nbsp;			implements ApplicationListener&lt;ApplicationEnvironmentPreparedEvent&gt;, PriorityOrdered {
&nbsp;
&nbsp;		private final MergedContextConfiguration mergedConfig;
&nbsp;
<b class="nc">&nbsp;		PrepareEnvironmentListener(MergedContextConfiguration mergedConfig) {</b>
<b class="nc">&nbsp;			this.mergedConfig = mergedConfig;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public int getOrder() {
<b class="nc">&nbsp;			return Ordered.HIGHEST_PRECEDENCE;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void onApplicationEvent(ApplicationEnvironmentPreparedEvent event) {
<b class="nc">&nbsp;			prepareEnvironment(this.mergedConfig, event.getSpringApplication(), event.getEnvironment(), true);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link SpringApplicationHook} used to capture {@link ApplicationContext} instances
&nbsp;	 * and to trigger early exit for the {@link Mode#AOT_PROCESSING} mode.
&nbsp;	 */
&nbsp;	private static class ContextLoaderHook implements SpringApplicationHook {
&nbsp;
&nbsp;		private final Mode mode;
&nbsp;
&nbsp;		private final ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; initializer;
&nbsp;
&nbsp;		private final Consumer&lt;SpringApplication&gt; configurer;
&nbsp;
<b class="nc">&nbsp;		private final List&lt;ApplicationContext&gt; contexts = Collections.synchronizedList(new ArrayList&lt;&gt;());</b>
&nbsp;
<b class="nc">&nbsp;		private final List&lt;ApplicationContext&gt; failedContexts = Collections.synchronizedList(new ArrayList&lt;&gt;());</b>
&nbsp;
&nbsp;		ContextLoaderHook(Mode mode, ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; initializer,
<b class="nc">&nbsp;				Consumer&lt;SpringApplication&gt; configurer) {</b>
<b class="nc">&nbsp;			this.mode = mode;</b>
<b class="nc">&nbsp;			this.initializer = initializer;</b>
<b class="nc">&nbsp;			this.configurer = configurer;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public SpringApplicationRunListener getRunListener(SpringApplication application) {
<b class="nc">&nbsp;			return new SpringApplicationRunListener() {</b>
&nbsp;
&nbsp;				@Override
&nbsp;				public void starting(ConfigurableBootstrapContext bootstrapContext) {
<b class="nc">&nbsp;					ContextLoaderHook.this.configurer.accept(application);</b>
<b class="nc">&nbsp;					if (ContextLoaderHook.this.mode == Mode.AOT_RUNTIME) {</b>
<b class="nc">&nbsp;						application.addInitializers(</b>
<b class="nc">&nbsp;								(AotApplicationContextInitializer&lt;?&gt;) ContextLoaderHook.this.initializer::initialize);</b>
&nbsp;					}
&nbsp;				}
&nbsp;
&nbsp;				@Override
&nbsp;				public void contextLoaded(ConfigurableApplicationContext context) {
<b class="nc">&nbsp;					ContextLoaderHook.this.contexts.add(context);</b>
<b class="nc">&nbsp;					if (ContextLoaderHook.this.mode == Mode.AOT_PROCESSING) {</b>
<b class="nc">&nbsp;						throw new AbandonedRunException(context);</b>
&nbsp;					}
&nbsp;				}
&nbsp;
&nbsp;				@Override
&nbsp;				public void failed(ConfigurableApplicationContext context, Throwable exception) {
<b class="nc">&nbsp;					ContextLoaderHook.this.failedContexts.add(context);</b>
&nbsp;				}
&nbsp;
&nbsp;			};
&nbsp;		}
&nbsp;
&nbsp;		private &lt;T&gt; ApplicationContext runMain(Runnable action) throws Exception {
<b class="nc">&nbsp;			return run(() -&gt; {</b>
<b class="nc">&nbsp;				action.run();</b>
<b class="nc">&nbsp;				return null;</b>
&nbsp;			});
&nbsp;		}
&nbsp;
&nbsp;		private ApplicationContext run(ThrowingSupplier&lt;ConfigurableApplicationContext&gt; action) throws Exception {
&nbsp;			try {
<b class="nc">&nbsp;				ConfigurableApplicationContext context = SpringApplication.withHook(this, action);</b>
<b class="nc">&nbsp;				if (context != null) {</b>
<b class="nc">&nbsp;					return context;</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			catch (AbandonedRunException ex) {</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception ex) {</b>
<b class="nc">&nbsp;				if (this.failedContexts.size() == 1) {</b>
<b class="nc">&nbsp;					throw new ContextLoadException(this.failedContexts.get(0), ex);</b>
&nbsp;				}
<b class="nc">&nbsp;				throw ex;</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			List&lt;ApplicationContext&gt; rootContexts = this.contexts.stream()</b>
<b class="nc">&nbsp;				.filter((context) -&gt; context.getParent() == null)</b>
<b class="nc">&nbsp;				.toList();</b>
<b class="nc">&nbsp;			Assert.state(!rootContexts.isEmpty(), &quot;No root application context located&quot;);</b>
<b class="nc">&nbsp;			Assert.state(rootContexts.size() == 1, &quot;No unique root application context located&quot;);</b>
<b class="nc">&nbsp;			return rootContexts.get(0);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
