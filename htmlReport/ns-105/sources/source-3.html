


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ReactiveOAuth2ResourceServerJwkConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.autoconfigure.security.oauth2.resource.reactive</a>
</div>

<h1>Coverage Summary for Class: ReactiveOAuth2ResourceServerJwkConfiguration (org.springframework.boot.autoconfigure.security.oauth2.resource.reactive)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/48)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConverterConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConverterPropertiesCondition</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConverterPropertiesCondition$OnAuthoritiesClaimName</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConverterPropertiesCondition$OnAuthorityPrefix</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$JwtConverterPropertiesCondition$OnPrincipalClaimName</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ReactiveOAuth2ResourceServerJwkConfiguration$WebSecurityConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/71)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2024 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.autoconfigure.security.oauth2.resource.reactive;
&nbsp;
&nbsp;import java.security.KeyFactory;
&nbsp;import java.security.interfaces.RSAPublicKey;
&nbsp;import java.security.spec.X509EncodedKeySpec;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Base64;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;import org.springframework.beans.factory.ObjectProvider;
&nbsp;import org.springframework.boot.autoconfigure.condition.AnyNestedCondition;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.boot.autoconfigure.security.oauth2.resource.IssuerUriCondition;
&nbsp;import org.springframework.boot.autoconfigure.security.oauth2.resource.KeyValueCondition;
&nbsp;import org.springframework.boot.autoconfigure.security.oauth2.resource.OAuth2ResourceServerProperties;
&nbsp;import org.springframework.boot.context.properties.PropertyMapper;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Conditional;
&nbsp;import org.springframework.context.annotation.Configuration;
&nbsp;import org.springframework.security.config.web.server.ServerHttpSecurity;
&nbsp;import org.springframework.security.config.web.server.ServerHttpSecurity.OAuth2ResourceServerSpec;
&nbsp;import org.springframework.security.oauth2.core.DelegatingOAuth2TokenValidator;
&nbsp;import org.springframework.security.oauth2.core.OAuth2TokenValidator;
&nbsp;import org.springframework.security.oauth2.jose.jws.SignatureAlgorithm;
&nbsp;import org.springframework.security.oauth2.jwt.Jwt;
&nbsp;import org.springframework.security.oauth2.jwt.JwtClaimNames;
&nbsp;import org.springframework.security.oauth2.jwt.JwtClaimValidator;
&nbsp;import org.springframework.security.oauth2.jwt.JwtValidators;
&nbsp;import org.springframework.security.oauth2.jwt.NimbusReactiveJwtDecoder;
&nbsp;import org.springframework.security.oauth2.jwt.NimbusReactiveJwtDecoder.JwkSetUriReactiveJwtDecoderBuilder;
&nbsp;import org.springframework.security.oauth2.jwt.ReactiveJwtDecoder;
&nbsp;import org.springframework.security.oauth2.jwt.SupplierReactiveJwtDecoder;
&nbsp;import org.springframework.security.oauth2.server.resource.authentication.JwtGrantedAuthoritiesConverter;
&nbsp;import org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtAuthenticationConverter;
&nbsp;import org.springframework.security.oauth2.server.resource.authentication.ReactiveJwtGrantedAuthoritiesConverterAdapter;
&nbsp;import org.springframework.security.web.server.SecurityWebFilterChain;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;
&nbsp;/**
&nbsp; * Configures a {@link ReactiveJwtDecoder} when a JWK Set URI, OpenID Connect Issuer URI
&nbsp; * or Public Key configuration is available. Also configures a
&nbsp; * {@link SecurityWebFilterChain} if a {@link ReactiveJwtDecoder} bean is found.
&nbsp; *
&nbsp; * @author Madhura Bhave
&nbsp; * @author Artsiom Yudovin
&nbsp; * @author HaiTao Zhang
&nbsp; * @author Anastasiia Losieva
&nbsp; * @author Mushtaq Ahmed
&nbsp; * @author Roman Golovin
&nbsp; * @author Yan Kardziyaka
&nbsp; */
&nbsp;@Configuration(proxyBeanMethods = false)
<b class="nc">&nbsp;class ReactiveOAuth2ResourceServerJwkConfiguration {</b>
&nbsp;
&nbsp;	@Configuration(proxyBeanMethods = false)
&nbsp;	@ConditionalOnMissingBean(ReactiveJwtDecoder.class)
&nbsp;	static class JwtConfiguration {
&nbsp;
&nbsp;		private final OAuth2ResourceServerProperties.Jwt properties;
&nbsp;
&nbsp;		private final List&lt;OAuth2TokenValidator&lt;Jwt&gt;&gt; additionalValidators;
&nbsp;
&nbsp;		JwtConfiguration(OAuth2ResourceServerProperties properties,
<b class="nc">&nbsp;				ObjectProvider&lt;OAuth2TokenValidator&lt;Jwt&gt;&gt; additionalValidators) {</b>
<b class="nc">&nbsp;			this.properties = properties.getJwt();</b>
<b class="nc">&nbsp;			this.additionalValidators = additionalValidators.orderedStream().toList();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnProperty(name = &quot;spring.security.oauth2.resourceserver.jwt.jwk-set-uri&quot;)
&nbsp;		ReactiveJwtDecoder jwtDecoder(ObjectProvider&lt;JwkSetUriReactiveJwtDecoderBuilderCustomizer&gt; customizers) {
<b class="nc">&nbsp;			JwkSetUriReactiveJwtDecoderBuilder builder = NimbusReactiveJwtDecoder</b>
<b class="nc">&nbsp;				.withJwkSetUri(this.properties.getJwkSetUri())</b>
<b class="nc">&nbsp;				.jwsAlgorithms(this::jwsAlgorithms);</b>
<b class="nc">&nbsp;			customizers.orderedStream().forEach((customizer) -&gt; customizer.customize(builder));</b>
<b class="nc">&nbsp;			NimbusReactiveJwtDecoder nimbusReactiveJwtDecoder = builder.build();</b>
<b class="nc">&nbsp;			String issuerUri = this.properties.getIssuerUri();</b>
<b class="nc">&nbsp;			OAuth2TokenValidator&lt;Jwt&gt; defaultValidator = (issuerUri != null)</b>
<b class="nc">&nbsp;					? JwtValidators.createDefaultWithIssuer(issuerUri) : JwtValidators.createDefault();</b>
<b class="nc">&nbsp;			nimbusReactiveJwtDecoder.setJwtValidator(getValidators(defaultValidator));</b>
<b class="nc">&nbsp;			return nimbusReactiveJwtDecoder;</b>
&nbsp;		}
&nbsp;
&nbsp;		private void jwsAlgorithms(Set&lt;SignatureAlgorithm&gt; signatureAlgorithms) {
<b class="nc">&nbsp;			for (String algorithm : this.properties.getJwsAlgorithms()) {</b>
<b class="nc">&nbsp;				signatureAlgorithms.add(SignatureAlgorithm.from(algorithm));</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private OAuth2TokenValidator&lt;Jwt&gt; getValidators(OAuth2TokenValidator&lt;Jwt&gt; defaultValidator) {
<b class="nc">&nbsp;			List&lt;String&gt; audiences = this.properties.getAudiences();</b>
<b class="nc">&nbsp;			if (CollectionUtils.isEmpty(audiences) &amp;&amp; this.additionalValidators.isEmpty()) {</b>
<b class="nc">&nbsp;				return defaultValidator;</b>
&nbsp;			}
<b class="nc">&nbsp;			List&lt;OAuth2TokenValidator&lt;Jwt&gt;&gt; validators = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;			validators.add(defaultValidator);</b>
<b class="nc">&nbsp;			if (!CollectionUtils.isEmpty(audiences)) {</b>
<b class="nc">&nbsp;				validators.add(new JwtClaimValidator&lt;List&lt;String&gt;&gt;(JwtClaimNames.AUD,</b>
<b class="nc">&nbsp;						(aud) -&gt; aud != null &amp;&amp; !Collections.disjoint(aud, audiences)));</b>
&nbsp;			}
<b class="nc">&nbsp;			validators.addAll(this.additionalValidators);</b>
<b class="nc">&nbsp;			return new DelegatingOAuth2TokenValidator&lt;&gt;(validators);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@Conditional(KeyValueCondition.class)
&nbsp;		NimbusReactiveJwtDecoder jwtDecoderByPublicKeyValue() throws Exception {
<b class="nc">&nbsp;			RSAPublicKey publicKey = (RSAPublicKey) KeyFactory.getInstance(&quot;RSA&quot;)</b>
<b class="nc">&nbsp;				.generatePublic(new X509EncodedKeySpec(getKeySpec(this.properties.readPublicKey())));</b>
<b class="nc">&nbsp;			NimbusReactiveJwtDecoder jwtDecoder = NimbusReactiveJwtDecoder.withPublicKey(publicKey)</b>
<b class="nc">&nbsp;				.signatureAlgorithm(SignatureAlgorithm.from(exactlyOneAlgorithm()))</b>
<b class="nc">&nbsp;				.build();</b>
<b class="nc">&nbsp;			jwtDecoder.setJwtValidator(getValidators(JwtValidators.createDefault()));</b>
<b class="nc">&nbsp;			return jwtDecoder;</b>
&nbsp;		}
&nbsp;
&nbsp;		private byte[] getKeySpec(String keyValue) {
<b class="nc">&nbsp;			keyValue = keyValue.replace(&quot;-----BEGIN PUBLIC KEY-----&quot;, &quot;&quot;).replace(&quot;-----END PUBLIC KEY-----&quot;, &quot;&quot;);</b>
<b class="nc">&nbsp;			return Base64.getMimeDecoder().decode(keyValue);</b>
&nbsp;		}
&nbsp;
&nbsp;		private String exactlyOneAlgorithm() {
<b class="nc">&nbsp;			List&lt;String&gt; algorithms = this.properties.getJwsAlgorithms();</b>
<b class="nc">&nbsp;			int count = (algorithms != null) ? algorithms.size() : 0;</b>
<b class="nc">&nbsp;			if (count != 1) {</b>
<b class="nc">&nbsp;				throw new IllegalStateException(</b>
&nbsp;						&quot;Creating a JWT decoder using a public key requires exactly one JWS algorithm but &quot; + count
&nbsp;								+ &quot; were configured&quot;);
&nbsp;			}
<b class="nc">&nbsp;			return algorithms.get(0);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		@Conditional(IssuerUriCondition.class)
&nbsp;		SupplierReactiveJwtDecoder jwtDecoderByIssuerUri(
&nbsp;				ObjectProvider&lt;JwkSetUriReactiveJwtDecoderBuilderCustomizer&gt; customizers) {
<b class="nc">&nbsp;			return new SupplierReactiveJwtDecoder(() -&gt; {</b>
<b class="nc">&nbsp;				JwkSetUriReactiveJwtDecoderBuilder builder = NimbusReactiveJwtDecoder</b>
<b class="nc">&nbsp;					.withIssuerLocation(this.properties.getIssuerUri());</b>
<b class="nc">&nbsp;				customizers.orderedStream().forEach((customizer) -&gt; customizer.customize(builder));</b>
<b class="nc">&nbsp;				NimbusReactiveJwtDecoder jwtDecoder = builder.build();</b>
<b class="nc">&nbsp;				jwtDecoder.setJwtValidator(</b>
<b class="nc">&nbsp;						getValidators(JwtValidators.createDefaultWithIssuer(this.properties.getIssuerUri())));</b>
<b class="nc">&nbsp;				return jwtDecoder;</b>
&nbsp;			});
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Configuration(proxyBeanMethods = false)
&nbsp;	@ConditionalOnMissingBean(ReactiveJwtAuthenticationConverter.class)
&nbsp;	@Conditional(JwtConverterPropertiesCondition.class)
&nbsp;	static class JwtConverterConfiguration {
&nbsp;
&nbsp;		private final OAuth2ResourceServerProperties.Jwt properties;
&nbsp;
<b class="nc">&nbsp;		JwtConverterConfiguration(OAuth2ResourceServerProperties properties) {</b>
<b class="nc">&nbsp;			this.properties = properties.getJwt();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Bean
&nbsp;		ReactiveJwtAuthenticationConverter reactiveJwtAuthenticationConverter() {
<b class="nc">&nbsp;			JwtGrantedAuthoritiesConverter grantedAuthoritiesConverter = new JwtGrantedAuthoritiesConverter();</b>
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			map.from(this.properties.getAuthorityPrefix()).to(grantedAuthoritiesConverter::setAuthorityPrefix);</b>
<b class="nc">&nbsp;			map.from(this.properties.getAuthoritiesClaimDelimiter())</b>
<b class="nc">&nbsp;				.to(grantedAuthoritiesConverter::setAuthoritiesClaimDelimiter);</b>
<b class="nc">&nbsp;			map.from(this.properties.getAuthoritiesClaimName())</b>
<b class="nc">&nbsp;				.to(grantedAuthoritiesConverter::setAuthoritiesClaimName);</b>
<b class="nc">&nbsp;			ReactiveJwtAuthenticationConverter jwtAuthenticationConverter = new ReactiveJwtAuthenticationConverter();</b>
<b class="nc">&nbsp;			map.from(this.properties.getPrincipalClaimName()).to(jwtAuthenticationConverter::setPrincipalClaimName);</b>
<b class="nc">&nbsp;			jwtAuthenticationConverter.setJwtGrantedAuthoritiesConverter(</b>
&nbsp;					new ReactiveJwtGrantedAuthoritiesConverterAdapter(grantedAuthoritiesConverter));
<b class="nc">&nbsp;			return jwtAuthenticationConverter;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	@Configuration(proxyBeanMethods = false)
&nbsp;	@ConditionalOnMissingBean(SecurityWebFilterChain.class)
<b class="nc">&nbsp;	static class WebSecurityConfiguration {</b>
&nbsp;
&nbsp;		@Bean
&nbsp;		@ConditionalOnBean(ReactiveJwtDecoder.class)
&nbsp;		SecurityWebFilterChain springSecurityFilterChain(ServerHttpSecurity http, ReactiveJwtDecoder jwtDecoder) {
<b class="nc">&nbsp;			http.authorizeExchange((exchanges) -&gt; exchanges.anyExchange().authenticated());</b>
<b class="nc">&nbsp;			http.oauth2ResourceServer((server) -&gt; customDecoder(server, jwtDecoder));</b>
<b class="nc">&nbsp;			return http.build();</b>
&nbsp;		}
&nbsp;
&nbsp;		private void customDecoder(OAuth2ResourceServerSpec server, ReactiveJwtDecoder decoder) {
<b class="nc">&nbsp;			server.jwt((jwt) -&gt; jwt.jwtDecoder(decoder));</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private static class JwtConverterPropertiesCondition extends AnyNestedCondition {
&nbsp;
&nbsp;		JwtConverterPropertiesCondition() {
<b class="nc">&nbsp;			super(ConfigurationPhase.REGISTER_BEAN);</b>
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnProperty(prefix = &quot;spring.security.oauth2.resourceserver.jwt&quot;, name = &quot;authority-prefix&quot;)
<b class="nc">&nbsp;		static class OnAuthorityPrefix {</b>
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnProperty(prefix = &quot;spring.security.oauth2.resourceserver.jwt&quot;, name = &quot;principal-claim-name&quot;)
<b class="nc">&nbsp;		static class OnPrincipalClaimName {</b>
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		@ConditionalOnProperty(prefix = &quot;spring.security.oauth2.resourceserver.jwt&quot;, name = &quot;authorities-claim-name&quot;)
<b class="nc">&nbsp;		static class OnAuthoritiesClaimName {</b>
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
