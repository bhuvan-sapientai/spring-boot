


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ApplicationPidFileWriter</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.context</a>
</div>

<h1>Coverage Summary for Class: ApplicationPidFileWriter (org.springframework.boot.context)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ApplicationPidFileWriter</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (6/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    46.7%
  </span>
  <span class="absValue">
    (21/45)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ApplicationPidFileWriter$Property</td>
  </tr>
  <tr>
    <td class="name">ApplicationPidFileWriter$SpringProperty</td>
<td class="coverageStat">
  <span class="percent">
    33.3%
  </span>
  <span class="absValue">
    (1/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    21.4%
  </span>
  <span class="absValue">
    (3/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ApplicationPidFileWriter$SystemProperty</td>
<td class="coverageStat">
  <span class="percent">
    50%
  </span>
  <span class="absValue">
    (1/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    66.7%
  </span>
  <span class="absValue">
    (2/3)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    47.1%
  </span>
  <span class="absValue">
    (8/17)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    41.9%
  </span>
  <span class="absValue">
    (26/62)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2022 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.context;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Locale;
&nbsp;import java.util.concurrent.atomic.AtomicBoolean;
&nbsp;
&nbsp;import org.apache.commons.logging.Log;
&nbsp;import org.apache.commons.logging.LogFactory;
&nbsp;
&nbsp;import org.springframework.boot.context.event.ApplicationEnvironmentPreparedEvent;
&nbsp;import org.springframework.boot.context.event.ApplicationPreparedEvent;
&nbsp;import org.springframework.boot.context.event.ApplicationReadyEvent;
&nbsp;import org.springframework.boot.context.event.SpringApplicationEvent;
&nbsp;import org.springframework.boot.system.ApplicationPid;
&nbsp;import org.springframework.boot.system.SystemProperties;
&nbsp;import org.springframework.context.ApplicationListener;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.env.Environment;
&nbsp;import org.springframework.util.Assert;
&nbsp;
&nbsp;/**
&nbsp; * An {@link ApplicationListener} that saves application PID into file. This application
&nbsp; * listener will be triggered exactly once per JVM, and the file name can be overridden at
&nbsp; * runtime with a System property or environment variable named &quot;PIDFILE&quot; (or &quot;pidfile&quot;)
&nbsp; * or using a {@code spring.pid.file} property in the Spring {@link Environment}.
&nbsp; * &lt;p&gt;
&nbsp; * If PID file can not be created no exception is reported. This behavior can be changed
&nbsp; * by assigning {@code true} to System property or environment variable named
&nbsp; * {@code PID_FAIL_ON_WRITE_ERROR} (or &quot;pid_fail_on_write_error&quot;) or to
&nbsp; * {@code spring.pid.fail-on-write-error} property in the Spring {@link Environment}.
&nbsp; * &lt;p&gt;
&nbsp; * Note: access to the Spring {@link Environment} is only possible when the
&nbsp; * {@link #setTriggerEventType(Class) triggerEventType} is set to
&nbsp; * {@link ApplicationEnvironmentPreparedEvent}, {@link ApplicationReadyEvent}, or
&nbsp; * {@link ApplicationPreparedEvent}.
&nbsp; *
&nbsp; * @author Jakub Kubrynski
&nbsp; * @author Dave Syer
&nbsp; * @author Phillip Webb
&nbsp; * @author Tomasz Przybyla
&nbsp; * @author Madhura Bhave
&nbsp; * @since 2.0.0
&nbsp; */
&nbsp;public class ApplicationPidFileWriter implements ApplicationListener&lt;SpringApplicationEvent&gt;, Ordered {
&nbsp;
<b class="fc">&nbsp;	private static final Log logger = LogFactory.getLog(ApplicationPidFileWriter.class);</b>
&nbsp;
&nbsp;	private static final String DEFAULT_FILE_NAME = &quot;application.pid&quot;;
&nbsp;
&nbsp;	private static final List&lt;Property&gt; FILE_PROPERTIES;
&nbsp;
&nbsp;	static {
<b class="fc">&nbsp;		List&lt;Property&gt; properties = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;		properties.add(new SpringProperty(&quot;spring.pid.&quot;, &quot;file&quot;));</b>
<b class="fc">&nbsp;		properties.add(new SpringProperty(&quot;spring.&quot;, &quot;pidfile&quot;));</b>
<b class="fc">&nbsp;		properties.add(new SystemProperty(&quot;PIDFILE&quot;));</b>
<b class="fc">&nbsp;		FILE_PROPERTIES = Collections.unmodifiableList(properties);</b>
&nbsp;	}
&nbsp;
&nbsp;	private static final List&lt;Property&gt; FAIL_ON_WRITE_ERROR_PROPERTIES;
&nbsp;
&nbsp;	static {
<b class="fc">&nbsp;		List&lt;Property&gt; properties = new ArrayList&lt;&gt;();</b>
<b class="fc">&nbsp;		properties.add(new SpringProperty(&quot;spring.pid.&quot;, &quot;fail-on-write-error&quot;));</b>
<b class="fc">&nbsp;		properties.add(new SystemProperty(&quot;PID_FAIL_ON_WRITE_ERROR&quot;));</b>
<b class="fc">&nbsp;		FAIL_ON_WRITE_ERROR_PROPERTIES = Collections.unmodifiableList(properties);</b>
&nbsp;	}
&nbsp;
<b class="fc">&nbsp;	private static final AtomicBoolean created = new AtomicBoolean();</b>
&nbsp;
<b class="fc">&nbsp;	private int order = Ordered.HIGHEST_PRECEDENCE + 13;</b>
&nbsp;
&nbsp;	private final File file;
&nbsp;
<b class="fc">&nbsp;	private Class&lt;? extends SpringApplicationEvent&gt; triggerEventType = ApplicationPreparedEvent.class;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link ApplicationPidFileWriter} instance using the filename
&nbsp;	 * &#39;application.pid&#39;.
&nbsp;	 */
&nbsp;	public ApplicationPidFileWriter() {
<b class="nc">&nbsp;		this(new File(DEFAULT_FILE_NAME));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link ApplicationPidFileWriter} instance with a specified filename.
&nbsp;	 * @param filename the name of file containing pid
&nbsp;	 */
&nbsp;	public ApplicationPidFileWriter(String filename) {
<b class="fc">&nbsp;		this(new File(filename));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link ApplicationPidFileWriter} instance with a specified file.
&nbsp;	 * @param file the file containing pid
&nbsp;	 */
<b class="fc">&nbsp;	public ApplicationPidFileWriter(File file) {</b>
<b class="fc">&nbsp;		Assert.notNull(file, &quot;File must not be null&quot;);</b>
<b class="fc">&nbsp;		this.file = file;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Sets the type of application event that will trigger writing of the PID file.
&nbsp;	 * Defaults to {@link ApplicationPreparedEvent}. NOTE: If you use the
&nbsp;	 * {@link org.springframework.boot.context.event.ApplicationStartingEvent} to trigger
&nbsp;	 * the write, you will not be able to specify the PID filename in the Spring
&nbsp;	 * {@link Environment}.
&nbsp;	 * @param triggerEventType the trigger event type
&nbsp;	 */
&nbsp;	public void setTriggerEventType(Class&lt;? extends SpringApplicationEvent&gt; triggerEventType) {
<b class="fc">&nbsp;		Assert.notNull(triggerEventType, &quot;Trigger event type must not be null&quot;);</b>
<b class="fc">&nbsp;		this.triggerEventType = triggerEventType;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void onApplicationEvent(SpringApplicationEvent event) {
<b class="fc">&nbsp;		if (this.triggerEventType.isInstance(event) &amp;&amp; created.compareAndSet(false, true)) {</b>
&nbsp;			try {
<b class="nc">&nbsp;				writePidFile(event);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception ex) {</b>
<b class="nc">&nbsp;				String message = String.format(&quot;Cannot create pid file %s&quot;, this.file);</b>
<b class="nc">&nbsp;				if (failOnWriteError(event)) {</b>
<b class="nc">&nbsp;					throw new IllegalStateException(message, ex);</b>
&nbsp;				}
<b class="nc">&nbsp;				logger.warn(message, ex);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void writePidFile(SpringApplicationEvent event) throws IOException {
<b class="nc">&nbsp;		File pidFile = this.file;</b>
<b class="nc">&nbsp;		String override = getProperty(event, FILE_PROPERTIES);</b>
<b class="nc">&nbsp;		if (override != null) {</b>
<b class="nc">&nbsp;			pidFile = new File(override);</b>
&nbsp;		}
<b class="nc">&nbsp;		new ApplicationPid().write(pidFile);</b>
<b class="nc">&nbsp;		pidFile.deleteOnExit();</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean failOnWriteError(SpringApplicationEvent event) {
<b class="nc">&nbsp;		String value = getProperty(event, FAIL_ON_WRITE_ERROR_PROPERTIES);</b>
<b class="nc">&nbsp;		return Boolean.parseBoolean(value);</b>
&nbsp;	}
&nbsp;
&nbsp;	private String getProperty(SpringApplicationEvent event, List&lt;Property&gt; candidates) {
<b class="nc">&nbsp;		for (Property candidate : candidates) {</b>
<b class="nc">&nbsp;			String value = candidate.getValue(event);</b>
<b class="nc">&nbsp;			if (value != null) {</b>
<b class="nc">&nbsp;				return value;</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return null;</b>
&nbsp;	}
&nbsp;
&nbsp;	public void setOrder(int order) {
<b class="nc">&nbsp;		this.order = order;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public int getOrder() {
<b class="nc">&nbsp;		return this.order;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Reset the created flag for testing purposes.
&nbsp;	 */
&nbsp;	protected static void reset() {
<b class="fc">&nbsp;		created.set(false);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Provides access to a property value.
&nbsp;	 */
&nbsp;	private interface Property {
&nbsp;
&nbsp;		String getValue(SpringApplicationEvent event);
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link Property} obtained from Spring&#39;s {@link Environment}.
&nbsp;	 */
&nbsp;	private static class SpringProperty implements Property {
&nbsp;
&nbsp;		private final String prefix;
&nbsp;
&nbsp;		private final String key;
&nbsp;
<b class="fc">&nbsp;		SpringProperty(String prefix, String key) {</b>
<b class="fc">&nbsp;			this.prefix = prefix;</b>
<b class="fc">&nbsp;			this.key = key;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getValue(SpringApplicationEvent event) {
<b class="nc">&nbsp;			Environment environment = getEnvironment(event);</b>
<b class="nc">&nbsp;			if (environment == null) {</b>
<b class="nc">&nbsp;				return null;</b>
&nbsp;			}
<b class="nc">&nbsp;			return environment.getProperty(this.prefix + this.key);</b>
&nbsp;		}
&nbsp;
&nbsp;		private Environment getEnvironment(SpringApplicationEvent event) {
<b class="nc">&nbsp;			if (event instanceof ApplicationEnvironmentPreparedEvent environmentPreparedEvent) {</b>
<b class="nc">&nbsp;				return environmentPreparedEvent.getEnvironment();</b>
&nbsp;			}
<b class="nc">&nbsp;			if (event instanceof ApplicationPreparedEvent preparedEvent) {</b>
<b class="nc">&nbsp;				return preparedEvent.getApplicationContext().getEnvironment();</b>
&nbsp;			}
<b class="nc">&nbsp;			if (event instanceof ApplicationReadyEvent readyEvent) {</b>
<b class="nc">&nbsp;				return readyEvent.getApplicationContext().getEnvironment();</b>
&nbsp;			}
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link Property} obtained from {@link SystemProperties}.
&nbsp;	 */
&nbsp;	private static class SystemProperty implements Property {
&nbsp;
&nbsp;		private final String[] properties;
&nbsp;
<b class="fc">&nbsp;		SystemProperty(String name) {</b>
<b class="fc">&nbsp;			this.properties = new String[] { name.toUpperCase(Locale.ENGLISH), name.toLowerCase(Locale.ENGLISH) };</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getValue(SpringApplicationEvent event) {
<b class="nc">&nbsp;			return SystemProperties.get(this.properties);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
