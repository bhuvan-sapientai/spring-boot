


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CustomLayersProvider</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.maven</a>
</div>

<h1>Coverage Summary for Class: CustomLayersProvider (org.springframework.boot.maven)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CustomLayersProvider</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/67)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.maven;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.function.Function;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import javax.xml.XMLConstants;
&nbsp;import javax.xml.transform.dom.DOMSource;
&nbsp;import javax.xml.validation.Schema;
&nbsp;import javax.xml.validation.SchemaFactory;
&nbsp;import javax.xml.validation.Validator;
&nbsp;
&nbsp;import org.w3c.dom.Document;
&nbsp;import org.w3c.dom.Element;
&nbsp;import org.w3c.dom.Node;
&nbsp;import org.w3c.dom.NodeList;
&nbsp;import org.xml.sax.SAXException;
&nbsp;
&nbsp;import org.springframework.boot.loader.tools.Layer;
&nbsp;import org.springframework.boot.loader.tools.Library;
&nbsp;import org.springframework.boot.loader.tools.layer.ApplicationContentFilter;
&nbsp;import org.springframework.boot.loader.tools.layer.ContentFilter;
&nbsp;import org.springframework.boot.loader.tools.layer.ContentSelector;
&nbsp;import org.springframework.boot.loader.tools.layer.CustomLayers;
&nbsp;import org.springframework.boot.loader.tools.layer.IncludeExcludeContentSelector;
&nbsp;import org.springframework.boot.loader.tools.layer.LibraryContentFilter;
&nbsp;
&nbsp;/**
&nbsp; * Produces a {@link CustomLayers} based on the given {@link Document}.
&nbsp; *
&nbsp; * @author Madhura Bhave
&nbsp; * @author Phillip Webb
&nbsp; */
<b class="nc">&nbsp;class CustomLayersProvider {</b>
&nbsp;
&nbsp;	CustomLayers getLayers(Document document) {
<b class="nc">&nbsp;		validate(document);</b>
<b class="nc">&nbsp;		Element root = document.getDocumentElement();</b>
<b class="nc">&nbsp;		List&lt;ContentSelector&lt;String&gt;&gt; applicationSelectors = getApplicationSelectors(root);</b>
<b class="nc">&nbsp;		List&lt;ContentSelector&lt;Library&gt;&gt; librarySelectors = getLibrarySelectors(root);</b>
<b class="nc">&nbsp;		List&lt;Layer&gt; layers = getLayers(root);</b>
<b class="nc">&nbsp;		return new CustomLayers(layers, applicationSelectors, librarySelectors);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void validate(Document document) {
<b class="nc">&nbsp;		Schema schema = loadSchema();</b>
&nbsp;		try {
<b class="nc">&nbsp;			Validator validator = schema.newValidator();</b>
<b class="nc">&nbsp;			validator.validate(new DOMSource(document));</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (SAXException | IOException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Invalid layers.xml configuration&quot;, ex);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private Schema loadSchema() {
&nbsp;		try {
<b class="nc">&nbsp;			SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</b>
<b class="nc">&nbsp;			return factory.newSchema(getClass().getResource(&quot;layers.xsd&quot;));</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (SAXException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Unable to load layers XSD&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;ContentSelector&lt;String&gt;&gt; getApplicationSelectors(Element root) {
<b class="nc">&nbsp;		return getSelectors(root, &quot;application&quot;, (element) -&gt; getSelector(element, ApplicationContentFilter::new));</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;ContentSelector&lt;Library&gt;&gt; getLibrarySelectors(Element root) {
<b class="nc">&nbsp;		return getSelectors(root, &quot;dependencies&quot;, (element) -&gt; getLibrarySelector(element, LibraryContentFilter::new));</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;Layer&gt; getLayers(Element root) {
<b class="nc">&nbsp;		Element layerOrder = getChildElement(root, &quot;layerOrder&quot;);</b>
<b class="nc">&nbsp;		if (layerOrder == null) {</b>
<b class="nc">&nbsp;			return Collections.emptyList();</b>
&nbsp;		}
<b class="nc">&nbsp;		return getChildNodeTextContent(layerOrder, &quot;layer&quot;).stream().map(Layer::new).toList();</b>
&nbsp;	}
&nbsp;
&nbsp;	private &lt;T&gt; List&lt;ContentSelector&lt;T&gt;&gt; getSelectors(Element root, String elementName,
&nbsp;			Function&lt;Element, ContentSelector&lt;T&gt;&gt; selectorFactory) {
<b class="nc">&nbsp;		Element element = getChildElement(root, elementName);</b>
<b class="nc">&nbsp;		if (element == null) {</b>
<b class="nc">&nbsp;			return Collections.emptyList();</b>
&nbsp;		}
<b class="nc">&nbsp;		List&lt;ContentSelector&lt;T&gt;&gt; selectors = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		NodeList children = element.getChildNodes();</b>
<b class="nc">&nbsp;		for (int i = 0; i &lt; children.getLength(); i++) {</b>
<b class="nc">&nbsp;			Node child = children.item(i);</b>
<b class="nc">&nbsp;			if (child instanceof Element childElement) {</b>
<b class="nc">&nbsp;				ContentSelector&lt;T&gt; selector = selectorFactory.apply(childElement);</b>
<b class="nc">&nbsp;				selectors.add(selector);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		return selectors;</b>
&nbsp;	}
&nbsp;
&nbsp;	private &lt;T&gt; ContentSelector&lt;T&gt; getSelector(Element element, Function&lt;String, ContentFilter&lt;T&gt;&gt; filterFactory) {
<b class="nc">&nbsp;		Layer layer = new Layer(element.getAttribute(&quot;layer&quot;));</b>
<b class="nc">&nbsp;		List&lt;String&gt; includes = getChildNodeTextContent(element, &quot;include&quot;);</b>
<b class="nc">&nbsp;		List&lt;String&gt; excludes = getChildNodeTextContent(element, &quot;exclude&quot;);</b>
<b class="nc">&nbsp;		return new IncludeExcludeContentSelector&lt;&gt;(layer, includes, excludes, filterFactory);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ContentSelector&lt;Library&gt; getLibrarySelector(Element element,
&nbsp;			Function&lt;String, ContentFilter&lt;Library&gt;&gt; filterFactory) {
<b class="nc">&nbsp;		Layer layer = new Layer(element.getAttribute(&quot;layer&quot;));</b>
<b class="nc">&nbsp;		List&lt;String&gt; includes = getChildNodeTextContent(element, &quot;include&quot;);</b>
<b class="nc">&nbsp;		List&lt;String&gt; excludes = getChildNodeTextContent(element, &quot;exclude&quot;);</b>
<b class="nc">&nbsp;		Element includeModuleDependencies = getChildElement(element, &quot;includeModuleDependencies&quot;);</b>
<b class="nc">&nbsp;		Element excludeModuleDependencies = getChildElement(element, &quot;excludeModuleDependencies&quot;);</b>
<b class="nc">&nbsp;		List&lt;ContentFilter&lt;Library&gt;&gt; includeFilters = includes.stream()</b>
<b class="nc">&nbsp;			.map(filterFactory)</b>
<b class="nc">&nbsp;			.collect(Collectors.toCollection(ArrayList::new));</b>
<b class="nc">&nbsp;		if (includeModuleDependencies != null) {</b>
<b class="nc">&nbsp;			includeFilters.add(Library::isLocal);</b>
&nbsp;		}
<b class="nc">&nbsp;		List&lt;ContentFilter&lt;Library&gt;&gt; excludeFilters = excludes.stream()</b>
<b class="nc">&nbsp;			.map(filterFactory)</b>
<b class="nc">&nbsp;			.collect(Collectors.toCollection(ArrayList::new));</b>
<b class="nc">&nbsp;		if (excludeModuleDependencies != null) {</b>
<b class="nc">&nbsp;			excludeFilters.add(Library::isLocal);</b>
&nbsp;		}
<b class="nc">&nbsp;		return new IncludeExcludeContentSelector&lt;&gt;(layer, includeFilters, excludeFilters);</b>
&nbsp;	}
&nbsp;
&nbsp;	private List&lt;String&gt; getChildNodeTextContent(Element element, String tagName) {
<b class="nc">&nbsp;		List&lt;String&gt; patterns = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		NodeList nodes = element.getElementsByTagName(tagName);</b>
<b class="nc">&nbsp;		for (int i = 0; i &lt; nodes.getLength(); i++) {</b>
<b class="nc">&nbsp;			Node node = nodes.item(i);</b>
<b class="nc">&nbsp;			if (node instanceof Element) {</b>
<b class="nc">&nbsp;				patterns.add(node.getTextContent());</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		return patterns;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Element getChildElement(Element element, String tagName) {
<b class="nc">&nbsp;		NodeList nodes = element.getElementsByTagName(tagName);</b>
<b class="nc">&nbsp;		if (nodes.getLength() == 0) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (nodes.getLength() &gt; 1) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Multiple &#39;&quot; + tagName + &quot;&#39; nodes found&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		return (Element) nodes.item(0);</b>
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
