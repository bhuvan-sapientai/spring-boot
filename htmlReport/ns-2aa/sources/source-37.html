


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > WarIntegrationTests</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.maven</a>
</div>

<h1>Coverage Summary for Class: WarIntegrationTests (org.springframework.boot.maven)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WarIntegrationTests</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/117)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.maven;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.TimeZone;
&nbsp;import java.util.concurrent.atomic.AtomicReference;
&nbsp;import java.util.jar.JarFile;
&nbsp;
&nbsp;import org.junit.jupiter.api.TestTemplate;
&nbsp;import org.junit.jupiter.api.extension.ExtendWith;
&nbsp;
&nbsp;import org.springframework.boot.loader.tools.FileUtils;
&nbsp;import org.springframework.boot.loader.tools.JarModeLibrary;
&nbsp;import org.springframework.util.FileSystemUtils;
&nbsp;
&nbsp;import static org.assertj.core.api.Assertions.assertThat;
&nbsp;
&nbsp;/**
&nbsp; * Integration tests for the Maven plugin&#39;s war support.
&nbsp; *
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Scott Frederick
&nbsp; */
&nbsp;@ExtendWith(MavenBuildExtension.class)
<b class="nc">&nbsp;class WarIntegrationTests extends AbstractArchiveIntegrationTests {</b>
&nbsp;
&nbsp;	@Override
&nbsp;	protected String getLayersIndexLocation() {
<b class="nc">&nbsp;		return &quot;WEB-INF/layers.idx&quot;;</b>
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void warRepackaging(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war&quot;)</b>
<b class="nc">&nbsp;			.execute((project) -&gt; assertThat(jar(new File(project, &quot;target/war-0.0.1.BUILD-SNAPSHOT.war&quot;)))</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-context&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-core&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-jcl&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib-provided/jakarta.servlet-api-6&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithName(&quot;org/springframework/boot/loader/launch/WarLauncher.class&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithName(&quot;WEB-INF/classes/org/test/SampleApplication.class&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithName(&quot;index.html&quot;)</b>
<b class="nc">&nbsp;				.manifest((manifest) -&gt; manifest.hasMainClass(&quot;org.springframework.boot.loader.launch.WarLauncher&quot;)</b>
<b class="nc">&nbsp;					.hasStartClass(&quot;org.test.SampleApplication&quot;)</b>
<b class="nc">&nbsp;					.hasAttribute(&quot;Not-Used&quot;, &quot;Foo&quot;)));</b>
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void jarDependencyWithCustomFinalNameBuiltInSameReactorIsPackagedUsingArtifactIdAndVersion(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-reactor&quot;)</b>
<b class="nc">&nbsp;			.execute(((project) -&gt; assertThat(jar(new File(project, &quot;war/target/war-0.0.1.BUILD-SNAPSHOT.war&quot;)))</b>
<b class="nc">&nbsp;				.hasEntryWithName(&quot;WEB-INF/lib/jar-0.0.1.BUILD-SNAPSHOT.jar&quot;)</b>
<b class="nc">&nbsp;				.doesNotHaveEntryWithName(&quot;WEB-INF/lib/jar.jar&quot;)));</b>
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenRequiresUnpackConfigurationIsProvidedItIsReflectedInTheRepackagedWar(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-with-unpack&quot;)</b>
<b class="nc">&nbsp;			.execute((project) -&gt; assertThat(jar(new File(project, &quot;target/war-with-unpack-0.0.1.BUILD-SNAPSHOT.war&quot;)))</b>
<b class="nc">&nbsp;				.hasUnpackEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-core-&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-context-&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-jcl-&quot;));</b>
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenWarIsRepackagedWithOutputTimestampConfiguredThenWarIsReproducible(MavenBuild mavenBuild)
&nbsp;			throws InterruptedException {
<b class="nc">&nbsp;		String firstHash = buildWarWithOutputTimestamp(mavenBuild);</b>
<b class="nc">&nbsp;		Thread.sleep(1500);</b>
<b class="nc">&nbsp;		String secondHash = buildWarWithOutputTimestamp(mavenBuild);</b>
<b class="nc">&nbsp;		assertThat(firstHash).isEqualTo(secondHash);</b>
&nbsp;	}
&nbsp;
&nbsp;	private String buildWarWithOutputTimestamp(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		AtomicReference&lt;String&gt; warHash = new AtomicReference&lt;&gt;();</b>
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-output-timestamp&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;target/war-output-timestamp-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(repackaged).isFile();</b>
<b class="nc">&nbsp;			long expectedModified = 1584352800000L;</b>
<b class="nc">&nbsp;			assertThat(repackaged.lastModified()).isEqualTo(expectedModified);</b>
<b class="nc">&nbsp;			long offsetExpectedModified = expectedModified - TimeZone.getDefault().getOffset(expectedModified);</b>
<b class="nc">&nbsp;			try (JarFile jar = new JarFile(repackaged)) {</b>
<b class="nc">&nbsp;				List&lt;String&gt; unreproducibleEntries = jar.stream()</b>
<b class="nc">&nbsp;					.filter((entry) -&gt; entry.getLastModifiedTime().toMillis() != offsetExpectedModified)</b>
<b class="nc">&nbsp;					.map((entry) -&gt; entry.getName() + &quot;: &quot; + entry.getLastModifiedTime())</b>
<b class="nc">&nbsp;					.toList();</b>
<b class="nc">&nbsp;				assertThat(unreproducibleEntries).isEmpty();</b>
<b class="nc">&nbsp;				warHash.set(FileUtils.sha1Hash(repackaged));</b>
<b class="nc">&nbsp;				FileSystemUtils.deleteRecursively(project);</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			catch (IOException ex) {</b>
<b class="nc">&nbsp;				throw new RuntimeException(ex);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		});
<b class="nc">&nbsp;		return warHash.get();</b>
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenWarIsRepackagedWithOutputTimestampConfiguredThenLibrariesAreSorted(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-output-timestamp&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;target/war-output-timestamp-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			List&lt;String&gt; sortedLibs = Arrays.asList(</b>
&nbsp;					// these libraries are copied from the original war, sorted when
&nbsp;					// packaged by Maven
&nbsp;					&quot;WEB-INF/lib/micrometer-commons&quot;, &quot;WEB-INF/lib/micrometer-observation&quot;, &quot;WEB-INF/lib/spring-aop&quot;,
&nbsp;					&quot;WEB-INF/lib/spring-beans&quot;, &quot;WEB-INF/lib/spring-context&quot;, &quot;WEB-INF/lib/spring-core&quot;,
&nbsp;					&quot;WEB-INF/lib/spring-expression&quot;, &quot;WEB-INF/lib/spring-jcl&quot;,
&nbsp;					// these libraries are contributed by Spring Boot repackaging, and
&nbsp;					// sorted separately
&nbsp;					&quot;WEB-INF/lib/spring-boot-jarmode-layertools&quot;);
<b class="nc">&nbsp;			assertThat(jar(repackaged)).entryNamesInPath(&quot;WEB-INF/lib/&quot;)</b>
<b class="nc">&nbsp;				.zipSatisfy(sortedLibs,</b>
<b class="nc">&nbsp;						(String jarLib, String expectedLib) -&gt; assertThat(jarLib).startsWith(expectedLib));</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenADependencyHasSystemScopeAndInclusionOfSystemScopeDependenciesIsEnabledItIsIncludedInTheRepackagedJar(
&nbsp;			MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-system-scope&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File main = new File(project, &quot;target/war-system-scope-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(main)).hasEntryWithName(&quot;WEB-INF/lib-provided/sample-1.0.0.jar&quot;);</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void repackagedWarContainsTheLayersIndexByDefault(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-layered&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;war/target/war-layered-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged)).hasEntryWithNameStartingWith(&quot;WEB-INF/classes/&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-release&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-snapshot&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(</b>
<b class="nc">&nbsp;						&quot;WEB-INF/lib/&quot; + JarModeLibrary.LAYER_TOOLS.getCoordinates().getArtifactId());</b>
<b class="nc">&nbsp;			try (JarFile jarFile = new JarFile(repackaged)) {</b>
<b class="nc">&nbsp;				Map&lt;String, List&lt;String&gt;&gt; layerIndex = readLayerIndex(jarFile);</b>
<b class="nc">&nbsp;				assertThat(layerIndex.keySet()).containsExactly(&quot;dependencies&quot;, &quot;spring-boot-loader&quot;,</b>
&nbsp;						&quot;snapshot-dependencies&quot;, &quot;application&quot;);
<b class="nc">&nbsp;				List&lt;String&gt; dependenciesAndSnapshotDependencies = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;				dependenciesAndSnapshotDependencies.addAll(layerIndex.get(&quot;dependencies&quot;));</b>
<b class="nc">&nbsp;				dependenciesAndSnapshotDependencies.addAll(layerIndex.get(&quot;snapshot-dependencies&quot;));</b>
<b class="nc">&nbsp;				assertThat(layerIndex.get(&quot;application&quot;)).contains(&quot;WEB-INF/lib/jar-release-0.0.1.RELEASE.jar&quot;,</b>
&nbsp;						&quot;WEB-INF/lib/jar-snapshot-0.0.1.BUILD-SNAPSHOT.jar&quot;);
<b class="nc">&nbsp;				assertThat(dependenciesAndSnapshotDependencies)</b>
<b class="nc">&nbsp;					.anyMatch((dependency) -&gt; dependency.startsWith(&quot;WEB-INF/lib/spring-context&quot;));</b>
<b class="nc">&nbsp;				assertThat(layerIndex.get(&quot;dependencies&quot;))</b>
<b class="nc">&nbsp;					.anyMatch((dependency) -&gt; dependency.startsWith(&quot;WEB-INF/lib-provided/&quot;));</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			catch (IOException ex) {</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenWarIsRepackagedWithTheLayersDisabledDoesNotContainLayersIndex(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-layered-disabled&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;war/target/war-layered-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged)).hasEntryWithNameStartingWith(&quot;WEB-INF/classes/&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-release&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-snapshot&quot;)</b>
<b class="nc">&nbsp;				.doesNotHaveEntryWithName(&quot;WEB-INF/layers.idx&quot;)</b>
<b class="nc">&nbsp;				.doesNotHaveEntryWithNameStartingWith(&quot;WEB-INF/lib/&quot; + JarModeLibrary.LAYER_TOOLS.getName());</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenWarIsRepackagedWithTheLayersEnabledAndLayerToolsExcluded(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-layered-no-layer-tools&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;war/target/war-layered-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged)).hasEntryWithNameStartingWith(&quot;WEB-INF/classes/&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-release&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-snapshot&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/layers.idx&quot;)</b>
<b class="nc">&nbsp;				.doesNotHaveEntryWithNameStartingWith(&quot;WEB-INF/lib/&quot; + JarModeLibrary.LAYER_TOOLS.getName());</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenWarIsRepackagedWithTheCustomLayers(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-layered-custom&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;war/target/war-layered-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged)).hasEntryWithNameStartingWith(&quot;WEB-INF/classes/&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-release&quot;)</b>
<b class="nc">&nbsp;				.hasEntryWithNameStartingWith(&quot;WEB-INF/lib/jar-snapshot&quot;);</b>
<b class="nc">&nbsp;			try (JarFile jarFile = new JarFile(repackaged)) {</b>
<b class="nc">&nbsp;				Map&lt;String, List&lt;String&gt;&gt; layerIndex = readLayerIndex(jarFile);</b>
<b class="nc">&nbsp;				assertThat(layerIndex.keySet()).containsExactly(&quot;my-dependencies-name&quot;, &quot;snapshot-dependencies&quot;,</b>
&nbsp;						&quot;configuration&quot;, &quot;application&quot;);
<b class="nc">&nbsp;				assertThat(layerIndex.get(&quot;application&quot;))</b>
<b class="nc">&nbsp;					.contains(&quot;WEB-INF/lib/jar-release-0.0.1.RELEASE.jar&quot;,</b>
&nbsp;							&quot;WEB-INF/lib/jar-snapshot-0.0.1.BUILD-SNAPSHOT.jar&quot;,
&nbsp;							&quot;WEB-INF/lib/jar-classifier-0.0.1-bravo.jar&quot;)
<b class="nc">&nbsp;					.doesNotContain(&quot;WEB-INF/lib/jar-classifier-0.0.1-alpha.jar&quot;);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void repackagedWarContainsClasspathIndex(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File repackaged = new File(project, &quot;target/war-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged))</b>
<b class="nc">&nbsp;				.manifest((manifest) -&gt; manifest.hasAttribute(&quot;Spring-Boot-Classpath-Index&quot;, &quot;WEB-INF/classpath.idx&quot;));</b>
<b class="nc">&nbsp;			assertThat(jar(repackaged)).hasEntryWithName(&quot;WEB-INF/classpath.idx&quot;);</b>
<b class="nc">&nbsp;			try (JarFile jarFile = new JarFile(repackaged)) {</b>
<b class="nc">&nbsp;				List&lt;String&gt; index = readClasspathIndex(jarFile, &quot;WEB-INF/classpath.idx&quot;);</b>
<b class="nc">&nbsp;				assertThat(index)</b>
<b class="nc">&nbsp;					.allMatch((entry) -&gt; entry.startsWith(&quot;WEB-INF/lib/&quot;) || entry.startsWith(&quot;WEB-INF/lib-provided/&quot;));</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	@TestTemplate
&nbsp;	void whenEntryIsExcludedItShouldNotBePresentInTheRepackagedWar(MavenBuild mavenBuild) {
<b class="nc">&nbsp;		mavenBuild.project(&quot;war-exclude-entry&quot;).execute((project) -&gt; {</b>
<b class="nc">&nbsp;			File war = new File(project, &quot;target/war-exclude-entry-0.0.1.BUILD-SNAPSHOT.war&quot;);</b>
<b class="nc">&nbsp;			assertThat(jar(war)).hasEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-context&quot;)</b>
<b class="nc">&nbsp;				.doesNotHaveEntryWithNameStartingWith(&quot;WEB-INF/lib/spring-core&quot;);</b>
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
