


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > RepackageMojo</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.maven</a>
</div>

<h1>Coverage Summary for Class: RepackageMojo (org.springframework.boot.maven)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">RepackageMojo</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/61)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.maven;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.nio.file.attribute.FileTime;
&nbsp;import java.util.List;
&nbsp;import java.util.Properties;
&nbsp;import java.util.regex.Pattern;
&nbsp;
&nbsp;import org.apache.maven.artifact.Artifact;
&nbsp;import org.apache.maven.model.Dependency;
&nbsp;import org.apache.maven.plugin.MojoExecutionException;
&nbsp;import org.apache.maven.plugin.MojoFailureException;
&nbsp;import org.apache.maven.plugins.annotations.LifecyclePhase;
&nbsp;import org.apache.maven.plugins.annotations.Mojo;
&nbsp;import org.apache.maven.plugins.annotations.Parameter;
&nbsp;import org.apache.maven.plugins.annotations.ResolutionScope;
&nbsp;
&nbsp;import org.springframework.boot.loader.tools.DefaultLaunchScript;
&nbsp;import org.springframework.boot.loader.tools.LaunchScript;
&nbsp;import org.springframework.boot.loader.tools.LayoutFactory;
&nbsp;import org.springframework.boot.loader.tools.Libraries;
&nbsp;import org.springframework.boot.loader.tools.LoaderImplementation;
&nbsp;import org.springframework.boot.loader.tools.Repackager;
&nbsp;
&nbsp;/**
&nbsp; * Repackage existing JAR and WAR archives so that they can be executed from the command
&nbsp; * line using {@literal java -jar}. With &lt;code&gt;layout=NONE&lt;/code&gt; can also be used simply
&nbsp; * to package a JAR with nested dependencies (and no main class, so not executable).
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @author Dave Syer
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Björn Lindström
&nbsp; * @author Scott Frederick
&nbsp; * @since 1.0.0
&nbsp; */
&nbsp;@Mojo(name = &quot;repackage&quot;, defaultPhase = LifecyclePhase.PACKAGE, requiresProject = true, threadSafe = true,
&nbsp;		requiresDependencyResolution = ResolutionScope.COMPILE_PLUS_RUNTIME,
&nbsp;		requiresDependencyCollection = ResolutionScope.COMPILE_PLUS_RUNTIME)
<b class="nc">&nbsp;public class RepackageMojo extends AbstractPackagerMojo {</b>
&nbsp;
<b class="nc">&nbsp;	private static final Pattern WHITE_SPACE_PATTERN = Pattern.compile(&quot;\\s+&quot;);</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Directory containing the generated archive.
&nbsp;	 * @since 1.0.0
&nbsp;	 */
&nbsp;	@Parameter(defaultValue = &quot;${project.build.directory}&quot;, required = true)
&nbsp;	private File outputDirectory;
&nbsp;
&nbsp;	/**
&nbsp;	 * Name of the generated archive.
&nbsp;	 * @since 1.0.0
&nbsp;	 */
&nbsp;	@Parameter(defaultValue = &quot;${project.build.finalName}&quot;, readonly = true)
&nbsp;	private String finalName;
&nbsp;
&nbsp;	/**
&nbsp;	 * Skip the execution.
&nbsp;	 * @since 1.2.0
&nbsp;	 */
&nbsp;	@Parameter(property = &quot;spring-boot.repackage.skip&quot;, defaultValue = &quot;false&quot;)
&nbsp;	private boolean skip;
&nbsp;
&nbsp;	/**
&nbsp;	 * Classifier to add to the repackaged archive. If not given, the main artifact will
&nbsp;	 * be replaced by the repackaged archive. If given, the classifier will also be used
&nbsp;	 * to determine the source archive to repackage: if an artifact with that classifier
&nbsp;	 * already exists, it will be used as source and replaced. If no such artifact exists,
&nbsp;	 * the main artifact will be used as source and the repackaged archive will be
&nbsp;	 * attached as a supplemental artifact with that classifier. Attaching the artifact
&nbsp;	 * allows to deploy it alongside to the original one, see &lt;a href=
&nbsp;	 * &quot;https://maven.apache.org/plugins/maven-deploy-plugin/examples/deploying-with-classifiers.html&quot;
&nbsp;	 * &gt;the Maven documentation for more details&lt;/a&gt;.
&nbsp;	 * @since 1.0.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private String classifier;
&nbsp;
&nbsp;	/**
&nbsp;	 * Attach the repackaged archive to be installed into your local Maven repository or
&nbsp;	 * deployed to a remote repository. If no classifier has been configured, it will
&nbsp;	 * replace the normal jar. If a {@code classifier} has been configured such that the
&nbsp;	 * normal jar and the repackaged jar are different, it will be attached alongside the
&nbsp;	 * normal jar. When the property is set to {@code false}, the repackaged archive will
&nbsp;	 * not be installed or deployed.
&nbsp;	 * @since 1.4.0
&nbsp;	 */
<b class="nc">&nbsp;	@Parameter(defaultValue = &quot;true&quot;)</b>
&nbsp;	private boolean attach = true;
&nbsp;
&nbsp;	/**
&nbsp;	 * A list of the libraries that must be unpacked from uber jars in order to run.
&nbsp;	 * Specify each library as a {@code &lt;dependency&gt;} with a {@code &lt;groupId&gt;} and a
&nbsp;	 * {@code &lt;artifactId&gt;} and they will be unpacked at runtime.
&nbsp;	 * @since 1.1.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private List&lt;Dependency&gt; requiresUnpack;
&nbsp;
&nbsp;	/**
&nbsp;	 * Make a fully executable jar for *nix machines by prepending a launch script to the
&nbsp;	 * jar.
&nbsp;	 * &lt;p&gt;
&nbsp;	 * Currently, some tools do not accept this format so you may not always be able to
&nbsp;	 * use this technique. For example, {@code jar -xf} may silently fail to extract a jar
&nbsp;	 * or war that has been made fully-executable. It is recommended that you only enable
&nbsp;	 * this option if you intend to execute it directly, rather than running it with
&nbsp;	 * {@code java -jar} or deploying it to a servlet container.
&nbsp;	 * @since 1.3.0
&nbsp;	 */
&nbsp;	@Parameter(defaultValue = &quot;false&quot;)
&nbsp;	private boolean executable;
&nbsp;
&nbsp;	/**
&nbsp;	 * The embedded launch script to prepend to the front of the jar if it is fully
&nbsp;	 * executable. If not specified the &#39;Spring Boot&#39; default script will be used.
&nbsp;	 * @since 1.3.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private File embeddedLaunchScript;
&nbsp;
&nbsp;	/**
&nbsp;	 * Properties that should be expanded in the embedded launch script.
&nbsp;	 * @since 1.3.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private Properties embeddedLaunchScriptProperties;
&nbsp;
&nbsp;	/**
&nbsp;	 * Timestamp for reproducible output archive entries, either formatted as ISO 8601
&nbsp;	 * (&lt;code&gt;yyyy-MM-dd&#39;T&#39;HH:mm:ssXXX&lt;/code&gt;) or an {@code int} representing seconds
&nbsp;	 * since the epoch.
&nbsp;	 * @since 2.3.0
&nbsp;	 */
&nbsp;	@Parameter(defaultValue = &quot;${project.build.outputTimestamp}&quot;)
&nbsp;	private String outputTimestamp;
&nbsp;
&nbsp;	/**
&nbsp;	 * The type of archive (which corresponds to how the dependencies are laid out inside
&nbsp;	 * it). Possible values are {@code JAR}, {@code WAR}, {@code ZIP}, {@code DIR},
&nbsp;	 * {@code NONE}. Defaults to a guess based on the archive type.
&nbsp;	 * @since 1.0.0
&nbsp;	 */
&nbsp;	@Parameter(property = &quot;spring-boot.repackage.layout&quot;)
&nbsp;	private LayoutType layout;
&nbsp;
&nbsp;	/**
&nbsp;	 * The loader implementation that should be used.
&nbsp;	 * @since 3.2.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private LoaderImplementation loaderImplementation;
&nbsp;
&nbsp;	/**
&nbsp;	 * The layout factory that will be used to create the executable archive if no
&nbsp;	 * explicit layout is set. Alternative layouts implementations can be provided by 3rd
&nbsp;	 * parties.
&nbsp;	 * @since 1.5.0
&nbsp;	 */
&nbsp;	@Parameter
&nbsp;	private LayoutFactory layoutFactory;
&nbsp;
&nbsp;	/**
&nbsp;	 * Return the type of archive that should be packaged by this MOJO.
&nbsp;	 * @return the value of the {@code layout} parameter, or {@code null} if the parameter
&nbsp;	 * is not provided
&nbsp;	 */
&nbsp;	@Override
&nbsp;	protected LayoutType getLayout() {
<b class="nc">&nbsp;		return this.layout;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	protected LoaderImplementation getLoaderImplementation() {
<b class="nc">&nbsp;		return this.loaderImplementation;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Return the layout factory that will be used to determine the
&nbsp;	 * {@link AbstractPackagerMojo.LayoutType} if no explicit layout is set.
&nbsp;	 * @return the value of the {@code layoutFactory} parameter, or {@code null} if the
&nbsp;	 * parameter is not provided
&nbsp;	 */
&nbsp;	@Override
&nbsp;	protected LayoutFactory getLayoutFactory() {
<b class="nc">&nbsp;		return this.layoutFactory;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void execute() throws MojoExecutionException, MojoFailureException {
<b class="nc">&nbsp;		if (this.project.getPackaging().equals(&quot;pom&quot;)) {</b>
<b class="nc">&nbsp;			getLog().debug(&quot;repackage goal could not be applied to pom project.&quot;);</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		if (this.skip) {</b>
<b class="nc">&nbsp;			getLog().debug(&quot;skipping repackaging as per configuration.&quot;);</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		repackage();</b>
&nbsp;	}
&nbsp;
&nbsp;	private void repackage() throws MojoExecutionException {
<b class="nc">&nbsp;		Artifact source = getSourceArtifact(this.classifier);</b>
<b class="nc">&nbsp;		File target = getTargetFile(this.finalName, this.classifier, this.outputDirectory);</b>
<b class="nc">&nbsp;		Repackager repackager = getRepackager(source.getFile());</b>
<b class="nc">&nbsp;		Libraries libraries = getLibraries(this.requiresUnpack);</b>
&nbsp;		try {
<b class="nc">&nbsp;			LaunchScript launchScript = getLaunchScript();</b>
<b class="nc">&nbsp;			repackager.repackage(target, libraries, launchScript, parseOutputTimestamp());</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IOException ex) {</b>
<b class="nc">&nbsp;			throw new MojoExecutionException(ex.getMessage(), ex);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		updateArtifact(source, target, repackager.getBackupFile());</b>
&nbsp;	}
&nbsp;
&nbsp;	private FileTime parseOutputTimestamp() throws MojoExecutionException {
&nbsp;		try {
<b class="nc">&nbsp;			return new MavenBuildOutputTimestamp(this.outputTimestamp).toFileTime();</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IllegalArgumentException ex) {</b>
<b class="nc">&nbsp;			throw new MojoExecutionException(&quot;Invalid value for parameter &#39;outputTimestamp&#39;&quot;, ex);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private Repackager getRepackager(File source) {
<b class="nc">&nbsp;		return getConfiguredPackager(() -&gt; new Repackager(source));</b>
&nbsp;	}
&nbsp;
&nbsp;	private LaunchScript getLaunchScript() throws IOException {
<b class="nc">&nbsp;		if (this.executable || this.embeddedLaunchScript != null) {</b>
<b class="nc">&nbsp;			return new DefaultLaunchScript(this.embeddedLaunchScript, buildLaunchScriptProperties());</b>
&nbsp;		}
<b class="nc">&nbsp;		return null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Properties buildLaunchScriptProperties() {
<b class="nc">&nbsp;		Properties properties = new Properties();</b>
<b class="nc">&nbsp;		if (this.embeddedLaunchScriptProperties != null) {</b>
<b class="nc">&nbsp;			properties.putAll(this.embeddedLaunchScriptProperties);</b>
&nbsp;		}
<b class="nc">&nbsp;		putIfMissing(properties, &quot;initInfoProvides&quot;, this.project.getArtifactId());</b>
<b class="nc">&nbsp;		putIfMissing(properties, &quot;initInfoShortDescription&quot;, this.project.getName(), this.project.getArtifactId());</b>
<b class="nc">&nbsp;		putIfMissing(properties, &quot;initInfoDescription&quot;, removeLineBreaks(this.project.getDescription()),</b>
<b class="nc">&nbsp;				this.project.getName(), this.project.getArtifactId());</b>
<b class="nc">&nbsp;		return properties;</b>
&nbsp;	}
&nbsp;
&nbsp;	private String removeLineBreaks(String description) {
<b class="nc">&nbsp;		return (description != null) ? WHITE_SPACE_PATTERN.matcher(description).replaceAll(&quot; &quot;) : null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void putIfMissing(Properties properties, String key, String... valueCandidates) {
<b class="nc">&nbsp;		if (!properties.containsKey(key)) {</b>
<b class="nc">&nbsp;			for (String candidate : valueCandidates) {</b>
<b class="nc">&nbsp;				if (candidate != null &amp;&amp; !candidate.isEmpty()) {</b>
<b class="nc">&nbsp;					properties.put(key, candidate);</b>
&nbsp;					return;
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void updateArtifact(Artifact source, File target, File original) {
<b class="nc">&nbsp;		if (this.attach) {</b>
<b class="nc">&nbsp;			attachArtifact(source, target, original);</b>
&nbsp;		}
<b class="nc">&nbsp;		else if (source.getFile().equals(target) &amp;&amp; original.exists()) {</b>
<b class="nc">&nbsp;			String artifactId = (this.classifier != null) ? &quot;artifact with classifier &quot; + this.classifier</b>
<b class="nc">&nbsp;					: &quot;main artifact&quot;;</b>
<b class="nc">&nbsp;			getLog().info(String.format(&quot;Updating %s %s to %s&quot;, artifactId, source.getFile(), original));</b>
<b class="nc">&nbsp;			source.setFile(original);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		else if (this.classifier != null) {</b>
<b class="nc">&nbsp;			getLog().info(&quot;Creating repackaged archive &quot; + target + &quot; with classifier &quot; + this.classifier);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void attachArtifact(Artifact source, File target, File original) {
<b class="nc">&nbsp;		if (this.classifier != null &amp;&amp; !source.getFile().equals(target)) {</b>
<b class="nc">&nbsp;			getLog().info(&quot;Attaching repackaged archive &quot; + target + &quot; with classifier &quot; + this.classifier);</b>
<b class="nc">&nbsp;			this.projectHelper.attachArtifact(this.project, this.project.getPackaging(), this.classifier, target);</b>
&nbsp;		}
&nbsp;		else {
<b class="nc">&nbsp;			String artifactId = (this.classifier != null) ? &quot;artifact with classifier &quot; + this.classifier</b>
<b class="nc">&nbsp;					: &quot;main artifact&quot;;</b>
<b class="nc">&nbsp;			getLog()</b>
<b class="nc">&nbsp;				.info(String.format(&quot;Replacing %s %s with repackaged archive, adding nested dependencies in BOOT-INF/.&quot;,</b>
<b class="nc">&nbsp;						artifactId, source.getFile()));</b>
<b class="nc">&nbsp;			getLog().info(&quot;The original artifact has been renamed to &quot; + original);</b>
<b class="nc">&nbsp;			source.setFile(target);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
