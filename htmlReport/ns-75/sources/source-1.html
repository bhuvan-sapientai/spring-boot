


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ConfigurationPropertiesReportEndpoint</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.actuate.context.properties</a>
</div>

<h1>Coverage Summary for Class: ConfigurationPropertiesReportEndpoint (org.springframework.boot.actuate.context.properties)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ConfigurationPropertiesReportEndpoint</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/29)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/135)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ConfigurationPropertiesAnnotationIntrospector</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ConfigurationPropertiesBeanDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ConfigurationPropertiesDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ConfigurationPropertiesModule</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ConfigurationPropertiesPropertyFilter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$ContextConfigurationPropertiesDescriptor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ConfigurationPropertiesReportEndpoint$GenericSerializerModifier</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/54)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/209)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2024 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.actuate.context.properties;
&nbsp;
&nbsp;import java.lang.reflect.Constructor;
&nbsp;import java.lang.reflect.Parameter;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.function.Predicate;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import com.fasterxml.jackson.annotation.JsonInclude.Include;
&nbsp;import com.fasterxml.jackson.core.JsonGenerator;
&nbsp;import com.fasterxml.jackson.databind.BeanDescription;
&nbsp;import com.fasterxml.jackson.databind.MapperFeature;
&nbsp;import com.fasterxml.jackson.databind.ObjectMapper;
&nbsp;import com.fasterxml.jackson.databind.SerializationConfig;
&nbsp;import com.fasterxml.jackson.databind.SerializationFeature;
&nbsp;import com.fasterxml.jackson.databind.SerializerProvider;
&nbsp;import com.fasterxml.jackson.databind.introspect.Annotated;
&nbsp;import com.fasterxml.jackson.databind.introspect.AnnotatedMethod;
&nbsp;import com.fasterxml.jackson.databind.introspect.JacksonAnnotationIntrospector;
&nbsp;import com.fasterxml.jackson.databind.json.JsonMapper;
&nbsp;import com.fasterxml.jackson.databind.module.SimpleModule;
&nbsp;import com.fasterxml.jackson.databind.ser.BeanPropertyWriter;
&nbsp;import com.fasterxml.jackson.databind.ser.BeanSerializerFactory;
&nbsp;import com.fasterxml.jackson.databind.ser.BeanSerializerModifier;
&nbsp;import com.fasterxml.jackson.databind.ser.PropertyWriter;
&nbsp;import com.fasterxml.jackson.databind.ser.SerializerFactory;
&nbsp;import com.fasterxml.jackson.databind.ser.impl.SimpleBeanPropertyFilter;
&nbsp;import com.fasterxml.jackson.databind.ser.impl.SimpleFilterProvider;
&nbsp;import com.fasterxml.jackson.databind.ser.std.ToStringSerializer;
&nbsp;import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
&nbsp;import org.apache.commons.logging.Log;
&nbsp;import org.apache.commons.logging.LogFactory;
&nbsp;
&nbsp;import org.springframework.beans.BeansException;
&nbsp;import org.springframework.boot.actuate.endpoint.OperationResponseBody;
&nbsp;import org.springframework.boot.actuate.endpoint.SanitizableData;
&nbsp;import org.springframework.boot.actuate.endpoint.Sanitizer;
&nbsp;import org.springframework.boot.actuate.endpoint.SanitizingFunction;
&nbsp;import org.springframework.boot.actuate.endpoint.Show;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.Endpoint;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.ReadOperation;
&nbsp;import org.springframework.boot.actuate.endpoint.annotation.Selector;
&nbsp;import org.springframework.boot.context.properties.BoundConfigurationProperties;
&nbsp;import org.springframework.boot.context.properties.ConfigurationProperties;
&nbsp;import org.springframework.boot.context.properties.ConfigurationPropertiesBean;
&nbsp;import org.springframework.boot.context.properties.bind.BindConstructorProvider;
&nbsp;import org.springframework.boot.context.properties.bind.Bindable;
&nbsp;import org.springframework.boot.context.properties.bind.Name;
&nbsp;import org.springframework.boot.context.properties.source.ConfigurationProperty;
&nbsp;import org.springframework.boot.context.properties.source.ConfigurationPropertyName;
&nbsp;import org.springframework.boot.context.properties.source.ConfigurationPropertySource;
&nbsp;import org.springframework.boot.origin.Origin;
&nbsp;import org.springframework.context.ApplicationContext;
&nbsp;import org.springframework.context.ApplicationContextAware;
&nbsp;import org.springframework.core.DefaultParameterNameDiscoverer;
&nbsp;import org.springframework.core.ParameterNameDiscoverer;
&nbsp;import org.springframework.core.annotation.MergedAnnotation;
&nbsp;import org.springframework.core.annotation.MergedAnnotations;
&nbsp;import org.springframework.core.env.PropertySource;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;import org.springframework.util.unit.DataSize;
&nbsp;
&nbsp;/**
&nbsp; * {@link Endpoint @Endpoint} to expose application properties from
&nbsp; * {@link ConfigurationProperties @ConfigurationProperties} annotated beans.
&nbsp; *
&nbsp; * &lt;p&gt;
&nbsp; * To protect sensitive information from being exposed, all property values are masked by
&nbsp; * default. To configure when property values should be shown, use
&nbsp; * {@code management.endpoint.configprops.show-values} and
&nbsp; * {@code management.endpoint.configprops.roles} in your Spring Boot application
&nbsp; * configuration.
&nbsp; *
&nbsp; * @author Christian Dupuis
&nbsp; * @author Dave Syer
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Madhura Bhave
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Chris Bono
&nbsp; * @since 2.0.0
&nbsp; */
&nbsp;@Endpoint(id = &quot;configprops&quot;)
&nbsp;public class ConfigurationPropertiesReportEndpoint implements ApplicationContextAware {
&nbsp;
&nbsp;	private static final String CONFIGURATION_PROPERTIES_FILTER_ID = &quot;configurationPropertiesFilter&quot;;
&nbsp;
&nbsp;	private final Sanitizer sanitizer;
&nbsp;
&nbsp;	private final Show showValues;
&nbsp;
&nbsp;	private ApplicationContext context;
&nbsp;
&nbsp;	private ObjectMapper objectMapper;
&nbsp;
<b class="nc">&nbsp;	public ConfigurationPropertiesReportEndpoint(Iterable&lt;SanitizingFunction&gt; sanitizingFunctions, Show showValues) {</b>
<b class="nc">&nbsp;		this.sanitizer = new Sanitizer(sanitizingFunctions);</b>
<b class="nc">&nbsp;		this.showValues = showValues;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setApplicationContext(ApplicationContext context) throws BeansException {
<b class="nc">&nbsp;		this.context = context;</b>
&nbsp;	}
&nbsp;
&nbsp;	@ReadOperation
&nbsp;	public ConfigurationPropertiesDescriptor configurationProperties() {
<b class="nc">&nbsp;		boolean showUnsanitized = this.showValues.isShown(true);</b>
<b class="nc">&nbsp;		return getConfigurationProperties(showUnsanitized);</b>
&nbsp;	}
&nbsp;
&nbsp;	ConfigurationPropertiesDescriptor getConfigurationProperties(boolean showUnsanitized) {
<b class="nc">&nbsp;		return getConfigurationProperties(this.context, (bean) -&gt; true, showUnsanitized);</b>
&nbsp;	}
&nbsp;
&nbsp;	@ReadOperation
&nbsp;	public ConfigurationPropertiesDescriptor configurationPropertiesWithPrefix(@Selector String prefix) {
<b class="nc">&nbsp;		boolean showUnsanitized = this.showValues.isShown(true);</b>
<b class="nc">&nbsp;		return getConfigurationProperties(prefix, showUnsanitized);</b>
&nbsp;	}
&nbsp;
&nbsp;	ConfigurationPropertiesDescriptor getConfigurationProperties(String prefix, boolean showUnsanitized) {
<b class="nc">&nbsp;		return getConfigurationProperties(this.context, (bean) -&gt; bean.getAnnotation().prefix().startsWith(prefix),</b>
&nbsp;				showUnsanitized);
&nbsp;	}
&nbsp;
&nbsp;	private ConfigurationPropertiesDescriptor getConfigurationProperties(ApplicationContext context,
&nbsp;			Predicate&lt;ConfigurationPropertiesBean&gt; beanFilterPredicate, boolean showUnsanitized) {
<b class="nc">&nbsp;		ObjectMapper mapper = getObjectMapper();</b>
<b class="nc">&nbsp;		Map&lt;String, ContextConfigurationPropertiesDescriptor&gt; contexts = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;		ApplicationContext target = context;</b>
&nbsp;
<b class="nc">&nbsp;		while (target != null) {</b>
<b class="nc">&nbsp;			contexts.put(target.getId(), describeBeans(mapper, target, beanFilterPredicate, showUnsanitized));</b>
<b class="nc">&nbsp;			target = target.getParent();</b>
&nbsp;		}
<b class="nc">&nbsp;		return new ConfigurationPropertiesDescriptor(contexts);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ObjectMapper getObjectMapper() {
<b class="nc">&nbsp;		if (this.objectMapper == null) {</b>
<b class="nc">&nbsp;			JsonMapper.Builder builder = JsonMapper.builder();</b>
<b class="nc">&nbsp;			configureJsonMapper(builder);</b>
<b class="nc">&nbsp;			this.objectMapper = builder.build();</b>
&nbsp;		}
<b class="nc">&nbsp;		return this.objectMapper;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Configure Jackson&#39;s {@link JsonMapper} to be used to serialize the
&nbsp;	 * {@link ConfigurationProperties @ConfigurationProperties} objects into a {@link Map}
&nbsp;	 * structure.
&nbsp;	 * @param builder the json mapper builder
&nbsp;	 * @since 2.6.0
&nbsp;	 */
&nbsp;	protected void configureJsonMapper(JsonMapper.Builder builder) {
<b class="nc">&nbsp;		builder.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);</b>
<b class="nc">&nbsp;		builder.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);</b>
<b class="nc">&nbsp;		builder.configure(SerializationFeature.WRITE_DURATIONS_AS_TIMESTAMPS, false);</b>
<b class="nc">&nbsp;		builder.configure(MapperFeature.USE_STD_BEAN_NAMING, true);</b>
<b class="nc">&nbsp;		builder.serializationInclusion(Include.NON_NULL);</b>
<b class="nc">&nbsp;		applyConfigurationPropertiesFilter(builder);</b>
<b class="nc">&nbsp;		applySerializationModifier(builder);</b>
<b class="nc">&nbsp;		builder.addModule(new JavaTimeModule());</b>
<b class="nc">&nbsp;		builder.addModule(new ConfigurationPropertiesModule());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void applyConfigurationPropertiesFilter(JsonMapper.Builder builder) {
<b class="nc">&nbsp;		builder.annotationIntrospector(new ConfigurationPropertiesAnnotationIntrospector());</b>
<b class="nc">&nbsp;		builder</b>
<b class="nc">&nbsp;			.filterProvider(new SimpleFilterProvider().setDefaultFilter(new ConfigurationPropertiesPropertyFilter()));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Ensure only bindable and non-cyclic bean properties are reported.
&nbsp;	 * @param builder the JsonMapper builder
&nbsp;	 */
&nbsp;	private void applySerializationModifier(JsonMapper.Builder builder) {
<b class="nc">&nbsp;		SerializerFactory factory = BeanSerializerFactory.instance</b>
<b class="nc">&nbsp;			.withSerializerModifier(new GenericSerializerModifier());</b>
<b class="nc">&nbsp;		builder.serializerFactory(factory);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ContextConfigurationPropertiesDescriptor describeBeans(ObjectMapper mapper, ApplicationContext context,
&nbsp;			Predicate&lt;ConfigurationPropertiesBean&gt; beanFilterPredicate, boolean showUnsanitized) {
<b class="nc">&nbsp;		Map&lt;String, ConfigurationPropertiesBean&gt; beans = ConfigurationPropertiesBean.getAll(context);</b>
<b class="nc">&nbsp;		Map&lt;String, ConfigurationPropertiesBeanDescriptor&gt; descriptors = beans.values()</b>
<b class="nc">&nbsp;			.stream()</b>
<b class="nc">&nbsp;			.filter(beanFilterPredicate)</b>
<b class="nc">&nbsp;			.collect(Collectors.toMap(ConfigurationPropertiesBean::getName,</b>
<b class="nc">&nbsp;					(bean) -&gt; describeBean(mapper, bean, showUnsanitized)));</b>
<b class="nc">&nbsp;		return new ContextConfigurationPropertiesDescriptor(descriptors,</b>
<b class="nc">&nbsp;				(context.getParent() != null) ? context.getParent().getId() : null);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ConfigurationPropertiesBeanDescriptor describeBean(ObjectMapper mapper, ConfigurationPropertiesBean bean,
&nbsp;			boolean showUnsanitized) {
<b class="nc">&nbsp;		String prefix = bean.getAnnotation().prefix();</b>
<b class="nc">&nbsp;		Map&lt;String, Object&gt; serialized = safeSerialize(mapper, bean.getInstance(), prefix);</b>
<b class="nc">&nbsp;		Map&lt;String, Object&gt; properties = sanitize(prefix, serialized, showUnsanitized);</b>
<b class="nc">&nbsp;		Map&lt;String, Object&gt; inputs = getInputs(prefix, serialized, showUnsanitized);</b>
<b class="nc">&nbsp;		return new ConfigurationPropertiesBeanDescriptor(prefix, properties, inputs);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Cautiously serialize the bean to a map (returning a map with an error message
&nbsp;	 * instead of throwing an exception if there is a problem).
&nbsp;	 * @param mapper the object mapper
&nbsp;	 * @param bean the source bean
&nbsp;	 * @param prefix the prefix
&nbsp;	 * @return the serialized instance
&nbsp;	 */
&nbsp;	@SuppressWarnings({ &quot;unchecked&quot; })
&nbsp;	private Map&lt;String, Object&gt; safeSerialize(ObjectMapper mapper, Object bean, String prefix) {
&nbsp;		try {
<b class="nc">&nbsp;			return new HashMap&lt;&gt;(mapper.convertValue(bean, Map.class));</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			return new HashMap&lt;&gt;(Collections.singletonMap(&quot;error&quot;, &quot;Cannot serialize &#39;&quot; + prefix + &quot;&#39;&quot;));</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Sanitize all unwanted configuration properties to avoid leaking of sensitive
&nbsp;	 * information.
&nbsp;	 * @param prefix the property prefix
&nbsp;	 * @param map the source map
&nbsp;	 * @param showUnsanitized whether to show the unsanitized values
&nbsp;	 * @return the sanitized map
&nbsp;	 */
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private Map&lt;String, Object&gt; sanitize(String prefix, Map&lt;String, Object&gt; map, boolean showUnsanitized) {
<b class="nc">&nbsp;		map.forEach((key, value) -&gt; {</b>
<b class="nc">&nbsp;			String qualifiedKey = getQualifiedKey(prefix, key);</b>
<b class="nc">&nbsp;			if (value instanceof Map) {</b>
<b class="nc">&nbsp;				map.put(key, sanitize(qualifiedKey, (Map&lt;String, Object&gt;) value, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (value instanceof List) {</b>
<b class="nc">&nbsp;				map.put(key, sanitize(qualifiedKey, (List&lt;Object&gt;) value, showUnsanitized));</b>
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				map.put(key, sanitizeWithPropertySourceIfPresent(qualifiedKey, value, showUnsanitized));</b>
&nbsp;			}
&nbsp;		});
<b class="nc">&nbsp;		return map;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Object sanitizeWithPropertySourceIfPresent(String qualifiedKey, Object value, boolean showUnsanitized) {
<b class="nc">&nbsp;		ConfigurationPropertyName currentName = getCurrentName(qualifiedKey);</b>
<b class="nc">&nbsp;		ConfigurationProperty candidate = getCandidate(currentName);</b>
<b class="nc">&nbsp;		PropertySource&lt;?&gt; propertySource = getPropertySource(candidate);</b>
<b class="nc">&nbsp;		if (propertySource != null) {</b>
<b class="nc">&nbsp;			SanitizableData data = new SanitizableData(propertySource, qualifiedKey, value);</b>
<b class="nc">&nbsp;			return this.sanitizer.sanitize(data, showUnsanitized);</b>
&nbsp;		}
<b class="nc">&nbsp;		SanitizableData data = new SanitizableData(null, qualifiedKey, value);</b>
<b class="nc">&nbsp;		return this.sanitizer.sanitize(data, showUnsanitized);</b>
&nbsp;	}
&nbsp;
&nbsp;	private PropertySource&lt;?&gt; getPropertySource(ConfigurationProperty configurationProperty) {
<b class="nc">&nbsp;		if (configurationProperty == null) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		ConfigurationPropertySource source = configurationProperty.getSource();</b>
<b class="nc">&nbsp;		Object underlyingSource = (source != null) ? source.getUnderlyingSource() : null;</b>
<b class="nc">&nbsp;		return (underlyingSource instanceof PropertySource&lt;?&gt;) ? (PropertySource&lt;?&gt;) underlyingSource : null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private ConfigurationPropertyName getCurrentName(String qualifiedKey) {
<b class="nc">&nbsp;		return ConfigurationPropertyName.adapt(qualifiedKey, &#39;.&#39;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ConfigurationProperty getCandidate(ConfigurationPropertyName currentName) {
<b class="nc">&nbsp;		BoundConfigurationProperties bound = BoundConfigurationProperties.get(this.context);</b>
<b class="nc">&nbsp;		if (bound == null) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		ConfigurationProperty candidate = bound.get(currentName);</b>
<b class="nc">&nbsp;		if (candidate == null &amp;&amp; currentName.isLastElementIndexed()) {</b>
<b class="nc">&nbsp;			candidate = bound.get(currentName.chop(currentName.getNumberOfElements() - 1));</b>
&nbsp;		}
<b class="nc">&nbsp;		return candidate;</b>
&nbsp;	}
&nbsp;
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private List&lt;Object&gt; sanitize(String prefix, List&lt;Object&gt; list, boolean showUnsanitized) {
<b class="nc">&nbsp;		List&lt;Object&gt; sanitized = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		int index = 0;</b>
<b class="nc">&nbsp;		for (Object item : list) {</b>
<b class="nc">&nbsp;			String name = prefix + &quot;[&quot; + index++ + &quot;]&quot;;</b>
<b class="nc">&nbsp;			if (item instanceof Map) {</b>
<b class="nc">&nbsp;				sanitized.add(sanitize(name, (Map&lt;String, Object&gt;) item, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (item instanceof List) {</b>
<b class="nc">&nbsp;				sanitized.add(sanitize(name, (List&lt;Object&gt;) item, showUnsanitized));</b>
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				sanitized.add(sanitizeWithPropertySourceIfPresent(name, item, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return sanitized;</b>
&nbsp;	}
&nbsp;
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private Map&lt;String, Object&gt; getInputs(String prefix, Map&lt;String, Object&gt; map, boolean showUnsanitized) {
<b class="nc">&nbsp;		Map&lt;String, Object&gt; augmented = new LinkedHashMap&lt;&gt;(map);</b>
<b class="nc">&nbsp;		map.forEach((key, value) -&gt; {</b>
<b class="nc">&nbsp;			String qualifiedKey = getQualifiedKey(prefix, key);</b>
<b class="nc">&nbsp;			if (value instanceof Map) {</b>
<b class="nc">&nbsp;				augmented.put(key, getInputs(qualifiedKey, (Map&lt;String, Object&gt;) value, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (value instanceof List) {</b>
<b class="nc">&nbsp;				augmented.put(key, getInputs(qualifiedKey, (List&lt;Object&gt;) value, showUnsanitized));</b>
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				augmented.put(key, applyInput(qualifiedKey, showUnsanitized));</b>
&nbsp;			}
&nbsp;		});
<b class="nc">&nbsp;		return augmented;</b>
&nbsp;	}
&nbsp;
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private List&lt;Object&gt; getInputs(String prefix, List&lt;Object&gt; list, boolean showUnsanitized) {
<b class="nc">&nbsp;		List&lt;Object&gt; augmented = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		int index = 0;</b>
<b class="nc">&nbsp;		for (Object item : list) {</b>
<b class="nc">&nbsp;			String name = prefix + &quot;[&quot; + index++ + &quot;]&quot;;</b>
<b class="nc">&nbsp;			if (item instanceof Map) {</b>
<b class="nc">&nbsp;				augmented.add(getInputs(name, (Map&lt;String, Object&gt;) item, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (item instanceof List) {</b>
<b class="nc">&nbsp;				augmented.add(getInputs(name, (List&lt;Object&gt;) item, showUnsanitized));</b>
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				augmented.add(applyInput(name, showUnsanitized));</b>
&nbsp;			}
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return augmented;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Map&lt;String, Object&gt; applyInput(String qualifiedKey, boolean showUnsanitized) {
<b class="nc">&nbsp;		ConfigurationPropertyName currentName = getCurrentName(qualifiedKey);</b>
<b class="nc">&nbsp;		ConfigurationProperty candidate = getCandidate(currentName);</b>
<b class="nc">&nbsp;		PropertySource&lt;?&gt; propertySource = getPropertySource(candidate);</b>
<b class="nc">&nbsp;		if (propertySource != null) {</b>
<b class="nc">&nbsp;			Object value = stringifyIfNecessary(candidate.getValue());</b>
<b class="nc">&nbsp;			SanitizableData data = new SanitizableData(propertySource, currentName.toString(), value);</b>
<b class="nc">&nbsp;			return getInput(candidate, this.sanitizer.sanitize(data, showUnsanitized));</b>
&nbsp;		}
<b class="nc">&nbsp;		return Collections.emptyMap();</b>
&nbsp;	}
&nbsp;
&nbsp;	private Map&lt;String, Object&gt; getInput(ConfigurationProperty candidate, Object sanitizedValue) {
<b class="nc">&nbsp;		Map&lt;String, Object&gt; input = new LinkedHashMap&lt;&gt;();</b>
<b class="nc">&nbsp;		Origin origin = Origin.from(candidate);</b>
<b class="nc">&nbsp;		List&lt;Origin&gt; originParents = Origin.parentsFrom(candidate);</b>
<b class="nc">&nbsp;		input.put(&quot;value&quot;, sanitizedValue);</b>
<b class="nc">&nbsp;		input.put(&quot;origin&quot;, (origin != null) ? origin.toString() : &quot;none&quot;);</b>
<b class="nc">&nbsp;		if (!originParents.isEmpty()) {</b>
<b class="nc">&nbsp;			input.put(&quot;originParents&quot;, originParents.stream().map(Object::toString).toArray(String[]::new));</b>
&nbsp;		}
<b class="nc">&nbsp;		return input;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Object stringifyIfNecessary(Object value) {
<b class="nc">&nbsp;		if (value == null || ClassUtils.isPrimitiveOrWrapper(value.getClass()) || value instanceof String) {</b>
<b class="nc">&nbsp;			return value;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (CharSequence.class.isAssignableFrom(value.getClass())) {</b>
<b class="nc">&nbsp;			return value.toString();</b>
&nbsp;		}
<b class="nc">&nbsp;		return &quot;Complex property value &quot; + value.getClass().getName();</b>
&nbsp;	}
&nbsp;
&nbsp;	private String getQualifiedKey(String prefix, String key) {
<b class="nc">&nbsp;		return (prefix.isEmpty() ? prefix : prefix + &quot;.&quot;) + key;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Extension to {@link JacksonAnnotationIntrospector} to suppress CGLIB generated bean
&nbsp;	 * properties.
&nbsp;	 */
<b class="nc">&nbsp;	private static final class ConfigurationPropertiesAnnotationIntrospector extends JacksonAnnotationIntrospector {</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public Object findFilterId(Annotated a) {
<b class="nc">&nbsp;			Object id = super.findFilterId(a);</b>
<b class="nc">&nbsp;			if (id == null) {</b>
<b class="nc">&nbsp;				id = CONFIGURATION_PROPERTIES_FILTER_ID;</b>
&nbsp;			}
<b class="nc">&nbsp;			return id;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link SimpleBeanPropertyFilter} for serialization of
&nbsp;	 * {@link ConfigurationProperties @ConfigurationProperties} beans. The filter hides:
&nbsp;	 *
&nbsp;	 * &lt;ul&gt;
&nbsp;	 * &lt;li&gt;Properties that have a name starting with &#39;$$&#39;.
&nbsp;	 * &lt;li&gt;Properties that are self-referential.
&nbsp;	 * &lt;li&gt;Properties that throw an exception when retrieving their value.
&nbsp;	 * &lt;/ul&gt;
&nbsp;	 */
<b class="nc">&nbsp;	private static final class ConfigurationPropertiesPropertyFilter extends SimpleBeanPropertyFilter {</b>
&nbsp;
<b class="nc">&nbsp;		private static final Log logger = LogFactory.getLog(ConfigurationPropertiesPropertyFilter.class);</b>
&nbsp;
&nbsp;		@Override
&nbsp;		protected boolean include(BeanPropertyWriter writer) {
<b class="nc">&nbsp;			return include(writer.getFullName().getSimpleName());</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		protected boolean include(PropertyWriter writer) {
<b class="nc">&nbsp;			return include(writer.getFullName().getSimpleName());</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean include(String name) {
<b class="nc">&nbsp;			return !name.startsWith(&quot;$$&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void serializeAsField(Object pojo, JsonGenerator jgen, SerializerProvider provider,
&nbsp;				PropertyWriter writer) throws Exception {
<b class="nc">&nbsp;			if (writer instanceof BeanPropertyWriter beanPropertyWriter) {</b>
&nbsp;				try {
<b class="nc">&nbsp;					if (pojo == beanPropertyWriter.get(pojo)) {</b>
<b class="nc">&nbsp;						if (logger.isDebugEnabled()) {</b>
<b class="nc">&nbsp;							logger.debug(&quot;Skipping &#39;&quot; + writer.getFullName() + &quot;&#39; on &#39;&quot; + pojo.getClass().getName()</b>
&nbsp;									+ &quot;&#39; as it is self-referential&quot;);
&nbsp;						}
&nbsp;						return;
&nbsp;					}
&nbsp;				}
<b class="nc">&nbsp;				catch (Exception ex) {</b>
<b class="nc">&nbsp;					if (logger.isDebugEnabled()) {</b>
<b class="nc">&nbsp;						logger.debug(&quot;Skipping &#39;&quot; + writer.getFullName() + &quot;&#39; on &#39;&quot; + pojo.getClass().getName()</b>
&nbsp;								+ &quot;&#39; as an exception was thrown when retrieving its value&quot;, ex);
&nbsp;					}
&nbsp;					return;
<b class="nc">&nbsp;				}</b>
&nbsp;			}
<b class="nc">&nbsp;			super.serializeAsField(pojo, jgen, provider, writer);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link SimpleModule} for configuring the serializer.
&nbsp;	 */
&nbsp;	private static final class ConfigurationPropertiesModule extends SimpleModule {
&nbsp;
<b class="nc">&nbsp;		private ConfigurationPropertiesModule() {</b>
<b class="nc">&nbsp;			addSerializer(DataSize.class, ToStringSerializer.instance);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link BeanSerializerModifier} to return only relevant configuration properties.
&nbsp;	 */
<b class="nc">&nbsp;	protected static class GenericSerializerModifier extends BeanSerializerModifier {</b>
&nbsp;
<b class="nc">&nbsp;		private static final ParameterNameDiscoverer PARAMETER_NAME_DISCOVERER = new DefaultParameterNameDiscoverer();</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public List&lt;BeanPropertyWriter&gt; changeProperties(SerializationConfig config, BeanDescription beanDesc,
&nbsp;				List&lt;BeanPropertyWriter&gt; beanProperties) {
<b class="nc">&nbsp;			List&lt;BeanPropertyWriter&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;			Class&lt;?&gt; beanClass = beanDesc.getType().getRawClass();</b>
<b class="nc">&nbsp;			Bindable&lt;?&gt; bindable = Bindable.of(ClassUtils.getUserClass(beanClass));</b>
<b class="nc">&nbsp;			Constructor&lt;?&gt; bindConstructor = BindConstructorProvider.DEFAULT.getBindConstructor(bindable, false);</b>
<b class="nc">&nbsp;			for (BeanPropertyWriter writer : beanProperties) {</b>
<b class="nc">&nbsp;				if (isCandidate(beanDesc, writer, bindConstructor)) {</b>
<b class="nc">&nbsp;					result.add(writer);</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			return result;</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean isCandidate(BeanDescription beanDesc, BeanPropertyWriter writer, Constructor&lt;?&gt; constructor) {
<b class="nc">&nbsp;			if (constructor != null) {</b>
<b class="nc">&nbsp;				Parameter[] parameters = constructor.getParameters();</b>
<b class="nc">&nbsp;				String[] names = PARAMETER_NAME_DISCOVERER.getParameterNames(constructor);</b>
<b class="nc">&nbsp;				if (names == null) {</b>
<b class="nc">&nbsp;					names = new String[parameters.length];</b>
&nbsp;				}
<b class="nc">&nbsp;				for (int i = 0; i &lt; parameters.length; i++) {</b>
<b class="nc">&nbsp;					String name = MergedAnnotations.from(parameters[i])</b>
<b class="nc">&nbsp;						.get(Name.class)</b>
<b class="nc">&nbsp;						.getValue(MergedAnnotation.VALUE, String.class)</b>
<b class="nc">&nbsp;						.orElse((names[i] != null) ? names[i] : parameters[i].getName());</b>
<b class="nc">&nbsp;					if (name.equals(writer.getName())) {</b>
<b class="nc">&nbsp;						return true;</b>
&nbsp;					}
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			return isReadable(beanDesc, writer);</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean isReadable(BeanDescription beanDesc, BeanPropertyWriter writer) {
<b class="nc">&nbsp;			Class&lt;?&gt; parentType = beanDesc.getType().getRawClass();</b>
<b class="nc">&nbsp;			Class&lt;?&gt; type = writer.getType().getRawClass();</b>
<b class="nc">&nbsp;			AnnotatedMethod setter = findSetter(beanDesc, writer);</b>
&nbsp;			// If there&#39;s a setter, we assume it&#39;s OK to report on the value,
&nbsp;			// similarly, if there&#39;s no setter but the package names match, we assume
&nbsp;			// that it is a nested class used solely for binding to config props, so it
&nbsp;			// should be kosher. Lists and Maps are also auto-detected by default since
&nbsp;			// that&#39;s what the metadata generator does. This filter is not used if there
&nbsp;			// is JSON metadata for the property, so it&#39;s mainly for user-defined beans.
<b class="nc">&nbsp;			return (setter != null) || ClassUtils.getPackageName(parentType).equals(ClassUtils.getPackageName(type))</b>
<b class="nc">&nbsp;					|| Map.class.isAssignableFrom(type) || Collection.class.isAssignableFrom(type);</b>
&nbsp;		}
&nbsp;
&nbsp;		private AnnotatedMethod findSetter(BeanDescription beanDesc, BeanPropertyWriter writer) {
<b class="nc">&nbsp;			String name = &quot;set&quot; + determineAccessorSuffix(writer.getName());</b>
<b class="nc">&nbsp;			Class&lt;?&gt; type = writer.getType().getRawClass();</b>
<b class="nc">&nbsp;			AnnotatedMethod setter = beanDesc.findMethod(name, new Class&lt;?&gt;[] { type });</b>
&nbsp;			// The enabled property of endpoints returns a boolean primitive but is set
&nbsp;			// using a Boolean class
<b class="nc">&nbsp;			if (setter == null &amp;&amp; type.equals(Boolean.TYPE)) {</b>
<b class="nc">&nbsp;				setter = beanDesc.findMethod(name, new Class&lt;?&gt;[] { Boolean.class });</b>
&nbsp;			}
<b class="nc">&nbsp;			return setter;</b>
&nbsp;		}
&nbsp;
&nbsp;		/**
&nbsp;		 * Determine the accessor suffix of the specified {@code propertyName}, see
&nbsp;		 * section 8.8 &quot;Capitalization of inferred names&quot; of the JavaBean specs for more
&nbsp;		 * details.
&nbsp;		 * @param propertyName the property name to turn into an accessor suffix
&nbsp;		 * @return the accessor suffix for {@code propertyName}
&nbsp;		 */
&nbsp;		private String determineAccessorSuffix(String propertyName) {
<b class="nc">&nbsp;			if (propertyName.length() &gt; 1 &amp;&amp; Character.isUpperCase(propertyName.charAt(1))) {</b>
<b class="nc">&nbsp;				return propertyName;</b>
&nbsp;			}
<b class="nc">&nbsp;			return StringUtils.capitalize(propertyName);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Description of an application&#39;s
&nbsp;	 * {@link ConfigurationProperties @ConfigurationProperties} beans.
&nbsp;	 */
&nbsp;	public static final class ConfigurationPropertiesDescriptor implements OperationResponseBody {
&nbsp;
&nbsp;		private final Map&lt;String, ContextConfigurationPropertiesDescriptor&gt; contexts;
&nbsp;
<b class="nc">&nbsp;		ConfigurationPropertiesDescriptor(Map&lt;String, ContextConfigurationPropertiesDescriptor&gt; contexts) {</b>
<b class="nc">&nbsp;			this.contexts = contexts;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Map&lt;String, ContextConfigurationPropertiesDescriptor&gt; getContexts() {
<b class="nc">&nbsp;			return this.contexts;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Description of an application context&#39;s
&nbsp;	 * {@link ConfigurationProperties @ConfigurationProperties} beans.
&nbsp;	 */
&nbsp;	public static final class ContextConfigurationPropertiesDescriptor {
&nbsp;
&nbsp;		private final Map&lt;String, ConfigurationPropertiesBeanDescriptor&gt; beans;
&nbsp;
&nbsp;		private final String parentId;
&nbsp;
&nbsp;		private ContextConfigurationPropertiesDescriptor(Map&lt;String, ConfigurationPropertiesBeanDescriptor&gt; beans,
<b class="nc">&nbsp;				String parentId) {</b>
<b class="nc">&nbsp;			this.beans = beans;</b>
<b class="nc">&nbsp;			this.parentId = parentId;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Map&lt;String, ConfigurationPropertiesBeanDescriptor&gt; getBeans() {
<b class="nc">&nbsp;			return this.beans;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getParentId() {
<b class="nc">&nbsp;			return this.parentId;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Description of a {@link ConfigurationProperties @ConfigurationProperties} bean.
&nbsp;	 */
&nbsp;	public static final class ConfigurationPropertiesBeanDescriptor {
&nbsp;
&nbsp;		private final String prefix;
&nbsp;
&nbsp;		private final Map&lt;String, Object&gt; properties;
&nbsp;
&nbsp;		private final Map&lt;String, Object&gt; inputs;
&nbsp;
&nbsp;		private ConfigurationPropertiesBeanDescriptor(String prefix, Map&lt;String, Object&gt; properties,
<b class="nc">&nbsp;				Map&lt;String, Object&gt; inputs) {</b>
<b class="nc">&nbsp;			this.prefix = prefix;</b>
<b class="nc">&nbsp;			this.properties = properties;</b>
<b class="nc">&nbsp;			this.inputs = inputs;</b>
&nbsp;		}
&nbsp;
&nbsp;		public String getPrefix() {
<b class="nc">&nbsp;			return this.prefix;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Map&lt;String, Object&gt; getProperties() {
<b class="nc">&nbsp;			return this.properties;</b>
&nbsp;		}
&nbsp;
&nbsp;		public Map&lt;String, Object&gt; getInputs() {
<b class="nc">&nbsp;			return this.inputs;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
