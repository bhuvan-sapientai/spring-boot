


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > JettyServletWebServerFactory</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.web.embedded.jetty</a>
</div>

<h1>Coverage Summary for Class: JettyServletWebServerFactory (org.springframework.boot.web.embedded.jetty)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JettyServletWebServerFactory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/183)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$LoaderHidingResource</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$SuppliedSameSiteCookieHandlerWrapper</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$SuppliedSameSiteCookieHandlerWrapper$SuppliedSameSiteCookieHeaders</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$SuppliedSameSiteCookieHandlerWrapper$SuppliedSameSiteCookieResponse</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JettyServletWebServerFactory$WebListenersConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/84)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/272)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2024 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.web.embedded.jetty;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.net.InetSocketAddress;
&nbsp;import java.net.URI;
&nbsp;import java.net.URL;
&nbsp;import java.nio.channels.ReadableByteChannel;
&nbsp;import java.nio.file.Path;
&nbsp;import java.time.Duration;
&nbsp;import java.time.Instant;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collection;
&nbsp;import java.util.EventListener;
&nbsp;import java.util.Iterator;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Objects;
&nbsp;import java.util.Set;
&nbsp;import java.util.Spliterator;
&nbsp;import java.util.UUID;
&nbsp;import java.util.function.Consumer;
&nbsp;
&nbsp;import jakarta.servlet.http.Cookie;
&nbsp;import org.eclipse.jetty.ee10.servlet.ErrorHandler;
&nbsp;import org.eclipse.jetty.ee10.servlet.ErrorPageErrorHandler;
&nbsp;import org.eclipse.jetty.ee10.servlet.ListenerHolder;
&nbsp;import org.eclipse.jetty.ee10.servlet.ServletHandler;
&nbsp;import org.eclipse.jetty.ee10.servlet.ServletHolder;
&nbsp;import org.eclipse.jetty.ee10.servlet.ServletMapping;
&nbsp;import org.eclipse.jetty.ee10.servlet.SessionHandler;
&nbsp;import org.eclipse.jetty.ee10.servlet.Source;
&nbsp;import org.eclipse.jetty.ee10.webapp.AbstractConfiguration;
&nbsp;import org.eclipse.jetty.ee10.webapp.Configuration;
&nbsp;import org.eclipse.jetty.ee10.webapp.WebAppContext;
&nbsp;import org.eclipse.jetty.ee10.webapp.WebInfConfiguration;
&nbsp;import org.eclipse.jetty.http.CookieCompliance;
&nbsp;import org.eclipse.jetty.http.HttpCookie;
&nbsp;import org.eclipse.jetty.http.HttpField;
&nbsp;import org.eclipse.jetty.http.HttpFields;
&nbsp;import org.eclipse.jetty.http.HttpFields.Mutable;
&nbsp;import org.eclipse.jetty.http.HttpHeader;
&nbsp;import org.eclipse.jetty.http.MimeTypes;
&nbsp;import org.eclipse.jetty.http.MimeTypes.Wrapper;
&nbsp;import org.eclipse.jetty.http.SetCookieParser;
&nbsp;import org.eclipse.jetty.http2.server.HTTP2CServerConnectionFactory;
&nbsp;import org.eclipse.jetty.server.AbstractConnector;
&nbsp;import org.eclipse.jetty.server.ConnectionFactory;
&nbsp;import org.eclipse.jetty.server.ConnectionLimit;
&nbsp;import org.eclipse.jetty.server.Connector;
&nbsp;import org.eclipse.jetty.server.Handler;
&nbsp;import org.eclipse.jetty.server.HttpConfiguration;
&nbsp;import org.eclipse.jetty.server.HttpConnectionFactory;
&nbsp;import org.eclipse.jetty.server.HttpCookieUtils;
&nbsp;import org.eclipse.jetty.server.Request;
&nbsp;import org.eclipse.jetty.server.Response;
&nbsp;import org.eclipse.jetty.server.Server;
&nbsp;import org.eclipse.jetty.server.ServerConnector;
&nbsp;import org.eclipse.jetty.server.handler.StatisticsHandler;
&nbsp;import org.eclipse.jetty.session.DefaultSessionCache;
&nbsp;import org.eclipse.jetty.session.FileSessionDataStore;
&nbsp;import org.eclipse.jetty.util.Callback;
&nbsp;import org.eclipse.jetty.util.resource.CombinedResource;
&nbsp;import org.eclipse.jetty.util.resource.Resource;
&nbsp;import org.eclipse.jetty.util.resource.ResourceFactory;
&nbsp;import org.eclipse.jetty.util.resource.URLResourceFactory;
&nbsp;import org.eclipse.jetty.util.thread.ThreadPool;
&nbsp;
&nbsp;import org.springframework.boot.web.server.Cookie.SameSite;
&nbsp;import org.springframework.boot.web.server.ErrorPage;
&nbsp;import org.springframework.boot.web.server.MimeMappings;
&nbsp;import org.springframework.boot.web.server.Shutdown;
&nbsp;import org.springframework.boot.web.server.Ssl;
&nbsp;import org.springframework.boot.web.server.WebServer;
&nbsp;import org.springframework.boot.web.servlet.ServletContextInitializer;
&nbsp;import org.springframework.boot.web.servlet.server.AbstractServletWebServerFactory;
&nbsp;import org.springframework.boot.web.servlet.server.CookieSameSiteSupplier;
&nbsp;import org.springframework.boot.web.servlet.server.ServletWebServerFactory;
&nbsp;import org.springframework.context.ResourceLoaderAware;
&nbsp;import org.springframework.core.io.ResourceLoader;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * {@link ServletWebServerFactory} that can be used to create a {@link JettyWebServer}.
&nbsp; * Can be initialized using Spring&#39;s {@link ServletContextInitializer}s or Jetty
&nbsp; * {@link Configuration}s.
&nbsp; * &lt;p&gt;
&nbsp; * Unless explicitly configured otherwise this factory will create servers that listen for
&nbsp; * HTTP requests on port 8080.
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @author Dave Syer
&nbsp; * @author Andrey Hihlovskiy
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Eddú Meléndez
&nbsp; * @author Venil Noronha
&nbsp; * @author Henri Kerola
&nbsp; * @author Moritz Halbritter
&nbsp; * @author Onur Kagan Ozcan
&nbsp; * @since 2.0.0
&nbsp; * @see #setPort(int)
&nbsp; * @see #setConfigurations(Collection)
&nbsp; * @see JettyWebServer
&nbsp; */
&nbsp;public class JettyServletWebServerFactory extends AbstractServletWebServerFactory
&nbsp;		implements ConfigurableJettyWebServerFactory, ResourceLoaderAware {
&nbsp;
<b class="nc">&nbsp;	private List&lt;Configuration&gt; configurations = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;	private boolean useForwardHeaders;
&nbsp;
&nbsp;	/**
&nbsp;	 * The number of acceptor threads to use.
&nbsp;	 */
<b class="nc">&nbsp;	private int acceptors = -1;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * The number of selector threads to use.
&nbsp;	 */
<b class="nc">&nbsp;	private int selectors = -1;</b>
&nbsp;
<b class="nc">&nbsp;	private Set&lt;JettyServerCustomizer&gt; jettyServerCustomizers = new LinkedHashSet&lt;&gt;();</b>
&nbsp;
&nbsp;	private ResourceLoader resourceLoader;
&nbsp;
&nbsp;	private ThreadPool threadPool;
&nbsp;
<b class="nc">&nbsp;	private int maxConnections = -1;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link JettyServletWebServerFactory} instance.
&nbsp;	 */
<b class="nc">&nbsp;	public JettyServletWebServerFactory() {</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link JettyServletWebServerFactory} that listens for requests using
&nbsp;	 * the specified port.
&nbsp;	 * @param port the port to listen on
&nbsp;	 */
&nbsp;	public JettyServletWebServerFactory(int port) {
<b class="nc">&nbsp;		super(port);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link JettyServletWebServerFactory} with the specified context path
&nbsp;	 * and port.
&nbsp;	 * @param contextPath the root context path
&nbsp;	 * @param port the port to listen on
&nbsp;	 */
&nbsp;	public JettyServletWebServerFactory(String contextPath, int port) {
<b class="nc">&nbsp;		super(contextPath, port);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public WebServer getWebServer(ServletContextInitializer... initializers) {
<b class="nc">&nbsp;		JettyEmbeddedWebAppContext context = new JettyEmbeddedWebAppContext();</b>
<b class="nc">&nbsp;		context.getContext().getServletContext().setExtendedListenerTypes(true);</b>
<b class="nc">&nbsp;		int port = Math.max(getPort(), 0);</b>
<b class="nc">&nbsp;		InetSocketAddress address = new InetSocketAddress(getAddress(), port);</b>
<b class="nc">&nbsp;		Server server = createServer(address);</b>
<b class="nc">&nbsp;		context.setServer(server);</b>
<b class="nc">&nbsp;		configureWebAppContext(context, initializers);</b>
<b class="nc">&nbsp;		server.setHandler(addHandlerWrappers(context));</b>
<b class="nc">&nbsp;		this.logger.info(&quot;Server initialized with port: &quot; + port);</b>
<b class="nc">&nbsp;		if (this.maxConnections &gt; -1) {</b>
<b class="nc">&nbsp;			server.addBean(new ConnectionLimit(this.maxConnections, server.getConnectors()));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (Ssl.isEnabled(getSsl())) {</b>
<b class="nc">&nbsp;			customizeSsl(server, address);</b>
&nbsp;		}
<b class="nc">&nbsp;		for (JettyServerCustomizer customizer : getServerCustomizers()) {</b>
<b class="nc">&nbsp;			customizer.customize(server);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		if (this.useForwardHeaders) {</b>
<b class="nc">&nbsp;			new ForwardHeadersCustomizer().customize(server);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (getShutdown() == Shutdown.GRACEFUL) {</b>
<b class="nc">&nbsp;			StatisticsHandler statisticsHandler = new StatisticsHandler();</b>
<b class="nc">&nbsp;			statisticsHandler.setHandler(server.getHandler());</b>
<b class="nc">&nbsp;			server.setHandler(statisticsHandler);</b>
&nbsp;		}
<b class="nc">&nbsp;		return getJettyWebServer(server);</b>
&nbsp;	}
&nbsp;
&nbsp;	private Server createServer(InetSocketAddress address) {
<b class="nc">&nbsp;		Server server = new Server(getThreadPool());</b>
<b class="nc">&nbsp;		server.setConnectors(new Connector[] { createConnector(address, server) });</b>
<b class="nc">&nbsp;		server.setStopTimeout(0);</b>
<b class="nc">&nbsp;		MimeTypes.Mutable mimeTypes = server.getMimeTypes();</b>
<b class="nc">&nbsp;		for (MimeMappings.Mapping mapping : getMimeMappings()) {</b>
<b class="nc">&nbsp;			mimeTypes.addMimeMapping(mapping.getExtension(), mapping.getMimeType());</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return server;</b>
&nbsp;	}
&nbsp;
&nbsp;	private AbstractConnector createConnector(InetSocketAddress address, Server server) {
<b class="nc">&nbsp;		HttpConfiguration httpConfiguration = new HttpConfiguration();</b>
<b class="nc">&nbsp;		httpConfiguration.setSendServerVersion(false);</b>
<b class="nc">&nbsp;		List&lt;ConnectionFactory&gt; connectionFactories = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		connectionFactories.add(new HttpConnectionFactory(httpConfiguration));</b>
<b class="nc">&nbsp;		if (getHttp2() != null &amp;&amp; getHttp2().isEnabled()) {</b>
<b class="nc">&nbsp;			connectionFactories.add(new HTTP2CServerConnectionFactory(httpConfiguration));</b>
&nbsp;		}
<b class="nc">&nbsp;		ServerConnector connector = new ServerConnector(server, this.acceptors, this.selectors,</b>
<b class="nc">&nbsp;				connectionFactories.toArray(new ConnectionFactory[0]));</b>
<b class="nc">&nbsp;		connector.setHost(address.getHostString());</b>
<b class="nc">&nbsp;		connector.setPort(address.getPort());</b>
<b class="nc">&nbsp;		return connector;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Handler addHandlerWrappers(Handler handler) {
<b class="nc">&nbsp;		if (getCompression() != null &amp;&amp; getCompression().getEnabled()) {</b>
<b class="nc">&nbsp;			handler = applyWrapper(handler, JettyHandlerWrappers.createGzipHandlerWrapper(getCompression()));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (StringUtils.hasText(getServerHeader())) {</b>
<b class="nc">&nbsp;			handler = applyWrapper(handler, JettyHandlerWrappers.createServerHeaderHandlerWrapper(getServerHeader()));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (!CollectionUtils.isEmpty(getCookieSameSiteSuppliers())) {</b>
<b class="nc">&nbsp;			handler = applyWrapper(handler, new SuppliedSameSiteCookieHandlerWrapper(getCookieSameSiteSuppliers()));</b>
&nbsp;		}
<b class="nc">&nbsp;		return handler;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Handler applyWrapper(Handler handler, Handler.Wrapper wrapper) {
<b class="nc">&nbsp;		wrapper.setHandler(handler);</b>
<b class="nc">&nbsp;		return wrapper;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void customizeSsl(Server server, InetSocketAddress address) {
<b class="nc">&nbsp;		new SslServerCustomizer(getHttp2(), address, getSsl().getClientAuth(), getSslBundle()).customize(server);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Configure the given Jetty {@link WebAppContext} for use.
&nbsp;	 * @param context the context to configure
&nbsp;	 * @param initializers the set of initializers to apply
&nbsp;	 */
&nbsp;	protected final void configureWebAppContext(WebAppContext context, ServletContextInitializer... initializers) {
<b class="nc">&nbsp;		Assert.notNull(context, &quot;Context must not be null&quot;);</b>
<b class="nc">&nbsp;		context.clearAliasChecks();</b>
<b class="nc">&nbsp;		if (this.resourceLoader != null) {</b>
<b class="nc">&nbsp;			context.setClassLoader(this.resourceLoader.getClassLoader());</b>
&nbsp;		}
<b class="nc">&nbsp;		String contextPath = getContextPath();</b>
<b class="nc">&nbsp;		context.setContextPath(StringUtils.hasLength(contextPath) ? contextPath : &quot;/&quot;);</b>
<b class="nc">&nbsp;		context.setDisplayName(getDisplayName());</b>
<b class="nc">&nbsp;		configureDocumentRoot(context);</b>
<b class="nc">&nbsp;		if (isRegisterDefaultServlet()) {</b>
<b class="nc">&nbsp;			addDefaultServlet(context);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (shouldRegisterJspServlet()) {</b>
<b class="nc">&nbsp;			addJspServlet(context);</b>
<b class="nc">&nbsp;			context.addBean(new JasperInitializer(context), true);</b>
&nbsp;		}
<b class="nc">&nbsp;		addLocaleMappings(context);</b>
<b class="nc">&nbsp;		ServletContextInitializer[] initializersToUse = mergeInitializers(initializers);</b>
<b class="nc">&nbsp;		Configuration[] configurations = getWebAppContextConfigurations(context, initializersToUse);</b>
<b class="nc">&nbsp;		context.setConfigurations(configurations);</b>
<b class="nc">&nbsp;		context.setThrowUnavailableOnStartupException(true);</b>
<b class="nc">&nbsp;		configureSession(context);</b>
<b class="nc">&nbsp;		context.setTempDirectory(getTempDirectory(context));</b>
<b class="nc">&nbsp;		postProcessWebAppContext(context);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureSession(WebAppContext context) {
<b class="nc">&nbsp;		SessionHandler handler = context.getSessionHandler();</b>
<b class="nc">&nbsp;		SameSite sessionSameSite = getSession().getCookie().getSameSite();</b>
<b class="nc">&nbsp;		if (sessionSameSite != null) {</b>
<b class="nc">&nbsp;			handler.setSameSite(HttpCookie.SameSite.valueOf(sessionSameSite.name()));</b>
&nbsp;		}
<b class="nc">&nbsp;		Duration sessionTimeout = getSession().getTimeout();</b>
<b class="nc">&nbsp;		handler.setMaxInactiveInterval(isNegative(sessionTimeout) ? -1 : (int) sessionTimeout.getSeconds());</b>
<b class="nc">&nbsp;		if (getSession().isPersistent()) {</b>
<b class="nc">&nbsp;			DefaultSessionCache cache = new DefaultSessionCache(handler);</b>
<b class="nc">&nbsp;			FileSessionDataStore store = new FileSessionDataStore();</b>
<b class="nc">&nbsp;			store.setStoreDir(getValidSessionStoreDir());</b>
<b class="nc">&nbsp;			cache.setSessionDataStore(store);</b>
<b class="nc">&nbsp;			handler.setSessionCache(cache);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private boolean isNegative(Duration sessionTimeout) {
<b class="nc">&nbsp;		return sessionTimeout == null || sessionTimeout.isNegative();</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addLocaleMappings(WebAppContext context) {
<b class="nc">&nbsp;		getLocaleCharsetMappings()</b>
<b class="nc">&nbsp;			.forEach((locale, charset) -&gt; context.addLocaleEncoding(locale.toString(), charset.toString()));</b>
&nbsp;	}
&nbsp;
&nbsp;	private File getTempDirectory(WebAppContext context) {
<b class="nc">&nbsp;		String temp = System.getProperty(&quot;java.io.tmpdir&quot;);</b>
<b class="nc">&nbsp;		return (temp != null)</b>
<b class="nc">&nbsp;				? new File(temp, WebInfConfiguration.getCanonicalNameForWebAppTmpDir(context) + UUID.randomUUID())</b>
<b class="nc">&nbsp;				: null;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureDocumentRoot(WebAppContext handler) {
<b class="nc">&nbsp;		File root = getValidDocumentRoot();</b>
<b class="nc">&nbsp;		File docBase = (root != null) ? root : createTempDir(&quot;jetty-docbase&quot;);</b>
&nbsp;		try {
<b class="nc">&nbsp;			ResourceFactory resourceFactory = handler.getResourceFactory();</b>
<b class="nc">&nbsp;			List&lt;Resource&gt; resources = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;			Resource rootResource = (docBase.isDirectory()</b>
<b class="nc">&nbsp;					? resourceFactory.newResource(docBase.getCanonicalFile().toURI())</b>
<b class="nc">&nbsp;					: resourceFactory.newJarFileResource(docBase.toURI()));</b>
<b class="nc">&nbsp;			resources.add((root != null) ? new LoaderHidingResource(rootResource, rootResource) : rootResource);</b>
<b class="nc">&nbsp;			URLResourceFactory urlResourceFactory = new URLResourceFactory();</b>
<b class="nc">&nbsp;			for (URL resourceJarUrl : getUrlsOfJarsWithMetaInfResources()) {</b>
<b class="nc">&nbsp;				Resource resource = createResource(resourceJarUrl, resourceFactory, urlResourceFactory);</b>
<b class="nc">&nbsp;				if (resource != null) {</b>
<b class="nc">&nbsp;					resources.add(resource);</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			handler.setBaseResource(ResourceFactory.combine(resources));</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(ex);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private Resource createResource(URL url, ResourceFactory resourceFactory, URLResourceFactory urlResourceFactory)
&nbsp;			throws Exception {
<b class="nc">&nbsp;		if (&quot;file&quot;.equals(url.getProtocol())) {</b>
<b class="nc">&nbsp;			File file = new File(url.toURI());</b>
<b class="nc">&nbsp;			if (file.isFile()) {</b>
<b class="nc">&nbsp;				return resourceFactory.newResource(&quot;jar:&quot; + url + &quot;!/META-INF/resources/&quot;);</b>
&nbsp;			}
<b class="nc">&nbsp;			if (file.isDirectory()) {</b>
<b class="nc">&nbsp;				return resourceFactory.newResource(url).resolve(&quot;META-INF/resources/&quot;);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		return urlResourceFactory.newResource(url + &quot;META-INF/resources/&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add Jetty&#39;s {@code DefaultServlet} to the given {@link WebAppContext}.
&nbsp;	 * @param context the jetty {@link WebAppContext}
&nbsp;	 */
&nbsp;	protected final void addDefaultServlet(WebAppContext context) {
<b class="nc">&nbsp;		Assert.notNull(context, &quot;Context must not be null&quot;);</b>
<b class="nc">&nbsp;		ServletHolder holder = new ServletHolder();</b>
<b class="nc">&nbsp;		holder.setName(&quot;default&quot;);</b>
<b class="nc">&nbsp;		holder.setClassName(&quot;org.eclipse.jetty.ee10.servlet.DefaultServlet&quot;);</b>
<b class="nc">&nbsp;		holder.setInitParameter(&quot;dirAllowed&quot;, &quot;false&quot;);</b>
<b class="nc">&nbsp;		holder.setInitOrder(1);</b>
<b class="nc">&nbsp;		context.getServletHandler().addServletWithMapping(holder, &quot;/&quot;);</b>
<b class="nc">&nbsp;		ServletMapping servletMapping = context.getServletHandler().getServletMapping(&quot;/&quot;);</b>
<b class="nc">&nbsp;		servletMapping.setFromDefaultDescriptor(true);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add Jetty&#39;s {@code JspServlet} to the given {@link WebAppContext}.
&nbsp;	 * @param context the jetty {@link WebAppContext}
&nbsp;	 */
&nbsp;	protected final void addJspServlet(WebAppContext context) {
<b class="nc">&nbsp;		Assert.notNull(context, &quot;Context must not be null&quot;);</b>
<b class="nc">&nbsp;		ServletHolder holder = new ServletHolder();</b>
<b class="nc">&nbsp;		holder.setName(&quot;jsp&quot;);</b>
<b class="nc">&nbsp;		holder.setClassName(getJsp().getClassName());</b>
<b class="nc">&nbsp;		holder.setInitParameter(&quot;fork&quot;, &quot;false&quot;);</b>
<b class="nc">&nbsp;		holder.setInitParameters(getJsp().getInitParameters());</b>
<b class="nc">&nbsp;		holder.setInitOrder(3);</b>
<b class="nc">&nbsp;		context.getServletHandler().addServlet(holder);</b>
<b class="nc">&nbsp;		ServletMapping mapping = new ServletMapping();</b>
<b class="nc">&nbsp;		mapping.setServletName(&quot;jsp&quot;);</b>
<b class="nc">&nbsp;		mapping.setPathSpecs(new String[] { &quot;*.jsp&quot;, &quot;*.jspx&quot; });</b>
<b class="nc">&nbsp;		context.getServletHandler().addServletMapping(mapping);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Return the Jetty {@link Configuration}s that should be applied to the server.
&nbsp;	 * @param webAppContext the Jetty {@link WebAppContext}
&nbsp;	 * @param initializers the {@link ServletContextInitializer}s to apply
&nbsp;	 * @return configurations to apply
&nbsp;	 */
&nbsp;	protected Configuration[] getWebAppContextConfigurations(WebAppContext webAppContext,
&nbsp;			ServletContextInitializer... initializers) {
<b class="nc">&nbsp;		List&lt;Configuration&gt; configurations = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		configurations.add(getServletContextInitializerConfiguration(webAppContext, initializers));</b>
<b class="nc">&nbsp;		configurations.add(getErrorPageConfiguration());</b>
<b class="nc">&nbsp;		configurations.add(getMimeTypeConfiguration());</b>
<b class="nc">&nbsp;		configurations.add(new WebListenersConfiguration(getWebListenerClassNames()));</b>
<b class="nc">&nbsp;		configurations.addAll(getConfigurations());</b>
<b class="nc">&nbsp;		return configurations.toArray(new Configuration[0]);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a configuration object that adds error handlers.
&nbsp;	 * @return a configuration object for adding error pages
&nbsp;	 */
&nbsp;	private Configuration getErrorPageConfiguration() {
<b class="nc">&nbsp;		return new AbstractConfiguration(new AbstractConfiguration.Builder()) {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void configure(WebAppContext context) throws Exception {
<b class="nc">&nbsp;				JettyEmbeddedErrorHandler errorHandler = new JettyEmbeddedErrorHandler();</b>
<b class="nc">&nbsp;				context.setErrorHandler(errorHandler);</b>
<b class="nc">&nbsp;				addJettyErrorPages(errorHandler, getErrorPages());</b>
&nbsp;			}
&nbsp;
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a configuration object that adds mime type mappings.
&nbsp;	 * @return a configuration object for adding mime type mappings
&nbsp;	 */
&nbsp;	private Configuration getMimeTypeConfiguration() {
<b class="nc">&nbsp;		return new AbstractConfiguration(new AbstractConfiguration.Builder()) {</b>
&nbsp;
&nbsp;			@Override
&nbsp;			public void configure(WebAppContext context) throws Exception {
<b class="nc">&nbsp;				MimeTypes.Wrapper mimeTypes = (Wrapper) context.getMimeTypes();</b>
<b class="nc">&nbsp;				mimeTypes.setWrapped(new MimeTypes(null));</b>
<b class="nc">&nbsp;				for (MimeMappings.Mapping mapping : getMimeMappings()) {</b>
<b class="nc">&nbsp;					mimeTypes.addMimeMapping(mapping.getExtension(), mapping.getMimeType());</b>
<b class="nc">&nbsp;				}</b>
&nbsp;			}
&nbsp;
&nbsp;		};
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Return a Jetty {@link Configuration} that will invoke the specified
&nbsp;	 * {@link ServletContextInitializer}s. By default this method will return a
&nbsp;	 * {@link ServletContextInitializerConfiguration}.
&nbsp;	 * @param webAppContext the Jetty {@link WebAppContext}
&nbsp;	 * @param initializers the {@link ServletContextInitializer}s to apply
&nbsp;	 * @return the {@link Configuration} instance
&nbsp;	 */
&nbsp;	protected Configuration getServletContextInitializerConfiguration(WebAppContext webAppContext,
&nbsp;			ServletContextInitializer... initializers) {
<b class="nc">&nbsp;		return new ServletContextInitializerConfiguration(initializers);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Post process the Jetty {@link WebAppContext} before it&#39;s used with the Jetty
&nbsp;	 * Server. Subclasses can override this method to apply additional processing to the
&nbsp;	 * {@link WebAppContext}.
&nbsp;	 * @param webAppContext the Jetty {@link WebAppContext}
&nbsp;	 */
&nbsp;	protected void postProcessWebAppContext(WebAppContext webAppContext) {
<b class="nc">&nbsp;	}</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Factory method called to create the {@link JettyWebServer}. Subclasses can override
&nbsp;	 * this method to return a different {@link JettyWebServer} or apply additional
&nbsp;	 * processing to the Jetty server.
&nbsp;	 * @param server the Jetty server.
&nbsp;	 * @return a new {@link JettyWebServer} instance
&nbsp;	 */
&nbsp;	protected JettyWebServer getJettyWebServer(Server server) {
<b class="nc">&nbsp;		return new JettyWebServer(server, getPort() &gt;= 0);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setResourceLoader(ResourceLoader resourceLoader) {
<b class="nc">&nbsp;		this.resourceLoader = resourceLoader;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setUseForwardHeaders(boolean useForwardHeaders) {
<b class="nc">&nbsp;		this.useForwardHeaders = useForwardHeaders;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setAcceptors(int acceptors) {
<b class="nc">&nbsp;		this.acceptors = acceptors;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setSelectors(int selectors) {
<b class="nc">&nbsp;		this.selectors = selectors;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setMaxConnections(int maxConnections) {
<b class="nc">&nbsp;		this.maxConnections = maxConnections;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Sets {@link JettyServerCustomizer}s that will be applied to the {@link Server}
&nbsp;	 * before it is started. Calling this method will replace any existing customizers.
&nbsp;	 * @param customizers the Jetty customizers to apply
&nbsp;	 */
&nbsp;	public void setServerCustomizers(Collection&lt;? extends JettyServerCustomizer&gt; customizers) {
<b class="nc">&nbsp;		Assert.notNull(customizers, &quot;Customizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.jettyServerCustomizers = new LinkedHashSet&lt;&gt;(customizers);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of Jetty {@link JettyServerCustomizer}s that will be
&nbsp;	 * applied to the {@link Server} before it is created.
&nbsp;	 * @return the {@link JettyServerCustomizer}s
&nbsp;	 */
&nbsp;	public Collection&lt;JettyServerCustomizer&gt; getServerCustomizers() {
<b class="nc">&nbsp;		return this.jettyServerCustomizers;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void addServerCustomizers(JettyServerCustomizer... customizers) {
<b class="nc">&nbsp;		Assert.notNull(customizers, &quot;Customizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.jettyServerCustomizers.addAll(Arrays.asList(customizers));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Sets Jetty {@link Configuration}s that will be applied to the {@link WebAppContext}
&nbsp;	 * before the server is created. Calling this method will replace any existing
&nbsp;	 * configurations.
&nbsp;	 * @param configurations the Jetty configurations to apply
&nbsp;	 */
&nbsp;	public void setConfigurations(Collection&lt;? extends Configuration&gt; configurations) {
<b class="nc">&nbsp;		Assert.notNull(configurations, &quot;Configurations must not be null&quot;);</b>
<b class="nc">&nbsp;		this.configurations = new ArrayList&lt;&gt;(configurations);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of Jetty {@link Configuration}s that will be applied
&nbsp;	 * to the {@link WebAppContext} before the server is created.
&nbsp;	 * @return the Jetty {@link Configuration}s
&nbsp;	 */
&nbsp;	public Collection&lt;Configuration&gt; getConfigurations() {
<b class="nc">&nbsp;		return this.configurations;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add {@link Configuration}s that will be applied to the {@link WebAppContext} before
&nbsp;	 * the server is started.
&nbsp;	 * @param configurations the configurations to add
&nbsp;	 */
&nbsp;	public void addConfigurations(Configuration... configurations) {
<b class="nc">&nbsp;		Assert.notNull(configurations, &quot;Configurations must not be null&quot;);</b>
<b class="nc">&nbsp;		this.configurations.addAll(Arrays.asList(configurations));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a Jetty {@link ThreadPool} that should be used by the {@link Server}.
&nbsp;	 * @return a Jetty {@link ThreadPool} or {@code null}
&nbsp;	 */
&nbsp;	public ThreadPool getThreadPool() {
<b class="nc">&nbsp;		return this.threadPool;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setThreadPool(ThreadPool threadPool) {
<b class="nc">&nbsp;		this.threadPool = threadPool;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addJettyErrorPages(ErrorHandler errorHandler, Collection&lt;ErrorPage&gt; errorPages) {
<b class="nc">&nbsp;		if (errorHandler instanceof ErrorPageErrorHandler handler) {</b>
<b class="nc">&nbsp;			for (ErrorPage errorPage : errorPages) {</b>
<b class="nc">&nbsp;				if (errorPage.isGlobal()) {</b>
<b class="nc">&nbsp;					handler.addErrorPage(ErrorPageErrorHandler.GLOBAL_ERROR_PAGE, errorPage.getPath());</b>
&nbsp;				}
&nbsp;				else {
<b class="nc">&nbsp;					if (errorPage.getExceptionName() != null) {</b>
<b class="nc">&nbsp;						handler.addErrorPage(errorPage.getExceptionName(), errorPage.getPath());</b>
&nbsp;					}
&nbsp;					else {
<b class="nc">&nbsp;						handler.addErrorPage(errorPage.getStatusCode(), errorPage.getPath());</b>
&nbsp;					}
&nbsp;				}
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private static final class LoaderHidingResource extends Resource {
&nbsp;
&nbsp;		private static final String LOADER_RESOURCE_PATH_PREFIX = &quot;/org/springframework/boot/&quot;;
&nbsp;
&nbsp;		private final Resource base;
&nbsp;
&nbsp;		private final Resource delegate;
&nbsp;
<b class="nc">&nbsp;		private LoaderHidingResource(Resource base, Resource delegate) {</b>
<b class="nc">&nbsp;			this.base = base;</b>
<b class="nc">&nbsp;			this.delegate = delegate;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void forEach(Consumer&lt;? super Resource&gt; action) {
<b class="nc">&nbsp;			this.delegate.forEach(action);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Path getPath() {
<b class="nc">&nbsp;			return this.delegate.getPath();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean isContainedIn(Resource r) {
<b class="nc">&nbsp;			return this.delegate.isContainedIn(r);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Iterator&lt;Resource&gt; iterator() {
<b class="nc">&nbsp;			if (this.delegate instanceof CombinedResource) {</b>
<b class="nc">&nbsp;				return list().iterator();</b>
&nbsp;			}
<b class="nc">&nbsp;			return List.&lt;Resource&gt;of(this).iterator();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean equals(Object obj) {
<b class="nc">&nbsp;			return this.delegate.equals(obj);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public int hashCode() {
<b class="nc">&nbsp;			return this.delegate.hashCode();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean exists() {
<b class="nc">&nbsp;			return this.delegate.exists();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Spliterator&lt;Resource&gt; spliterator() {
<b class="nc">&nbsp;			return this.delegate.spliterator();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean isDirectory() {
<b class="nc">&nbsp;			return this.delegate.isDirectory();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean isReadable() {
<b class="nc">&nbsp;			return this.delegate.isReadable();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Instant lastModified() {
<b class="nc">&nbsp;			return this.delegate.lastModified();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public long length() {
<b class="nc">&nbsp;			return this.delegate.length();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public URI getURI() {
<b class="nc">&nbsp;			return this.delegate.getURI();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getName() {
<b class="nc">&nbsp;			return this.delegate.getName();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String getFileName() {
<b class="nc">&nbsp;			return this.delegate.getFileName();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public InputStream newInputStream() throws IOException {
<b class="nc">&nbsp;			return this.delegate.newInputStream();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public ReadableByteChannel newReadableByteChannel() throws IOException {
<b class="nc">&nbsp;			return this.delegate.newReadableByteChannel();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public List&lt;Resource&gt; list() {
<b class="nc">&nbsp;			return this.delegate.list().stream().filter(this::nonLoaderResource).toList();</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean nonLoaderResource(Resource resource) {
<b class="nc">&nbsp;			Path prefix = this.base.getPath().resolve(Path.of(&quot;org&quot;, &quot;springframework&quot;, &quot;boot&quot;));</b>
<b class="nc">&nbsp;			return !resource.getPath().startsWith(prefix);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Resource resolve(String subUriPath) {
<b class="nc">&nbsp;			if (subUriPath.startsWith(LOADER_RESOURCE_PATH_PREFIX)) {</b>
<b class="nc">&nbsp;				return null;</b>
&nbsp;			}
<b class="nc">&nbsp;			Resource resolved = this.delegate.resolve(subUriPath);</b>
<b class="nc">&nbsp;			return (resolved != null) ? new LoaderHidingResource(this.base, resolved) : null;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean isAlias() {
<b class="nc">&nbsp;			return this.delegate.isAlias();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public URI getRealURI() {
<b class="nc">&nbsp;			return this.delegate.getRealURI();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void copyTo(Path destination) throws IOException {
<b class="nc">&nbsp;			this.delegate.copyTo(destination);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Collection&lt;Resource&gt; getAllResources() {
<b class="nc">&nbsp;			return this.delegate.getAllResources().stream().filter(this::nonLoaderResource).toList();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String toString() {
<b class="nc">&nbsp;			return this.delegate.toString();</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link AbstractConfiguration} to apply {@code @WebListener} classes.
&nbsp;	 */
&nbsp;	private static class WebListenersConfiguration extends AbstractConfiguration {
&nbsp;
&nbsp;		private final Set&lt;String&gt; classNames;
&nbsp;
&nbsp;		WebListenersConfiguration(Set&lt;String&gt; webListenerClassNames) {
<b class="nc">&nbsp;			super(new AbstractConfiguration.Builder());</b>
<b class="nc">&nbsp;			this.classNames = webListenerClassNames;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void configure(WebAppContext context) throws Exception {
<b class="nc">&nbsp;			ServletHandler servletHandler = context.getServletHandler();</b>
<b class="nc">&nbsp;			for (String className : this.classNames) {</b>
<b class="nc">&nbsp;				configure(context, servletHandler, className);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private void configure(WebAppContext context, ServletHandler servletHandler, String className)
&nbsp;				throws ClassNotFoundException {
<b class="nc">&nbsp;			ListenerHolder holder = servletHandler.newListenerHolder(new Source(Source.Origin.ANNOTATION, className));</b>
<b class="nc">&nbsp;			holder.setHeldClass(loadClass(context, className));</b>
<b class="nc">&nbsp;			servletHandler.addListener(holder);</b>
&nbsp;		}
&nbsp;
&nbsp;		@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;		private Class&lt;? extends EventListener&gt; loadClass(WebAppContext context, String className)
&nbsp;				throws ClassNotFoundException {
<b class="nc">&nbsp;			ClassLoader classLoader = context.getClassLoader();</b>
<b class="nc">&nbsp;			classLoader = (classLoader != null) ? classLoader : getClass().getClassLoader();</b>
<b class="nc">&nbsp;			return (Class&lt;? extends EventListener&gt;) classLoader.loadClass(className);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link Handler.Wrapper} to apply {@link CookieSameSiteSupplier supplied}
&nbsp;	 * {@link SameSite} cookie values.
&nbsp;	 */
&nbsp;	private static class SuppliedSameSiteCookieHandlerWrapper extends Handler.Wrapper {
&nbsp;
<b class="nc">&nbsp;		private static final SetCookieParser setCookieParser = SetCookieParser.newInstance();</b>
&nbsp;
&nbsp;		private final List&lt;CookieSameSiteSupplier&gt; suppliers;
&nbsp;
<b class="nc">&nbsp;		SuppliedSameSiteCookieHandlerWrapper(List&lt;CookieSameSiteSupplier&gt; suppliers) {</b>
<b class="nc">&nbsp;			this.suppliers = suppliers;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean handle(Request request, Response response, Callback callback) throws Exception {
<b class="nc">&nbsp;			SuppliedSameSiteCookieResponse wrappedResponse = new SuppliedSameSiteCookieResponse(request, response);</b>
<b class="nc">&nbsp;			return super.handle(request, wrappedResponse, callback);</b>
&nbsp;		}
&nbsp;
&nbsp;		private class SuppliedSameSiteCookieResponse extends Response.Wrapper {
&nbsp;
&nbsp;			private HttpFields.Mutable wrappedHeaders;
&nbsp;
<b class="nc">&nbsp;			SuppliedSameSiteCookieResponse(Request request, Response wrapped) {</b>
<b class="nc">&nbsp;				super(request, wrapped);</b>
<b class="nc">&nbsp;				this.wrappedHeaders = new SuppliedSameSiteCookieHeaders(</b>
<b class="nc">&nbsp;						request.getConnectionMetaData().getHttpConfiguration().getResponseCookieCompliance(),</b>
<b class="nc">&nbsp;						wrapped.getHeaders());</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public Mutable getHeaders() {
<b class="nc">&nbsp;				return this.wrappedHeaders;</b>
&nbsp;			}
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;		private class SuppliedSameSiteCookieHeaders extends HttpFields.Mutable.Wrapper {
&nbsp;
&nbsp;			private final CookieCompliance compliance;
&nbsp;
<b class="nc">&nbsp;			SuppliedSameSiteCookieHeaders(CookieCompliance compliance, HttpFields.Mutable fields) {</b>
<b class="nc">&nbsp;				super(fields);</b>
<b class="nc">&nbsp;				this.compliance = compliance;</b>
&nbsp;			}
&nbsp;
&nbsp;			@Override
&nbsp;			public HttpField onAddField(HttpField field) {
<b class="nc">&nbsp;				return (field.getHeader() != HttpHeader.SET_COOKIE) ? field : onAddSetCookieField(field);</b>
&nbsp;			}
&nbsp;
&nbsp;			private HttpField onAddSetCookieField(HttpField field) {
<b class="nc">&nbsp;				HttpCookie cookie = setCookieParser.parse(field.getValue());</b>
<b class="nc">&nbsp;				SameSite sameSite = (cookie != null) ? getSameSite(cookie) : null;</b>
<b class="nc">&nbsp;				if (sameSite == null) {</b>
<b class="nc">&nbsp;					return field;</b>
&nbsp;				}
<b class="nc">&nbsp;				HttpCookie updatedCookie = buildCookieWithUpdatedSameSite(cookie, sameSite);</b>
<b class="nc">&nbsp;				return new HttpCookieUtils.SetCookieHttpField(updatedCookie, this.compliance);</b>
&nbsp;			}
&nbsp;
&nbsp;			private HttpCookie buildCookieWithUpdatedSameSite(HttpCookie cookie, SameSite sameSite) {
<b class="nc">&nbsp;				return HttpCookie.build(cookie)</b>
<b class="nc">&nbsp;					.sameSite(org.eclipse.jetty.http.HttpCookie.SameSite.from(sameSite.name()))</b>
<b class="nc">&nbsp;					.build();</b>
&nbsp;			}
&nbsp;
&nbsp;			private SameSite getSameSite(HttpCookie cookie) {
<b class="nc">&nbsp;				return getSameSite(asServletCookie(cookie));</b>
&nbsp;			}
&nbsp;
&nbsp;			private SameSite getSameSite(Cookie cookie) {
<b class="nc">&nbsp;				return SuppliedSameSiteCookieHandlerWrapper.this.suppliers.stream()</b>
<b class="nc">&nbsp;					.map((supplier) -&gt; supplier.getSameSite(cookie))</b>
<b class="nc">&nbsp;					.filter(Objects::nonNull)</b>
<b class="nc">&nbsp;					.findFirst()</b>
<b class="nc">&nbsp;					.orElse(null);</b>
&nbsp;			}
&nbsp;
&nbsp;			private Cookie asServletCookie(HttpCookie cookie) {
<b class="nc">&nbsp;				Cookie servletCookie = new Cookie(cookie.getName(), cookie.getValue());</b>
<b class="nc">&nbsp;				cookie.getAttributes().forEach(servletCookie::setAttribute);</b>
<b class="nc">&nbsp;				return servletCookie;</b>
&nbsp;			}
&nbsp;
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-28 21:28</div>
</div>
</body>
</html>
