


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > SslServerCustomizer</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.web.embedded.jetty</a>
</div>

<h1>Coverage Summary for Class: SslServerCustomizer (org.springframework.boot.web.embedded.jetty)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">SslServerCustomizer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/69)
  </span>
</td>
</tr>
  <tr>
    <td class="name">SslServerCustomizer$SslValidatingServerConnector</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/77)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.web.embedded.jetty;
&nbsp;
&nbsp;import java.net.InetSocketAddress;
&nbsp;
&nbsp;import org.eclipse.jetty.alpn.server.ALPNServerConnectionFactory;
&nbsp;import org.eclipse.jetty.http.HttpVersion;
&nbsp;import org.eclipse.jetty.http2.HTTP2Cipher;
&nbsp;import org.eclipse.jetty.http2.server.HTTP2ServerConnectionFactory;
&nbsp;import org.eclipse.jetty.server.ConnectionFactory;
&nbsp;import org.eclipse.jetty.server.Connector;
&nbsp;import org.eclipse.jetty.server.HttpConfiguration;
&nbsp;import org.eclipse.jetty.server.HttpConnectionFactory;
&nbsp;import org.eclipse.jetty.server.SecureRequestCustomizer;
&nbsp;import org.eclipse.jetty.server.Server;
&nbsp;import org.eclipse.jetty.server.ServerConnector;
&nbsp;import org.eclipse.jetty.server.SslConnectionFactory;
&nbsp;import org.eclipse.jetty.util.ssl.SslContextFactory;
&nbsp;
&nbsp;import org.springframework.boot.ssl.SslBundle;
&nbsp;import org.springframework.boot.ssl.SslBundleKey;
&nbsp;import org.springframework.boot.ssl.SslOptions;
&nbsp;import org.springframework.boot.ssl.SslStoreBundle;
&nbsp;import org.springframework.boot.web.server.Http2;
&nbsp;import org.springframework.boot.web.server.Ssl.ClientAuth;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;
&nbsp;/**
&nbsp; * {@link JettyServerCustomizer} that configures SSL on the given Jetty server instance.
&nbsp; *
&nbsp; * @author Brian Clozel
&nbsp; * @author Olivier Lamy
&nbsp; * @author Chris Bono
&nbsp; * @author Cyril Dangerville
&nbsp; * @author Scott Frederick
&nbsp; */
&nbsp;class SslServerCustomizer implements JettyServerCustomizer {
&nbsp;
&nbsp;	private final Http2 http2;
&nbsp;
&nbsp;	private final InetSocketAddress address;
&nbsp;
&nbsp;	private final ClientAuth clientAuth;
&nbsp;
&nbsp;	private final SslBundle sslBundle;
&nbsp;
<b class="nc">&nbsp;	SslServerCustomizer(Http2 http2, InetSocketAddress address, ClientAuth clientAuth, SslBundle sslBundle) {</b>
<b class="nc">&nbsp;		this.address = address;</b>
<b class="nc">&nbsp;		this.clientAuth = clientAuth;</b>
<b class="nc">&nbsp;		this.sslBundle = sslBundle;</b>
<b class="nc">&nbsp;		this.http2 = http2;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void customize(Server server) {
<b class="nc">&nbsp;		SslContextFactory.Server sslContextFactory = new SslContextFactory.Server();</b>
<b class="nc">&nbsp;		sslContextFactory.setEndpointIdentificationAlgorithm(null);</b>
<b class="nc">&nbsp;		configureSsl(sslContextFactory, this.clientAuth);</b>
<b class="nc">&nbsp;		ServerConnector connector = createConnector(server, sslContextFactory);</b>
<b class="nc">&nbsp;		server.setConnectors(new Connector[] { connector });</b>
&nbsp;	}
&nbsp;
&nbsp;	private ServerConnector createConnector(Server server, SslContextFactory.Server sslContextFactory) {
<b class="nc">&nbsp;		HttpConfiguration config = new HttpConfiguration();</b>
<b class="nc">&nbsp;		config.setSendServerVersion(false);</b>
<b class="nc">&nbsp;		config.setSecureScheme(&quot;https&quot;);</b>
<b class="nc">&nbsp;		config.setSecurePort(this.address.getPort());</b>
<b class="nc">&nbsp;		config.addCustomizer(new SecureRequestCustomizer());</b>
<b class="nc">&nbsp;		ServerConnector connector = createServerConnector(server, sslContextFactory, config);</b>
<b class="nc">&nbsp;		connector.setPort(this.address.getPort());</b>
<b class="nc">&nbsp;		connector.setHost(this.address.getHostString());</b>
<b class="nc">&nbsp;		return connector;</b>
&nbsp;	}
&nbsp;
&nbsp;	private ServerConnector createServerConnector(Server server, SslContextFactory.Server sslContextFactory,
&nbsp;			HttpConfiguration config) {
<b class="nc">&nbsp;		if (this.http2 == null || !this.http2.isEnabled()) {</b>
<b class="nc">&nbsp;			return createHttp11ServerConnector(config, sslContextFactory, server);</b>
&nbsp;		}
<b class="nc">&nbsp;		Assert.state(isJettyAlpnPresent(),</b>
<b class="nc">&nbsp;				() -&gt; &quot;An &#39;org.eclipse.jetty:jetty-alpn-*-server&#39; dependency is required for HTTP/2 support.&quot;);</b>
<b class="nc">&nbsp;		Assert.state(isJettyHttp2Present(),</b>
<b class="nc">&nbsp;				() -&gt; &quot;The &#39;org.eclipse.jetty.http2:jetty-http2-server&#39; dependency is required for HTTP/2 support.&quot;);</b>
<b class="nc">&nbsp;		return createHttp2ServerConnector(config, sslContextFactory, server);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ServerConnector createHttp11ServerConnector(HttpConfiguration config,
&nbsp;			SslContextFactory.Server sslContextFactory, Server server) {
<b class="nc">&nbsp;		SslConnectionFactory sslConnectionFactory = createSslConnectionFactory(sslContextFactory,</b>
<b class="nc">&nbsp;				HttpVersion.HTTP_1_1.asString());</b>
<b class="nc">&nbsp;		HttpConnectionFactory connectionFactory = new HttpConnectionFactory(config);</b>
<b class="nc">&nbsp;		return new SslValidatingServerConnector(this.sslBundle.getKey(), sslContextFactory, server,</b>
&nbsp;				sslConnectionFactory, connectionFactory);
&nbsp;	}
&nbsp;
&nbsp;	private SslConnectionFactory createSslConnectionFactory(SslContextFactory.Server sslContextFactory,
&nbsp;			String protocol) {
<b class="nc">&nbsp;		return new SslConnectionFactory(sslContextFactory, protocol);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isJettyAlpnPresent() {
<b class="nc">&nbsp;		return ClassUtils.isPresent(&quot;org.eclipse.jetty.alpn.server.ALPNServerConnectionFactory&quot;, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isJettyHttp2Present() {
<b class="nc">&nbsp;		return ClassUtils.isPresent(&quot;org.eclipse.jetty.http2.server.HTTP2ServerConnectionFactory&quot;, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	private ServerConnector createHttp2ServerConnector(HttpConfiguration config,
&nbsp;			SslContextFactory.Server sslContextFactory, Server server) {
<b class="nc">&nbsp;		HttpConnectionFactory http = new HttpConnectionFactory(config);</b>
<b class="nc">&nbsp;		HTTP2ServerConnectionFactory h2 = new HTTP2ServerConnectionFactory(config);</b>
<b class="nc">&nbsp;		ALPNServerConnectionFactory alpn = createAlpnServerConnectionFactory();</b>
<b class="nc">&nbsp;		sslContextFactory.setCipherComparator(HTTP2Cipher.COMPARATOR);</b>
<b class="nc">&nbsp;		if (isConscryptPresent()) {</b>
<b class="nc">&nbsp;			sslContextFactory.setProvider(&quot;Conscrypt&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		SslConnectionFactory sslConnectionFactory = createSslConnectionFactory(sslContextFactory, alpn.getProtocol());</b>
<b class="nc">&nbsp;		return new SslValidatingServerConnector(this.sslBundle.getKey(), sslContextFactory, server,</b>
&nbsp;				sslConnectionFactory, alpn, h2, http);
&nbsp;	}
&nbsp;
&nbsp;	private ALPNServerConnectionFactory createAlpnServerConnectionFactory() {
&nbsp;		try {
<b class="nc">&nbsp;			return new ALPNServerConnectionFactory();</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IllegalStateException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(</b>
&nbsp;					&quot;An &#39;org.eclipse.jetty:jetty-alpn-*-server&#39; dependency is required for HTTP/2 support.&quot;, ex);
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private boolean isConscryptPresent() {
<b class="nc">&nbsp;		return ClassUtils.isPresent(&quot;org.conscrypt.Conscrypt&quot;, null)</b>
<b class="nc">&nbsp;				&amp;&amp; ClassUtils.isPresent(&quot;org.eclipse.jetty.alpn.conscrypt.server.ConscryptServerALPNProcessor&quot;, null);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Configure the SSL connection.
&nbsp;	 * @param factory the Jetty {@link Server SslContextFactory.Server}.
&nbsp;	 * @param clientAuth the client authentication mode
&nbsp;	 */
&nbsp;	protected void configureSsl(SslContextFactory.Server factory, ClientAuth clientAuth) {
<b class="nc">&nbsp;		SslBundleKey key = this.sslBundle.getKey();</b>
<b class="nc">&nbsp;		SslOptions options = this.sslBundle.getOptions();</b>
<b class="nc">&nbsp;		SslStoreBundle stores = this.sslBundle.getStores();</b>
<b class="nc">&nbsp;		factory.setProtocol(this.sslBundle.getProtocol());</b>
<b class="nc">&nbsp;		configureSslClientAuth(factory, clientAuth);</b>
<b class="nc">&nbsp;		if (stores.getKeyStorePassword() != null) {</b>
<b class="nc">&nbsp;			factory.setKeyStorePassword(stores.getKeyStorePassword());</b>
&nbsp;		}
<b class="nc">&nbsp;		factory.setCertAlias(key.getAlias());</b>
<b class="nc">&nbsp;		if (options.getCiphers() != null) {</b>
<b class="nc">&nbsp;			factory.setIncludeCipherSuites(options.getCiphers());</b>
<b class="nc">&nbsp;			factory.setExcludeCipherSuites();</b>
&nbsp;		}
<b class="nc">&nbsp;		if (options.getEnabledProtocols() != null) {</b>
<b class="nc">&nbsp;			factory.setIncludeProtocols(options.getEnabledProtocols());</b>
<b class="nc">&nbsp;			factory.setExcludeProtocols();</b>
&nbsp;		}
&nbsp;		try {
<b class="nc">&nbsp;			if (key.getPassword() != null) {</b>
<b class="nc">&nbsp;				factory.setKeyManagerPassword(key.getPassword());</b>
&nbsp;			}
<b class="nc">&nbsp;			factory.setKeyStore(stores.getKeyStore());</b>
<b class="nc">&nbsp;			factory.setTrustStore(stores.getTrustStore());</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(&quot;Unable to set SSL store: &quot; + ex.getMessage(), ex);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureSslClientAuth(SslContextFactory.Server factory, ClientAuth clientAuth) {
<b class="nc">&nbsp;		factory.setWantClientAuth(clientAuth == ClientAuth.WANT || clientAuth == ClientAuth.NEED);</b>
<b class="nc">&nbsp;		factory.setNeedClientAuth(clientAuth == ClientAuth.NEED);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * A {@link ServerConnector} that validates the ssl key alias on server startup.
&nbsp;	 */
&nbsp;	static class SslValidatingServerConnector extends ServerConnector {
&nbsp;
&nbsp;		private final SslBundleKey key;
&nbsp;
&nbsp;		private final SslContextFactory sslContextFactory;
&nbsp;
&nbsp;		SslValidatingServerConnector(SslBundleKey key, SslContextFactory sslContextFactory, Server server,
&nbsp;				SslConnectionFactory sslConnectionFactory, HttpConnectionFactory connectionFactory) {
<b class="nc">&nbsp;			super(server, sslConnectionFactory, connectionFactory);</b>
<b class="nc">&nbsp;			this.key = key;</b>
<b class="nc">&nbsp;			this.sslContextFactory = sslContextFactory;</b>
&nbsp;		}
&nbsp;
&nbsp;		SslValidatingServerConnector(SslBundleKey keyAlias, SslContextFactory sslContextFactory, Server server,
&nbsp;				ConnectionFactory... factories) {
<b class="nc">&nbsp;			super(server, factories);</b>
<b class="nc">&nbsp;			this.key = keyAlias;</b>
<b class="nc">&nbsp;			this.sslContextFactory = sslContextFactory;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		protected void doStart() throws Exception {
<b class="nc">&nbsp;			super.doStart();</b>
<b class="nc">&nbsp;			this.key.assertContainsAlias(this.sslContextFactory.getKeyStore());</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-28 21:28</div>
</div>
</body>
</html>
