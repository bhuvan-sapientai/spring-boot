


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > JarURLConnection</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.loader.jar</a>
</div>

<h1>Coverage Summary for Class: JarURLConnection (org.springframework.boot.loader.jar)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">JarURLConnection</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/110)
  </span>
</td>
</tr>
  <tr>
    <td class="name">JarURLConnection$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">JarURLConnection$JarEntryName</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/40)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/152)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.loader.jar;
&nbsp;
&nbsp;import java.io.ByteArrayOutputStream;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URL;
&nbsp;import java.net.URLConnection;
&nbsp;import java.net.URLEncoder;
&nbsp;import java.net.URLStreamHandler;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.security.Permission;
&nbsp;
&nbsp;/**
&nbsp; * {@link java.net.JarURLConnection} used to support {@link JarFile#getUrl()}.
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Rostyslav Dudka
&nbsp; */
&nbsp;final class JarURLConnection extends java.net.JarURLConnection {
&nbsp;
<b class="nc">&nbsp;	private static final ThreadLocal&lt;Boolean&gt; useFastExceptions = new ThreadLocal&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private static final FileNotFoundException FILE_NOT_FOUND_EXCEPTION = new FileNotFoundException(</b>
&nbsp;			&quot;Jar file or entry not found&quot;);
&nbsp;
<b class="nc">&nbsp;	private static final IllegalStateException NOT_FOUND_CONNECTION_EXCEPTION = new IllegalStateException(</b>
&nbsp;			FILE_NOT_FOUND_EXCEPTION);
&nbsp;
&nbsp;	private static final String SEPARATOR = &quot;!/&quot;;
&nbsp;
&nbsp;	private static final URL EMPTY_JAR_URL;
&nbsp;
&nbsp;	static {
&nbsp;		try {
<b class="nc">&nbsp;			EMPTY_JAR_URL = new URL(&quot;jar:&quot;, null, 0, &quot;file:!/&quot;, new URLStreamHandler() {</b>
&nbsp;				@Override
&nbsp;				protected URLConnection openConnection(URL u) throws IOException {
&nbsp;					// Stub URLStreamHandler to prevent the wrong JAR Handler from being
&nbsp;					// Instantiated and cached.
<b class="nc">&nbsp;					return null;</b>
&nbsp;				}
&nbsp;			});
&nbsp;		}
<b class="nc">&nbsp;		catch (MalformedURLException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(ex);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
<b class="nc">&nbsp;	private static final JarEntryName EMPTY_JAR_ENTRY_NAME = new JarEntryName(new StringSequence(&quot;&quot;));</b>
&nbsp;
<b class="nc">&nbsp;	private static final JarURLConnection NOT_FOUND_CONNECTION = JarURLConnection.notFound();</b>
&nbsp;
&nbsp;	private final AbstractJarFile jarFile;
&nbsp;
&nbsp;	private Permission permission;
&nbsp;
&nbsp;	private URL jarFileUrl;
&nbsp;
&nbsp;	private final JarEntryName jarEntryName;
&nbsp;
&nbsp;	private java.util.jar.JarEntry jarEntry;
&nbsp;
&nbsp;	private JarURLConnection(URL url, AbstractJarFile jarFile, JarEntryName jarEntryName) throws IOException {
&nbsp;		// What we pass to super is ultimately ignored
<b class="nc">&nbsp;		super(EMPTY_JAR_URL);</b>
<b class="nc">&nbsp;		this.url = url;</b>
<b class="nc">&nbsp;		this.jarFile = jarFile;</b>
<b class="nc">&nbsp;		this.jarEntryName = jarEntryName;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void connect() throws IOException {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			throw FILE_NOT_FOUND_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (!this.jarEntryName.isEmpty() &amp;&amp; this.jarEntry == null) {</b>
<b class="nc">&nbsp;			this.jarEntry = this.jarFile.getJarEntry(getEntryName());</b>
<b class="nc">&nbsp;			if (this.jarEntry == null) {</b>
<b class="nc">&nbsp;				throwFileNotFound(this.jarEntryName, this.jarFile);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		this.connected = true;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public java.util.jar.JarFile getJarFile() throws IOException {
<b class="nc">&nbsp;		connect();</b>
<b class="nc">&nbsp;		return this.jarFile;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public URL getJarFileURL() {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			throw NOT_FOUND_CONNECTION_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (this.jarFileUrl == null) {</b>
<b class="nc">&nbsp;			this.jarFileUrl = buildJarFileUrl();</b>
&nbsp;		}
<b class="nc">&nbsp;		return this.jarFileUrl;</b>
&nbsp;	}
&nbsp;
&nbsp;	private URL buildJarFileUrl() {
&nbsp;		try {
<b class="nc">&nbsp;			String spec = this.jarFile.getUrl().getFile();</b>
<b class="nc">&nbsp;			if (spec.endsWith(SEPARATOR)) {</b>
<b class="nc">&nbsp;				spec = spec.substring(0, spec.length() - SEPARATOR.length());</b>
&nbsp;			}
<b class="nc">&nbsp;			if (!spec.contains(SEPARATOR)) {</b>
<b class="nc">&nbsp;				return new URL(spec);</b>
&nbsp;			}
<b class="nc">&nbsp;			return new URL(&quot;jar:&quot; + spec);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (MalformedURLException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(ex);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public java.util.jar.JarEntry getJarEntry() throws IOException {
<b class="nc">&nbsp;		if (this.jarEntryName == null || this.jarEntryName.isEmpty()) {</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
<b class="nc">&nbsp;		connect();</b>
<b class="nc">&nbsp;		return this.jarEntry;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public String getEntryName() {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			throw NOT_FOUND_CONNECTION_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		return this.jarEntryName.toString();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public InputStream getInputStream() throws IOException {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			throw FILE_NOT_FOUND_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (this.jarEntryName.isEmpty() &amp;&amp; this.jarFile.getType() == JarFile.JarFileType.DIRECT) {</b>
<b class="nc">&nbsp;			throw new IOException(&quot;no entry name specified&quot;);</b>
&nbsp;		}
<b class="nc">&nbsp;		connect();</b>
<b class="nc">&nbsp;		InputStream inputStream = (this.jarEntryName.isEmpty() ? this.jarFile.getInputStream()</b>
<b class="nc">&nbsp;				: this.jarFile.getInputStream(this.jarEntry));</b>
<b class="nc">&nbsp;		if (inputStream == null) {</b>
<b class="nc">&nbsp;			throwFileNotFound(this.jarEntryName, this.jarFile);</b>
&nbsp;		}
<b class="nc">&nbsp;		return inputStream;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void throwFileNotFound(Object entry, AbstractJarFile jarFile) throws FileNotFoundException {
<b class="nc">&nbsp;		if (Boolean.TRUE.equals(useFastExceptions.get())) {</b>
<b class="nc">&nbsp;			throw FILE_NOT_FOUND_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		throw new FileNotFoundException(&quot;JAR entry &quot; + entry + &quot; not found in &quot; + jarFile.getName());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public int getContentLength() {
<b class="nc">&nbsp;		long length = getContentLengthLong();</b>
<b class="nc">&nbsp;		if (length &gt; Integer.MAX_VALUE) {</b>
<b class="nc">&nbsp;			return -1;</b>
&nbsp;		}
<b class="nc">&nbsp;		return (int) length;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public long getContentLengthLong() {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			return -1;</b>
&nbsp;		}
&nbsp;		try {
<b class="nc">&nbsp;			if (this.jarEntryName.isEmpty()) {</b>
<b class="nc">&nbsp;				return this.jarFile.size();</b>
&nbsp;			}
<b class="nc">&nbsp;			java.util.jar.JarEntry entry = getJarEntry();</b>
<b class="nc">&nbsp;			return (entry != null) ? (int) entry.getSize() : -1;</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IOException ex) {</b>
<b class="nc">&nbsp;			return -1;</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Object getContent() throws IOException {
<b class="nc">&nbsp;		connect();</b>
<b class="nc">&nbsp;		return this.jarEntryName.isEmpty() ? this.jarFile : super.getContent();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public String getContentType() {
<b class="nc">&nbsp;		return (this.jarEntryName != null) ? this.jarEntryName.getContentType() : null;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public Permission getPermission() throws IOException {
<b class="nc">&nbsp;		if (this.jarFile == null) {</b>
<b class="nc">&nbsp;			throw FILE_NOT_FOUND_EXCEPTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (this.permission == null) {</b>
<b class="nc">&nbsp;			this.permission = this.jarFile.getPermission();</b>
&nbsp;		}
<b class="nc">&nbsp;		return this.permission;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public long getLastModified() {
<b class="nc">&nbsp;		if (this.jarFile == null || this.jarEntryName.isEmpty()) {</b>
<b class="nc">&nbsp;			return 0;</b>
&nbsp;		}
&nbsp;		try {
<b class="nc">&nbsp;			java.util.jar.JarEntry entry = getJarEntry();</b>
<b class="nc">&nbsp;			return (entry != null) ? entry.getTime() : 0;</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IOException ex) {</b>
<b class="nc">&nbsp;			return 0;</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	static void setUseFastExceptions(boolean useFastExceptions) {
<b class="nc">&nbsp;		JarURLConnection.useFastExceptions.set(useFastExceptions);</b>
&nbsp;	}
&nbsp;
&nbsp;	static JarURLConnection get(URL url, JarFile jarFile) throws IOException {
<b class="nc">&nbsp;		StringSequence spec = new StringSequence(url.getFile());</b>
<b class="nc">&nbsp;		int index = indexOfRootSpec(spec, jarFile.getPathFromRoot());</b>
<b class="nc">&nbsp;		if (index == -1) {</b>
<b class="nc">&nbsp;			return (Boolean.TRUE.equals(useFastExceptions.get()) ? NOT_FOUND_CONNECTION</b>
<b class="nc">&nbsp;					: new JarURLConnection(url, null, EMPTY_JAR_ENTRY_NAME));</b>
&nbsp;		}
&nbsp;		int separator;
<b class="nc">&nbsp;		while ((separator = spec.indexOf(SEPARATOR, index)) &gt; 0) {</b>
<b class="nc">&nbsp;			JarEntryName entryName = JarEntryName.get(spec.subSequence(index, separator));</b>
<b class="nc">&nbsp;			JarEntry jarEntry = jarFile.getJarEntry(entryName.toCharSequence());</b>
<b class="nc">&nbsp;			if (jarEntry == null) {</b>
<b class="nc">&nbsp;				return JarURLConnection.notFound(jarFile, entryName);</b>
&nbsp;			}
<b class="nc">&nbsp;			jarFile = jarFile.getNestedJarFile(jarEntry);</b>
<b class="nc">&nbsp;			index = separator + SEPARATOR.length();</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		JarEntryName jarEntryName = JarEntryName.get(spec, index);</b>
<b class="nc">&nbsp;		if (Boolean.TRUE.equals(useFastExceptions.get()) &amp;&amp; !jarEntryName.isEmpty()</b>
<b class="nc">&nbsp;				&amp;&amp; !jarFile.containsEntry(jarEntryName.toString())) {</b>
<b class="nc">&nbsp;			return NOT_FOUND_CONNECTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		return new JarURLConnection(url, jarFile.getWrapper(), jarEntryName);</b>
&nbsp;	}
&nbsp;
&nbsp;	private static int indexOfRootSpec(StringSequence file, String pathFromRoot) {
<b class="nc">&nbsp;		int separatorIndex = file.indexOf(SEPARATOR);</b>
<b class="nc">&nbsp;		if (separatorIndex &lt; 0 || !file.startsWith(pathFromRoot, separatorIndex)) {</b>
<b class="nc">&nbsp;			return -1;</b>
&nbsp;		}
<b class="nc">&nbsp;		return separatorIndex + SEPARATOR.length() + pathFromRoot.length();</b>
&nbsp;	}
&nbsp;
&nbsp;	private static JarURLConnection notFound() {
&nbsp;		try {
<b class="nc">&nbsp;			return notFound(null, null);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (IOException ex) {</b>
<b class="nc">&nbsp;			throw new IllegalStateException(ex);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private static JarURLConnection notFound(JarFile jarFile, JarEntryName jarEntryName) throws IOException {
<b class="nc">&nbsp;		if (Boolean.TRUE.equals(useFastExceptions.get())) {</b>
<b class="nc">&nbsp;			return NOT_FOUND_CONNECTION;</b>
&nbsp;		}
<b class="nc">&nbsp;		return new JarURLConnection(null, jarFile, jarEntryName);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * A JarEntryName parsed from a URL String.
&nbsp;	 */
&nbsp;	static class JarEntryName {
&nbsp;
&nbsp;		private final StringSequence name;
&nbsp;
&nbsp;		private String contentType;
&nbsp;
<b class="nc">&nbsp;		JarEntryName(StringSequence spec) {</b>
<b class="nc">&nbsp;			this.name = decode(spec);</b>
&nbsp;		}
&nbsp;
&nbsp;		private StringSequence decode(StringSequence source) {
<b class="nc">&nbsp;			if (source.isEmpty() || (source.indexOf(&#39;%&#39;) &lt; 0)) {</b>
<b class="nc">&nbsp;				return source;</b>
&nbsp;			}
<b class="nc">&nbsp;			ByteArrayOutputStream bos = new ByteArrayOutputStream(source.length());</b>
<b class="nc">&nbsp;			write(source.toString(), bos);</b>
&nbsp;			// AsciiBytes is what is used to store the JarEntries so make it symmetric
<b class="nc">&nbsp;			return new StringSequence(AsciiBytes.toString(bos.toByteArray()));</b>
&nbsp;		}
&nbsp;
&nbsp;		private void write(String source, ByteArrayOutputStream outputStream) {
<b class="nc">&nbsp;			int length = source.length();</b>
<b class="nc">&nbsp;			for (int i = 0; i &lt; length; i++) {</b>
<b class="nc">&nbsp;				int c = source.charAt(i);</b>
<b class="nc">&nbsp;				if (c &gt; 127) {</b>
<b class="nc">&nbsp;					String encoded = URLEncoder.encode(String.valueOf((char) c), StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;					write(encoded, outputStream);</b>
<b class="nc">&nbsp;				}</b>
&nbsp;				else {
<b class="nc">&nbsp;					if (c == &#39;%&#39;) {</b>
<b class="nc">&nbsp;						if ((i + 2) &gt;= length) {</b>
<b class="nc">&nbsp;							throw new IllegalArgumentException(</b>
<b class="nc">&nbsp;									&quot;Invalid encoded sequence \&quot;&quot; + source.substring(i) + &quot;\&quot;&quot;);</b>
&nbsp;						}
<b class="nc">&nbsp;						c = decodeEscapeSequence(source, i);</b>
<b class="nc">&nbsp;						i += 2;</b>
&nbsp;					}
<b class="nc">&nbsp;					outputStream.write(c);</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		private char decodeEscapeSequence(String source, int i) {
<b class="nc">&nbsp;			int hi = Character.digit(source.charAt(i + 1), 16);</b>
<b class="nc">&nbsp;			int lo = Character.digit(source.charAt(i + 2), 16);</b>
<b class="nc">&nbsp;			if (hi == -1 || lo == -1) {</b>
<b class="nc">&nbsp;				throw new IllegalArgumentException(&quot;Invalid encoded sequence \&quot;&quot; + source.substring(i) + &quot;\&quot;&quot;);</b>
&nbsp;			}
<b class="nc">&nbsp;			return ((char) ((hi &lt;&lt; 4) + lo));</b>
&nbsp;		}
&nbsp;
&nbsp;		CharSequence toCharSequence() {
<b class="nc">&nbsp;			return this.name;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String toString() {
<b class="nc">&nbsp;			return this.name.toString();</b>
&nbsp;		}
&nbsp;
&nbsp;		boolean isEmpty() {
<b class="nc">&nbsp;			return this.name.isEmpty();</b>
&nbsp;		}
&nbsp;
&nbsp;		String getContentType() {
<b class="nc">&nbsp;			if (this.contentType == null) {</b>
<b class="nc">&nbsp;				this.contentType = deduceContentType();</b>
&nbsp;			}
<b class="nc">&nbsp;			return this.contentType;</b>
&nbsp;		}
&nbsp;
&nbsp;		private String deduceContentType() {
&nbsp;			// Guess the content type, don&#39;t bother with streams as mark is not supported
<b class="nc">&nbsp;			String type = isEmpty() ? &quot;x-java/jar&quot; : null;</b>
<b class="nc">&nbsp;			type = (type != null) ? type : guessContentTypeFromName(toString());</b>
<b class="nc">&nbsp;			type = (type != null) ? type : &quot;content/unknown&quot;;</b>
<b class="nc">&nbsp;			return type;</b>
&nbsp;		}
&nbsp;
&nbsp;		static JarEntryName get(StringSequence spec) {
<b class="nc">&nbsp;			return get(spec, 0);</b>
&nbsp;		}
&nbsp;
&nbsp;		static JarEntryName get(StringSequence spec, int beginIndex) {
<b class="nc">&nbsp;			if (spec.length() &lt;= beginIndex) {</b>
<b class="nc">&nbsp;				return EMPTY_JAR_ENTRY_NAME;</b>
&nbsp;			}
<b class="nc">&nbsp;			return new JarEntryName(spec.subSequence(beginIndex));</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
