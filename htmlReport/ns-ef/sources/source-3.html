


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > KafkaAutoConfiguration</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.autoconfigure.kafka</a>
</div>

<h1>Coverage Summary for Class: KafkaAutoConfiguration (org.springframework.boot.autoconfigure.kafka)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">KafkaAutoConfiguration</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/74)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2023 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.autoconfigure.kafka;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.time.Duration;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;import org.apache.kafka.clients.CommonClientConfigs;
&nbsp;import org.apache.kafka.clients.consumer.ConsumerConfig;
&nbsp;import org.apache.kafka.clients.producer.ProducerConfig;
&nbsp;
&nbsp;import org.springframework.beans.factory.ObjectProvider;
&nbsp;import org.springframework.boot.autoconfigure.AutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
&nbsp;import org.springframework.boot.autoconfigure.condition.ConditionalOnSingleCandidate;
&nbsp;import org.springframework.boot.autoconfigure.kafka.KafkaProperties.Jaas;
&nbsp;import org.springframework.boot.autoconfigure.kafka.KafkaProperties.Retry.Topic;
&nbsp;import org.springframework.boot.context.properties.EnableConfigurationProperties;
&nbsp;import org.springframework.boot.context.properties.PropertyMapper;
&nbsp;import org.springframework.boot.ssl.SslBundles;
&nbsp;import org.springframework.context.annotation.Bean;
&nbsp;import org.springframework.context.annotation.Import;
&nbsp;import org.springframework.kafka.core.ConsumerFactory;
&nbsp;import org.springframework.kafka.core.DefaultKafkaConsumerFactory;
&nbsp;import org.springframework.kafka.core.DefaultKafkaProducerFactory;
&nbsp;import org.springframework.kafka.core.KafkaAdmin;
&nbsp;import org.springframework.kafka.core.KafkaTemplate;
&nbsp;import org.springframework.kafka.core.ProducerFactory;
&nbsp;import org.springframework.kafka.retrytopic.RetryTopicConfiguration;
&nbsp;import org.springframework.kafka.retrytopic.RetryTopicConfigurationBuilder;
&nbsp;import org.springframework.kafka.security.jaas.KafkaJaasLoginModuleInitializer;
&nbsp;import org.springframework.kafka.support.LoggingProducerListener;
&nbsp;import org.springframework.kafka.support.ProducerListener;
&nbsp;import org.springframework.kafka.support.converter.RecordMessageConverter;
&nbsp;import org.springframework.kafka.transaction.KafkaTransactionManager;
&nbsp;import org.springframework.retry.backoff.BackOffPolicyBuilder;
&nbsp;import org.springframework.retry.backoff.SleepingBackOffPolicy;
&nbsp;
&nbsp;/**
&nbsp; * {@link EnableAutoConfiguration Auto-configuration} for Apache Kafka.
&nbsp; *
&nbsp; * @author Gary Russell
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Eddú Meléndez
&nbsp; * @author Nakul Mishra
&nbsp; * @author Tomaz Fernandes
&nbsp; * @author Moritz Halbritter
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Phillip Webb
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Scott Frederick
&nbsp; * @since 1.5.0
&nbsp; */
&nbsp;@AutoConfiguration
&nbsp;@ConditionalOnClass(KafkaTemplate.class)
&nbsp;@EnableConfigurationProperties(KafkaProperties.class)
&nbsp;@Import({ KafkaAnnotationDrivenConfiguration.class, KafkaStreamsAnnotationDrivenConfiguration.class })
&nbsp;public class KafkaAutoConfiguration {
&nbsp;
&nbsp;	private final KafkaProperties properties;
&nbsp;
<b class="nc">&nbsp;	KafkaAutoConfiguration(KafkaProperties properties) {</b>
<b class="nc">&nbsp;		this.properties = properties;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean(KafkaConnectionDetails.class)
&nbsp;	PropertiesKafkaConnectionDetails kafkaConnectionDetails(KafkaProperties properties) {
<b class="nc">&nbsp;		return new PropertiesKafkaConnectionDetails(properties);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean(KafkaTemplate.class)
&nbsp;	public KafkaTemplate&lt;?, ?&gt; kafkaTemplate(ProducerFactory&lt;Object, Object&gt; kafkaProducerFactory,
&nbsp;			ProducerListener&lt;Object, Object&gt; kafkaProducerListener,
&nbsp;			ObjectProvider&lt;RecordMessageConverter&gt; messageConverter) {
<b class="nc">&nbsp;		PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;		KafkaTemplate&lt;Object, Object&gt; kafkaTemplate = new KafkaTemplate&lt;&gt;(kafkaProducerFactory);</b>
<b class="nc">&nbsp;		messageConverter.ifUnique(kafkaTemplate::setMessageConverter);</b>
<b class="nc">&nbsp;		map.from(kafkaProducerListener).to(kafkaTemplate::setProducerListener);</b>
<b class="nc">&nbsp;		map.from(this.properties.getTemplate().getDefaultTopic()).to(kafkaTemplate::setDefaultTopic);</b>
<b class="nc">&nbsp;		map.from(this.properties.getTemplate().getTransactionIdPrefix()).to(kafkaTemplate::setTransactionIdPrefix);</b>
<b class="nc">&nbsp;		map.from(this.properties.getTemplate().isObservationEnabled()).to(kafkaTemplate::setObservationEnabled);</b>
<b class="nc">&nbsp;		return kafkaTemplate;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean(ProducerListener.class)
&nbsp;	public LoggingProducerListener&lt;Object, Object&gt; kafkaProducerListener() {
<b class="nc">&nbsp;		return new LoggingProducerListener&lt;&gt;();</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean(ConsumerFactory.class)
&nbsp;	public DefaultKafkaConsumerFactory&lt;?, ?&gt; kafkaConsumerFactory(KafkaConnectionDetails connectionDetails,
&nbsp;			ObjectProvider&lt;DefaultKafkaConsumerFactoryCustomizer&gt; customizers, ObjectProvider&lt;SslBundles&gt; sslBundles) {
<b class="nc">&nbsp;		Map&lt;String, Object&gt; properties = this.properties.buildConsumerProperties(sslBundles.getIfAvailable());</b>
<b class="nc">&nbsp;		applyKafkaConnectionDetailsForConsumer(properties, connectionDetails);</b>
<b class="nc">&nbsp;		DefaultKafkaConsumerFactory&lt;Object, Object&gt; factory = new DefaultKafkaConsumerFactory&lt;&gt;(properties);</b>
<b class="nc">&nbsp;		customizers.orderedStream().forEach((customizer) -&gt; customizer.customize(factory));</b>
<b class="nc">&nbsp;		return factory;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean(ProducerFactory.class)
&nbsp;	public DefaultKafkaProducerFactory&lt;?, ?&gt; kafkaProducerFactory(KafkaConnectionDetails connectionDetails,
&nbsp;			ObjectProvider&lt;DefaultKafkaProducerFactoryCustomizer&gt; customizers, ObjectProvider&lt;SslBundles&gt; sslBundles) {
<b class="nc">&nbsp;		Map&lt;String, Object&gt; properties = this.properties.buildProducerProperties(sslBundles.getIfAvailable());</b>
<b class="nc">&nbsp;		applyKafkaConnectionDetailsForProducer(properties, connectionDetails);</b>
<b class="nc">&nbsp;		DefaultKafkaProducerFactory&lt;?, ?&gt; factory = new DefaultKafkaProducerFactory&lt;&gt;(properties);</b>
<b class="nc">&nbsp;		String transactionIdPrefix = this.properties.getProducer().getTransactionIdPrefix();</b>
<b class="nc">&nbsp;		if (transactionIdPrefix != null) {</b>
<b class="nc">&nbsp;			factory.setTransactionIdPrefix(transactionIdPrefix);</b>
&nbsp;		}
<b class="nc">&nbsp;		customizers.orderedStream().forEach((customizer) -&gt; customizer.customize(factory));</b>
<b class="nc">&nbsp;		return factory;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnProperty(name = &quot;spring.kafka.producer.transaction-id-prefix&quot;)
&nbsp;	@ConditionalOnMissingBean
&nbsp;	public KafkaTransactionManager&lt;?, ?&gt; kafkaTransactionManager(ProducerFactory&lt;?, ?&gt; producerFactory) {
<b class="nc">&nbsp;		return new KafkaTransactionManager&lt;&gt;(producerFactory);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnProperty(name = &quot;spring.kafka.jaas.enabled&quot;)
&nbsp;	@ConditionalOnMissingBean
&nbsp;	public KafkaJaasLoginModuleInitializer kafkaJaasInitializer() throws IOException {
<b class="nc">&nbsp;		KafkaJaasLoginModuleInitializer jaas = new KafkaJaasLoginModuleInitializer();</b>
<b class="nc">&nbsp;		Jaas jaasProperties = this.properties.getJaas();</b>
<b class="nc">&nbsp;		if (jaasProperties.getControlFlag() != null) {</b>
<b class="nc">&nbsp;			jaas.setControlFlag(jaasProperties.getControlFlag());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (jaasProperties.getLoginModule() != null) {</b>
<b class="nc">&nbsp;			jaas.setLoginModule(jaasProperties.getLoginModule());</b>
&nbsp;		}
<b class="nc">&nbsp;		jaas.setOptions(jaasProperties.getOptions());</b>
<b class="nc">&nbsp;		return jaas;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnMissingBean
&nbsp;	public KafkaAdmin kafkaAdmin(KafkaConnectionDetails connectionDetails, ObjectProvider&lt;SslBundles&gt; sslBundles) {
<b class="nc">&nbsp;		Map&lt;String, Object&gt; properties = this.properties.buildAdminProperties(sslBundles.getIfAvailable());</b>
<b class="nc">&nbsp;		applyKafkaConnectionDetailsForAdmin(properties, connectionDetails);</b>
<b class="nc">&nbsp;		KafkaAdmin kafkaAdmin = new KafkaAdmin(properties);</b>
<b class="nc">&nbsp;		KafkaProperties.Admin admin = this.properties.getAdmin();</b>
<b class="nc">&nbsp;		if (admin.getCloseTimeout() != null) {</b>
<b class="nc">&nbsp;			kafkaAdmin.setCloseTimeout((int) admin.getCloseTimeout().getSeconds());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (admin.getOperationTimeout() != null) {</b>
<b class="nc">&nbsp;			kafkaAdmin.setOperationTimeout((int) admin.getOperationTimeout().getSeconds());</b>
&nbsp;		}
<b class="nc">&nbsp;		kafkaAdmin.setFatalIfBrokerNotAvailable(admin.isFailFast());</b>
<b class="nc">&nbsp;		kafkaAdmin.setModifyTopicConfigs(admin.isModifyTopicConfigs());</b>
<b class="nc">&nbsp;		kafkaAdmin.setAutoCreate(admin.isAutoCreate());</b>
<b class="nc">&nbsp;		return kafkaAdmin;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Bean
&nbsp;	@ConditionalOnProperty(name = &quot;spring.kafka.retry.topic.enabled&quot;)
&nbsp;	@ConditionalOnSingleCandidate(KafkaTemplate.class)
&nbsp;	public RetryTopicConfiguration kafkaRetryTopicConfiguration(KafkaTemplate&lt;?, ?&gt; kafkaTemplate) {
<b class="nc">&nbsp;		KafkaProperties.Retry.Topic retryTopic = this.properties.getRetry().getTopic();</b>
<b class="nc">&nbsp;		RetryTopicConfigurationBuilder builder = RetryTopicConfigurationBuilder.newInstance()</b>
<b class="nc">&nbsp;			.maxAttempts(retryTopic.getAttempts())</b>
<b class="nc">&nbsp;			.useSingleTopicForSameIntervals()</b>
<b class="nc">&nbsp;			.suffixTopicsWithIndexValues()</b>
<b class="nc">&nbsp;			.doNotAutoCreateRetryTopics();</b>
<b class="nc">&nbsp;		setBackOffPolicy(builder, retryTopic);</b>
<b class="nc">&nbsp;		return builder.create(kafkaTemplate);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void applyKafkaConnectionDetailsForConsumer(Map&lt;String, Object&gt; properties,
&nbsp;			KafkaConnectionDetails connectionDetails) {
<b class="nc">&nbsp;		properties.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, connectionDetails.getConsumerBootstrapServers());</b>
<b class="nc">&nbsp;		if (!(connectionDetails instanceof PropertiesKafkaConnectionDetails)) {</b>
<b class="nc">&nbsp;			properties.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, &quot;PLAINTEXT&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void applyKafkaConnectionDetailsForProducer(Map&lt;String, Object&gt; properties,
&nbsp;			KafkaConnectionDetails connectionDetails) {
<b class="nc">&nbsp;		properties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, connectionDetails.getProducerBootstrapServers());</b>
<b class="nc">&nbsp;		if (!(connectionDetails instanceof PropertiesKafkaConnectionDetails)) {</b>
<b class="nc">&nbsp;			properties.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, &quot;PLAINTEXT&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void applyKafkaConnectionDetailsForAdmin(Map&lt;String, Object&gt; properties,
&nbsp;			KafkaConnectionDetails connectionDetails) {
<b class="nc">&nbsp;		properties.put(CommonClientConfigs.BOOTSTRAP_SERVERS_CONFIG, connectionDetails.getAdminBootstrapServers());</b>
<b class="nc">&nbsp;		if (!(connectionDetails instanceof PropertiesKafkaConnectionDetails)) {</b>
<b class="nc">&nbsp;			properties.put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, &quot;PLAINTEXT&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private static void setBackOffPolicy(RetryTopicConfigurationBuilder builder, Topic retryTopic) {
<b class="nc">&nbsp;		long delay = (retryTopic.getDelay() != null) ? retryTopic.getDelay().toMillis() : 0;</b>
<b class="nc">&nbsp;		if (delay &gt; 0) {</b>
<b class="nc">&nbsp;			PropertyMapper map = PropertyMapper.get().alwaysApplyingWhenNonNull();</b>
<b class="nc">&nbsp;			BackOffPolicyBuilder backOffPolicy = BackOffPolicyBuilder.newBuilder();</b>
<b class="nc">&nbsp;			map.from(delay).to(backOffPolicy::delay);</b>
<b class="nc">&nbsp;			map.from(retryTopic.getMaxDelay()).as(Duration::toMillis).to(backOffPolicy::maxDelay);</b>
<b class="nc">&nbsp;			map.from(retryTopic.getMultiplier()).to(backOffPolicy::multiplier);</b>
<b class="nc">&nbsp;			map.from(retryTopic.isRandomBackOff()).to(backOffPolicy::random);</b>
<b class="nc">&nbsp;			builder.customBackoff((SleepingBackOffPolicy&lt;?&gt;) backOffPolicy.build());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;		else {
<b class="nc">&nbsp;			builder.noBackoff();</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
