


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > TomcatServletWebServerFactory</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.web.embedded.tomcat</a>
</div>

<h1>Coverage Summary for Class: TomcatServletWebServerFactory (org.springframework.boot.web.embedded.tomcat)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">TomcatServletWebServerFactory</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/61)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/262)
  </span>
</td>
</tr>
  <tr>
    <td class="name">TomcatServletWebServerFactory$DisablePersistSessionListener</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TomcatServletWebServerFactory$LoaderHidingResourceRoot</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TomcatServletWebServerFactory$LoaderHidingWebResourceSet</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/26)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TomcatServletWebServerFactory$StaticResourceConfigurer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/28)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">TomcatServletWebServerFactory$SuppliedSameSiteCookieProcessor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/86)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/338)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2024 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.web.embedded.tomcat;
&nbsp;
&nbsp;import java.io.File;
&nbsp;import java.io.InputStream;
&nbsp;import java.lang.reflect.Method;
&nbsp;import java.net.MalformedURLException;
&nbsp;import java.net.URL;
&nbsp;import java.nio.charset.Charset;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.time.Duration;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.Locale;
&nbsp;import java.util.Set;
&nbsp;import java.util.stream.Collectors;
&nbsp;
&nbsp;import jakarta.servlet.ServletContainerInitializer;
&nbsp;import jakarta.servlet.http.Cookie;
&nbsp;import jakarta.servlet.http.HttpServletRequest;
&nbsp;import org.apache.catalina.Context;
&nbsp;import org.apache.catalina.Engine;
&nbsp;import org.apache.catalina.Executor;
&nbsp;import org.apache.catalina.Host;
&nbsp;import org.apache.catalina.Lifecycle;
&nbsp;import org.apache.catalina.LifecycleEvent;
&nbsp;import org.apache.catalina.LifecycleException;
&nbsp;import org.apache.catalina.LifecycleListener;
&nbsp;import org.apache.catalina.Manager;
&nbsp;import org.apache.catalina.Valve;
&nbsp;import org.apache.catalina.WebResource;
&nbsp;import org.apache.catalina.WebResourceRoot;
&nbsp;import org.apache.catalina.WebResourceRoot.ResourceSetType;
&nbsp;import org.apache.catalina.WebResourceSet;
&nbsp;import org.apache.catalina.Wrapper;
&nbsp;import org.apache.catalina.connector.Connector;
&nbsp;import org.apache.catalina.core.AprLifecycleListener;
&nbsp;import org.apache.catalina.loader.WebappLoader;
&nbsp;import org.apache.catalina.session.StandardManager;
&nbsp;import org.apache.catalina.startup.Tomcat;
&nbsp;import org.apache.catalina.startup.Tomcat.FixContextListener;
&nbsp;import org.apache.catalina.util.LifecycleBase;
&nbsp;import org.apache.catalina.util.SessionConfig;
&nbsp;import org.apache.catalina.webresources.AbstractResourceSet;
&nbsp;import org.apache.catalina.webresources.EmptyResource;
&nbsp;import org.apache.catalina.webresources.StandardRoot;
&nbsp;import org.apache.commons.logging.Log;
&nbsp;import org.apache.commons.logging.LogFactory;
&nbsp;import org.apache.coyote.AbstractProtocol;
&nbsp;import org.apache.coyote.ProtocolHandler;
&nbsp;import org.apache.coyote.http2.Http2Protocol;
&nbsp;import org.apache.tomcat.util.http.Rfc6265CookieProcessor;
&nbsp;import org.apache.tomcat.util.modeler.Registry;
&nbsp;import org.apache.tomcat.util.scan.StandardJarScanFilter;
&nbsp;
&nbsp;import org.springframework.boot.util.LambdaSafe;
&nbsp;import org.springframework.boot.web.server.Cookie.SameSite;
&nbsp;import org.springframework.boot.web.server.ErrorPage;
&nbsp;import org.springframework.boot.web.server.MimeMappings;
&nbsp;import org.springframework.boot.web.server.Ssl;
&nbsp;import org.springframework.boot.web.server.WebServer;
&nbsp;import org.springframework.boot.web.servlet.ServletContextInitializer;
&nbsp;import org.springframework.boot.web.servlet.server.AbstractServletWebServerFactory;
&nbsp;import org.springframework.boot.web.servlet.server.CookieSameSiteSupplier;
&nbsp;import org.springframework.context.ResourceLoaderAware;
&nbsp;import org.springframework.core.NativeDetector;
&nbsp;import org.springframework.core.io.ResourceLoader;
&nbsp;import org.springframework.util.Assert;
&nbsp;import org.springframework.util.ClassUtils;
&nbsp;import org.springframework.util.CollectionUtils;
&nbsp;import org.springframework.util.ReflectionUtils;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * {@link AbstractServletWebServerFactory} that can be used to create
&nbsp; * {@link TomcatWebServer}s. Can be initialized using Spring&#39;s
&nbsp; * {@link ServletContextInitializer}s or Tomcat {@link LifecycleListener}s.
&nbsp; * &lt;p&gt;
&nbsp; * Unless explicitly configured otherwise this factory will create containers that listen
&nbsp; * for HTTP requests on port 8080.
&nbsp; *
&nbsp; * @author Phillip Webb
&nbsp; * @author Dave Syer
&nbsp; * @author Brock Mills
&nbsp; * @author Stephane Nicoll
&nbsp; * @author Andy Wilkinson
&nbsp; * @author Eddú Meléndez
&nbsp; * @author Christoffer Sawicki
&nbsp; * @author Dawid Antecki
&nbsp; * @author Moritz Halbritter
&nbsp; * @since 2.0.0
&nbsp; * @see #setPort(int)
&nbsp; * @see #setContextLifecycleListeners(Collection)
&nbsp; * @see TomcatWebServer
&nbsp; */
<b class="nc">&nbsp;public class TomcatServletWebServerFactory extends AbstractServletWebServerFactory</b>
&nbsp;		implements ConfigurableTomcatWebServerFactory, ResourceLoaderAware {
&nbsp;
<b class="nc">&nbsp;	private static final Log logger = LogFactory.getLog(TomcatServletWebServerFactory.class);</b>
&nbsp;
<b class="nc">&nbsp;	private static final Charset DEFAULT_CHARSET = StandardCharsets.UTF_8;</b>
&nbsp;
<b class="nc">&nbsp;	private static final Set&lt;Class&lt;?&gt;&gt; NO_CLASSES = Collections.emptySet();</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * The class name of default protocol used.
&nbsp;	 */
&nbsp;	public static final String DEFAULT_PROTOCOL = &quot;org.apache.coyote.http11.Http11NioProtocol&quot;;
&nbsp;
&nbsp;	private File baseDirectory;
&nbsp;
<b class="nc">&nbsp;	private List&lt;Valve&gt; engineValves = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private List&lt;Valve&gt; contextValves = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private List&lt;LifecycleListener&gt; contextLifecycleListeners = new ArrayList&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private final List&lt;LifecycleListener&gt; serverLifecycleListeners = getDefaultServerLifecycleListeners();</b>
&nbsp;
<b class="nc">&nbsp;	private Set&lt;TomcatContextCustomizer&gt; tomcatContextCustomizers = new LinkedHashSet&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private Set&lt;TomcatConnectorCustomizer&gt; tomcatConnectorCustomizers = new LinkedHashSet&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private Set&lt;TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; tomcatProtocolHandlerCustomizers = new LinkedHashSet&lt;&gt;();</b>
&nbsp;
<b class="nc">&nbsp;	private final List&lt;Connector&gt; additionalTomcatConnectors = new ArrayList&lt;&gt;();</b>
&nbsp;
&nbsp;	private ResourceLoader resourceLoader;
&nbsp;
<b class="nc">&nbsp;	private String protocol = DEFAULT_PROTOCOL;</b>
&nbsp;
<b class="nc">&nbsp;	private Set&lt;String&gt; tldSkipPatterns = new LinkedHashSet&lt;&gt;(TldPatterns.DEFAULT_SKIP);</b>
&nbsp;
<b class="nc">&nbsp;	private final Set&lt;String&gt; tldScanPatterns = new LinkedHashSet&lt;&gt;(TldPatterns.DEFAULT_SCAN);</b>
&nbsp;
<b class="nc">&nbsp;	private Charset uriEncoding = DEFAULT_CHARSET;</b>
&nbsp;
&nbsp;	private int backgroundProcessorDelay;
&nbsp;
<b class="nc">&nbsp;	private boolean disableMBeanRegistry = true;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link TomcatServletWebServerFactory} instance.
&nbsp;	 */
<b class="nc">&nbsp;	public TomcatServletWebServerFactory() {</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link TomcatServletWebServerFactory} that listens for requests using
&nbsp;	 * the specified port.
&nbsp;	 * @param port the port to listen on
&nbsp;	 */
&nbsp;	public TomcatServletWebServerFactory(int port) {
<b class="nc">&nbsp;		super(port);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link TomcatServletWebServerFactory} with the specified context path
&nbsp;	 * and port.
&nbsp;	 * @param contextPath the root context path
&nbsp;	 * @param port the port to listen on
&nbsp;	 */
&nbsp;	public TomcatServletWebServerFactory(String contextPath, int port) {
<b class="nc">&nbsp;		super(contextPath, port);</b>
&nbsp;	}
&nbsp;
&nbsp;	private static List&lt;LifecycleListener&gt; getDefaultServerLifecycleListeners() {
<b class="nc">&nbsp;		ArrayList&lt;LifecycleListener&gt; lifecycleListeners = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		if (!NativeDetector.inNativeImage()) {</b>
<b class="nc">&nbsp;			AprLifecycleListener aprLifecycleListener = new AprLifecycleListener();</b>
<b class="nc">&nbsp;			if (AprLifecycleListener.isAprAvailable()) {</b>
<b class="nc">&nbsp;				lifecycleListeners.add(aprLifecycleListener);</b>
&nbsp;			}
&nbsp;		}
<b class="nc">&nbsp;		return lifecycleListeners;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public WebServer getWebServer(ServletContextInitializer... initializers) {
<b class="nc">&nbsp;		if (this.disableMBeanRegistry) {</b>
<b class="nc">&nbsp;			Registry.disableRegistry();</b>
&nbsp;		}
<b class="nc">&nbsp;		Tomcat tomcat = new Tomcat();</b>
<b class="nc">&nbsp;		File baseDir = (this.baseDirectory != null) ? this.baseDirectory : createTempDir(&quot;tomcat&quot;);</b>
<b class="nc">&nbsp;		tomcat.setBaseDir(baseDir.getAbsolutePath());</b>
<b class="nc">&nbsp;		for (LifecycleListener listener : this.serverLifecycleListeners) {</b>
<b class="nc">&nbsp;			tomcat.getServer().addLifecycleListener(listener);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		Connector connector = new Connector(this.protocol);</b>
<b class="nc">&nbsp;		connector.setThrowOnFailure(true);</b>
<b class="nc">&nbsp;		tomcat.getService().addConnector(connector);</b>
<b class="nc">&nbsp;		customizeConnector(connector);</b>
<b class="nc">&nbsp;		tomcat.setConnector(connector);</b>
<b class="nc">&nbsp;		registerConnectorExecutor(tomcat, connector);</b>
<b class="nc">&nbsp;		tomcat.getHost().setAutoDeploy(false);</b>
<b class="nc">&nbsp;		configureEngine(tomcat.getEngine());</b>
<b class="nc">&nbsp;		for (Connector additionalConnector : this.additionalTomcatConnectors) {</b>
<b class="nc">&nbsp;			tomcat.getService().addConnector(additionalConnector);</b>
<b class="nc">&nbsp;			registerConnectorExecutor(tomcat, additionalConnector);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		prepareContext(tomcat.getHost(), initializers);</b>
<b class="nc">&nbsp;		return getTomcatWebServer(tomcat);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void registerConnectorExecutor(Tomcat tomcat, Connector connector) {
<b class="nc">&nbsp;		if (connector.getProtocolHandler().getExecutor() instanceof Executor executor) {</b>
<b class="nc">&nbsp;			tomcat.getService().addExecutor(executor);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void configureEngine(Engine engine) {
<b class="nc">&nbsp;		engine.setBackgroundProcessorDelay(this.backgroundProcessorDelay);</b>
<b class="nc">&nbsp;		for (Valve valve : this.engineValves) {</b>
<b class="nc">&nbsp;			engine.getPipeline().addValve(valve);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	protected void prepareContext(Host host, ServletContextInitializer[] initializers) {
<b class="nc">&nbsp;		File documentRoot = getValidDocumentRoot();</b>
<b class="nc">&nbsp;		TomcatEmbeddedContext context = new TomcatEmbeddedContext();</b>
<b class="nc">&nbsp;		if (documentRoot != null) {</b>
<b class="nc">&nbsp;			context.setResources(new LoaderHidingResourceRoot(context));</b>
&nbsp;		}
<b class="nc">&nbsp;		context.setName(getContextPath());</b>
<b class="nc">&nbsp;		context.setDisplayName(getDisplayName());</b>
<b class="nc">&nbsp;		context.setPath(getContextPath());</b>
<b class="nc">&nbsp;		File docBase = (documentRoot != null) ? documentRoot : createTempDir(&quot;tomcat-docbase&quot;);</b>
<b class="nc">&nbsp;		context.setDocBase(docBase.getAbsolutePath());</b>
<b class="nc">&nbsp;		context.addLifecycleListener(new FixContextListener());</b>
<b class="nc">&nbsp;		ClassLoader parentClassLoader = (this.resourceLoader != null) ? this.resourceLoader.getClassLoader()</b>
<b class="nc">&nbsp;				: ClassUtils.getDefaultClassLoader();</b>
<b class="nc">&nbsp;		context.setParentClassLoader(parentClassLoader);</b>
<b class="nc">&nbsp;		resetDefaultLocaleMapping(context);</b>
<b class="nc">&nbsp;		addLocaleMappings(context);</b>
&nbsp;		try {
<b class="nc">&nbsp;			context.setCreateUploadTargets(true);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (NoSuchMethodError ex) {</b>
&nbsp;			// Tomcat is &lt; 8.5.39. Continue.
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		configureTldPatterns(context);</b>
<b class="nc">&nbsp;		WebappLoader loader = new WebappLoader();</b>
<b class="nc">&nbsp;		loader.setLoaderInstance(new TomcatEmbeddedWebappClassLoader(parentClassLoader));</b>
<b class="nc">&nbsp;		loader.setDelegate(true);</b>
<b class="nc">&nbsp;		context.setLoader(loader);</b>
<b class="nc">&nbsp;		if (isRegisterDefaultServlet()) {</b>
<b class="nc">&nbsp;			addDefaultServlet(context);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (shouldRegisterJspServlet()) {</b>
<b class="nc">&nbsp;			addJspServlet(context);</b>
<b class="nc">&nbsp;			addJasperInitializer(context);</b>
&nbsp;		}
<b class="nc">&nbsp;		context.addLifecycleListener(new StaticResourceConfigurer(context));</b>
<b class="nc">&nbsp;		ServletContextInitializer[] initializersToUse = mergeInitializers(initializers);</b>
<b class="nc">&nbsp;		host.addChild(context);</b>
<b class="nc">&nbsp;		configureContext(context, initializersToUse);</b>
<b class="nc">&nbsp;		postProcessContext(context);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Override Tomcat&#39;s default locale mappings to align with other servers. See
&nbsp;	 * {@code org.apache.catalina.util.CharsetMapperDefault.properties}.
&nbsp;	 * @param context the context to reset
&nbsp;	 */
&nbsp;	private void resetDefaultLocaleMapping(TomcatEmbeddedContext context) {
<b class="nc">&nbsp;		context.addLocaleEncodingMappingParameter(Locale.ENGLISH.toString(), DEFAULT_CHARSET.displayName());</b>
<b class="nc">&nbsp;		context.addLocaleEncodingMappingParameter(Locale.FRENCH.toString(), DEFAULT_CHARSET.displayName());</b>
<b class="nc">&nbsp;		context.addLocaleEncodingMappingParameter(Locale.JAPANESE.toString(), DEFAULT_CHARSET.displayName());</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addLocaleMappings(TomcatEmbeddedContext context) {
<b class="nc">&nbsp;		getLocaleCharsetMappings().forEach(</b>
<b class="nc">&nbsp;				(locale, charset) -&gt; context.addLocaleEncodingMappingParameter(locale.toString(), charset.toString()));</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureTldPatterns(TomcatEmbeddedContext context) {
<b class="nc">&nbsp;		StandardJarScanFilter filter = new StandardJarScanFilter();</b>
<b class="nc">&nbsp;		filter.setTldSkip(StringUtils.collectionToCommaDelimitedString(this.tldSkipPatterns));</b>
<b class="nc">&nbsp;		filter.setTldScan(StringUtils.collectionToCommaDelimitedString(this.tldScanPatterns));</b>
<b class="nc">&nbsp;		context.getJarScanner().setJarScanFilter(filter);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addDefaultServlet(Context context) {
<b class="nc">&nbsp;		Wrapper defaultServlet = context.createWrapper();</b>
<b class="nc">&nbsp;		defaultServlet.setName(&quot;default&quot;);</b>
<b class="nc">&nbsp;		defaultServlet.setServletClass(&quot;org.apache.catalina.servlets.DefaultServlet&quot;);</b>
<b class="nc">&nbsp;		defaultServlet.addInitParameter(&quot;debug&quot;, &quot;0&quot;);</b>
<b class="nc">&nbsp;		defaultServlet.addInitParameter(&quot;listings&quot;, &quot;false&quot;);</b>
<b class="nc">&nbsp;		defaultServlet.setLoadOnStartup(1);</b>
&nbsp;		// Otherwise the default location of a Spring DispatcherServlet cannot be set
<b class="nc">&nbsp;		defaultServlet.setOverridable(true);</b>
<b class="nc">&nbsp;		context.addChild(defaultServlet);</b>
<b class="nc">&nbsp;		context.addServletMappingDecoded(&quot;/&quot;, &quot;default&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addJspServlet(Context context) {
<b class="nc">&nbsp;		Wrapper jspServlet = context.createWrapper();</b>
<b class="nc">&nbsp;		jspServlet.setName(&quot;jsp&quot;);</b>
<b class="nc">&nbsp;		jspServlet.setServletClass(getJsp().getClassName());</b>
<b class="nc">&nbsp;		jspServlet.addInitParameter(&quot;fork&quot;, &quot;false&quot;);</b>
<b class="nc">&nbsp;		getJsp().getInitParameters().forEach(jspServlet::addInitParameter);</b>
<b class="nc">&nbsp;		jspServlet.setLoadOnStartup(3);</b>
<b class="nc">&nbsp;		context.addChild(jspServlet);</b>
<b class="nc">&nbsp;		context.addServletMappingDecoded(&quot;*.jsp&quot;, &quot;jsp&quot;);</b>
<b class="nc">&nbsp;		context.addServletMappingDecoded(&quot;*.jspx&quot;, &quot;jsp&quot;);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void addJasperInitializer(TomcatEmbeddedContext context) {
&nbsp;		try {
<b class="nc">&nbsp;			ServletContainerInitializer initializer = (ServletContainerInitializer) ClassUtils</b>
<b class="nc">&nbsp;				.forName(&quot;org.apache.jasper.servlet.JasperInitializer&quot;, null)</b>
<b class="nc">&nbsp;				.getDeclaredConstructor()</b>
<b class="nc">&nbsp;				.newInstance();</b>
<b class="nc">&nbsp;			context.addServletContainerInitializer(initializer, null);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
&nbsp;			// Probably not Tomcat 8
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	// Needs to be protected so it can be used by subclasses
&nbsp;	protected void customizeConnector(Connector connector) {
<b class="nc">&nbsp;		int port = Math.max(getPort(), 0);</b>
<b class="nc">&nbsp;		connector.setPort(port);</b>
<b class="nc">&nbsp;		if (StringUtils.hasText(getServerHeader())) {</b>
<b class="nc">&nbsp;			connector.setProperty(&quot;server&quot;, getServerHeader());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (connector.getProtocolHandler() instanceof AbstractProtocol) {</b>
<b class="nc">&nbsp;			customizeProtocol((AbstractProtocol&lt;?&gt;) connector.getProtocolHandler());</b>
&nbsp;		}
<b class="nc">&nbsp;		invokeProtocolHandlerCustomizers(connector.getProtocolHandler());</b>
<b class="nc">&nbsp;		if (getUriEncoding() != null) {</b>
<b class="nc">&nbsp;			connector.setURIEncoding(getUriEncoding().name());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (getHttp2() != null &amp;&amp; getHttp2().isEnabled()) {</b>
<b class="nc">&nbsp;			connector.addUpgradeProtocol(new Http2Protocol());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (Ssl.isEnabled(getSsl())) {</b>
<b class="nc">&nbsp;			customizeSsl(connector);</b>
&nbsp;		}
<b class="nc">&nbsp;		TomcatConnectorCustomizer compression = new CompressionConnectorCustomizer(getCompression());</b>
<b class="nc">&nbsp;		compression.customize(connector);</b>
<b class="nc">&nbsp;		for (TomcatConnectorCustomizer customizer : this.tomcatConnectorCustomizers) {</b>
<b class="nc">&nbsp;			customizer.customize(connector);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private void customizeProtocol(AbstractProtocol&lt;?&gt; protocol) {
<b class="nc">&nbsp;		if (getAddress() != null) {</b>
<b class="nc">&nbsp;			protocol.setAddress(getAddress());</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private void invokeProtocolHandlerCustomizers(ProtocolHandler protocolHandler) {
<b class="nc">&nbsp;		LambdaSafe</b>
<b class="nc">&nbsp;			.callbacks(TomcatProtocolHandlerCustomizer.class, this.tomcatProtocolHandlerCustomizers, protocolHandler)</b>
<b class="nc">&nbsp;			.invoke((customizer) -&gt; customizer.customize(protocolHandler));</b>
&nbsp;	}
&nbsp;
&nbsp;	private void customizeSsl(Connector connector) {
<b class="nc">&nbsp;		SslConnectorCustomizer customizer = new SslConnectorCustomizer(logger, connector, getSsl().getClientAuth());</b>
<b class="nc">&nbsp;		customizer.customize(getSslBundle());</b>
<b class="nc">&nbsp;		String sslBundleName = getSsl().getBundle();</b>
<b class="nc">&nbsp;		if (StringUtils.hasText(sslBundleName)) {</b>
<b class="nc">&nbsp;			getSslBundles().addBundleUpdateHandler(sslBundleName, customizer::update);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Configure the Tomcat {@link Context}.
&nbsp;	 * @param context the Tomcat context
&nbsp;	 * @param initializers initializers to apply
&nbsp;	 */
&nbsp;	protected void configureContext(Context context, ServletContextInitializer[] initializers) {
<b class="nc">&nbsp;		TomcatStarter starter = new TomcatStarter(initializers);</b>
<b class="nc">&nbsp;		if (context instanceof TomcatEmbeddedContext embeddedContext) {</b>
<b class="nc">&nbsp;			embeddedContext.setStarter(starter);</b>
<b class="nc">&nbsp;			embeddedContext.setFailCtxIfServletStartFails(true);</b>
&nbsp;		}
<b class="nc">&nbsp;		context.addServletContainerInitializer(starter, NO_CLASSES);</b>
<b class="nc">&nbsp;		for (LifecycleListener lifecycleListener : this.contextLifecycleListeners) {</b>
<b class="nc">&nbsp;			context.addLifecycleListener(lifecycleListener);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		for (Valve valve : this.contextValves) {</b>
<b class="nc">&nbsp;			context.getPipeline().addValve(valve);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		for (ErrorPage errorPage : getErrorPages()) {</b>
<b class="nc">&nbsp;			org.apache.tomcat.util.descriptor.web.ErrorPage tomcatErrorPage = new org.apache.tomcat.util.descriptor.web.ErrorPage();</b>
<b class="nc">&nbsp;			tomcatErrorPage.setLocation(errorPage.getPath());</b>
<b class="nc">&nbsp;			tomcatErrorPage.setErrorCode(errorPage.getStatusCode());</b>
<b class="nc">&nbsp;			tomcatErrorPage.setExceptionType(errorPage.getExceptionName());</b>
<b class="nc">&nbsp;			context.addErrorPage(tomcatErrorPage);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		setMimeMappings(context);</b>
<b class="nc">&nbsp;		configureSession(context);</b>
<b class="nc">&nbsp;		configureCookieProcessor(context);</b>
<b class="nc">&nbsp;		new DisableReferenceClearingContextCustomizer().customize(context);</b>
<b class="nc">&nbsp;		for (String webListenerClassName : getWebListenerClassNames()) {</b>
<b class="nc">&nbsp;			context.addApplicationListener(webListenerClassName);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		for (TomcatContextCustomizer customizer : this.tomcatContextCustomizers) {</b>
<b class="nc">&nbsp;			customizer.customize(context);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureSession(Context context) {
<b class="nc">&nbsp;		long sessionTimeout = getSessionTimeoutInMinutes();</b>
<b class="nc">&nbsp;		context.setSessionTimeout((int) sessionTimeout);</b>
<b class="nc">&nbsp;		Boolean httpOnly = getSession().getCookie().getHttpOnly();</b>
<b class="nc">&nbsp;		if (httpOnly != null) {</b>
<b class="nc">&nbsp;			context.setUseHttpOnly(httpOnly);</b>
&nbsp;		}
<b class="nc">&nbsp;		if (getSession().isPersistent()) {</b>
<b class="nc">&nbsp;			Manager manager = context.getManager();</b>
<b class="nc">&nbsp;			if (manager == null) {</b>
<b class="nc">&nbsp;				manager = new StandardManager();</b>
<b class="nc">&nbsp;				context.setManager(manager);</b>
&nbsp;			}
<b class="nc">&nbsp;			configurePersistSession(manager);</b>
<b class="nc">&nbsp;		}</b>
&nbsp;		else {
<b class="nc">&nbsp;			context.addLifecycleListener(new DisablePersistSessionListener());</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void setMimeMappings(Context context) {
<b class="nc">&nbsp;		if (context instanceof TomcatEmbeddedContext embeddedContext) {</b>
<b class="nc">&nbsp;			embeddedContext.setMimeMappings(getMimeMappings());</b>
&nbsp;			return;
&nbsp;		}
<b class="nc">&nbsp;		for (MimeMappings.Mapping mapping : getMimeMappings()) {</b>
<b class="nc">&nbsp;			context.addMimeMapping(mapping.getExtension(), mapping.getMimeType());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private void configureCookieProcessor(Context context) {
<b class="nc">&nbsp;		SameSite sessionSameSite = getSession().getCookie().getSameSite();</b>
<b class="nc">&nbsp;		List&lt;CookieSameSiteSupplier&gt; suppliers = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		if (sessionSameSite != null) {</b>
<b class="nc">&nbsp;			suppliers.add(CookieSameSiteSupplier.of(sessionSameSite)</b>
<b class="nc">&nbsp;				.whenHasName(() -&gt; SessionConfig.getSessionCookieName(context)));</b>
&nbsp;		}
<b class="nc">&nbsp;		if (!CollectionUtils.isEmpty(getCookieSameSiteSuppliers())) {</b>
<b class="nc">&nbsp;			suppliers.addAll(getCookieSameSiteSuppliers());</b>
&nbsp;		}
<b class="nc">&nbsp;		if (!suppliers.isEmpty()) {</b>
<b class="nc">&nbsp;			context.setCookieProcessor(new SuppliedSameSiteCookieProcessor(suppliers));</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void configurePersistSession(Manager manager) {
<b class="nc">&nbsp;		Assert.state(manager instanceof StandardManager,</b>
<b class="nc">&nbsp;				() -&gt; &quot;Unable to persist HTTP session state using manager type &quot; + manager.getClass().getName());</b>
<b class="nc">&nbsp;		File dir = getValidSessionStoreDir();</b>
<b class="nc">&nbsp;		File file = new File(dir, &quot;SESSIONS.ser&quot;);</b>
<b class="nc">&nbsp;		((StandardManager) manager).setPathname(file.getAbsolutePath());</b>
&nbsp;	}
&nbsp;
&nbsp;	private long getSessionTimeoutInMinutes() {
<b class="nc">&nbsp;		Duration sessionTimeout = getSession().getTimeout();</b>
<b class="nc">&nbsp;		if (isZeroOrLess(sessionTimeout)) {</b>
<b class="nc">&nbsp;			return 0;</b>
&nbsp;		}
<b class="nc">&nbsp;		return Math.max(sessionTimeout.toMinutes(), 1);</b>
&nbsp;	}
&nbsp;
&nbsp;	private boolean isZeroOrLess(Duration sessionTimeout) {
<b class="nc">&nbsp;		return sessionTimeout == null || sessionTimeout.isNegative() || sessionTimeout.isZero();</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Post process the Tomcat {@link Context} before it&#39;s used with the Tomcat Server.
&nbsp;	 * Subclasses can override this method to apply additional processing to the
&nbsp;	 * {@link Context}.
&nbsp;	 * @param context the Tomcat {@link Context}
&nbsp;	 */
&nbsp;	protected void postProcessContext(Context context) {
<b class="nc">&nbsp;	}</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Factory method called to create the {@link TomcatWebServer}. Subclasses can
&nbsp;	 * override this method to return a different {@link TomcatWebServer} or apply
&nbsp;	 * additional processing to the Tomcat server.
&nbsp;	 * @param tomcat the Tomcat server.
&nbsp;	 * @return a new {@link TomcatWebServer} instance
&nbsp;	 */
&nbsp;	protected TomcatWebServer getTomcatWebServer(Tomcat tomcat) {
<b class="nc">&nbsp;		return new TomcatWebServer(tomcat, getPort() &gt;= 0, getShutdown());</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setResourceLoader(ResourceLoader resourceLoader) {
<b class="nc">&nbsp;		this.resourceLoader = resourceLoader;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setBaseDirectory(File baseDirectory) {
<b class="nc">&nbsp;		this.baseDirectory = baseDirectory;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable set of the patterns that match jars to ignore for TLD scanning.
&nbsp;	 * @return the list of jars to ignore for TLD scanning
&nbsp;	 */
&nbsp;	public Set&lt;String&gt; getTldSkipPatterns() {
<b class="nc">&nbsp;		return this.tldSkipPatterns;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set the patterns that match jars to ignore for TLD scanning. See Tomcat&#39;s
&nbsp;	 * catalina.properties for typical values. Defaults to a list drawn from that source.
&nbsp;	 * @param patterns the jar patterns to skip when scanning for TLDs etc
&nbsp;	 */
&nbsp;	public void setTldSkipPatterns(Collection&lt;String&gt; patterns) {
<b class="nc">&nbsp;		Assert.notNull(patterns, &quot;Patterns must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tldSkipPatterns = new LinkedHashSet&lt;&gt;(patterns);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add patterns that match jars to ignore for TLD scanning. See Tomcat&#39;s
&nbsp;	 * catalina.properties for typical values.
&nbsp;	 * @param patterns the additional jar patterns to skip when scanning for TLDs etc
&nbsp;	 */
&nbsp;	public void addTldSkipPatterns(String... patterns) {
<b class="nc">&nbsp;		Assert.notNull(patterns, &quot;Patterns must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tldSkipPatterns.addAll(Arrays.asList(patterns));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * The Tomcat protocol to use when create the {@link Connector}.
&nbsp;	 * @param protocol the protocol
&nbsp;	 * @see Connector#Connector(String)
&nbsp;	 */
&nbsp;	public void setProtocol(String protocol) {
<b class="nc">&nbsp;		Assert.hasLength(protocol, &quot;Protocol must not be empty&quot;);</b>
<b class="nc">&nbsp;		this.protocol = protocol;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link Valve}s that should be applied to the Tomcat {@link Engine}. Calling
&nbsp;	 * this method will replace any existing valves.
&nbsp;	 * @param engineValves the valves to set
&nbsp;	 */
&nbsp;	public void setEngineValves(Collection&lt;? extends Valve&gt; engineValves) {
<b class="nc">&nbsp;		Assert.notNull(engineValves, &quot;Valves must not be null&quot;);</b>
<b class="nc">&nbsp;		this.engineValves = new ArrayList&lt;&gt;(engineValves);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link Valve}s that will be applied to the
&nbsp;	 * Tomcat {@link Engine}.
&nbsp;	 * @return the engine valves that will be applied
&nbsp;	 */
&nbsp;	public Collection&lt;Valve&gt; getEngineValves() {
<b class="nc">&nbsp;		return this.engineValves;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void addEngineValves(Valve... engineValves) {
<b class="nc">&nbsp;		Assert.notNull(engineValves, &quot;Valves must not be null&quot;);</b>
<b class="nc">&nbsp;		this.engineValves.addAll(Arrays.asList(engineValves));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link Valve}s that should be applied to the Tomcat {@link Context}. Calling
&nbsp;	 * this method will replace any existing valves.
&nbsp;	 * @param contextValves the valves to set
&nbsp;	 */
&nbsp;	public void setContextValves(Collection&lt;? extends Valve&gt; contextValves) {
<b class="nc">&nbsp;		Assert.notNull(contextValves, &quot;Valves must not be null&quot;);</b>
<b class="nc">&nbsp;		this.contextValves = new ArrayList&lt;&gt;(contextValves);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link Valve}s that will be applied to the
&nbsp;	 * Tomcat {@link Context}.
&nbsp;	 * @return the context valves that will be applied
&nbsp;	 * @see #getEngineValves()
&nbsp;	 */
&nbsp;	public Collection&lt;Valve&gt; getContextValves() {
<b class="nc">&nbsp;		return this.contextValves;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add {@link Valve}s that should be applied to the Tomcat {@link Context}.
&nbsp;	 * @param contextValves the valves to add
&nbsp;	 */
&nbsp;	public void addContextValves(Valve... contextValves) {
<b class="nc">&nbsp;		Assert.notNull(contextValves, &quot;Valves must not be null&quot;);</b>
<b class="nc">&nbsp;		this.contextValves.addAll(Arrays.asList(contextValves));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link LifecycleListener}s that should be applied to the Tomcat
&nbsp;	 * {@link Context}. Calling this method will replace any existing listeners.
&nbsp;	 * @param contextLifecycleListeners the listeners to set
&nbsp;	 */
&nbsp;	public void setContextLifecycleListeners(Collection&lt;? extends LifecycleListener&gt; contextLifecycleListeners) {
<b class="nc">&nbsp;		Assert.notNull(contextLifecycleListeners, &quot;ContextLifecycleListeners must not be null&quot;);</b>
<b class="nc">&nbsp;		this.contextLifecycleListeners = new ArrayList&lt;&gt;(contextLifecycleListeners);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link LifecycleListener}s that will be applied
&nbsp;	 * to the Tomcat {@link Context}.
&nbsp;	 * @return the context lifecycle listeners that will be applied
&nbsp;	 */
&nbsp;	public Collection&lt;LifecycleListener&gt; getContextLifecycleListeners() {
<b class="nc">&nbsp;		return this.contextLifecycleListeners;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add {@link LifecycleListener}s that should be added to the Tomcat {@link Context}.
&nbsp;	 * @param contextLifecycleListeners the listeners to add
&nbsp;	 */
&nbsp;	public void addContextLifecycleListeners(LifecycleListener... contextLifecycleListeners) {
<b class="nc">&nbsp;		Assert.notNull(contextLifecycleListeners, &quot;ContextLifecycleListeners must not be null&quot;);</b>
<b class="nc">&nbsp;		this.contextLifecycleListeners.addAll(Arrays.asList(contextLifecycleListeners));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link TomcatContextCustomizer}s that should be applied to the Tomcat
&nbsp;	 * {@link Context}. Calling this method will replace any existing customizers.
&nbsp;	 * @param tomcatContextCustomizers the customizers to set
&nbsp;	 */
&nbsp;	public void setTomcatContextCustomizers(Collection&lt;? extends TomcatContextCustomizer&gt; tomcatContextCustomizers) {
<b class="nc">&nbsp;		Assert.notNull(tomcatContextCustomizers, &quot;TomcatContextCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatContextCustomizers = new LinkedHashSet&lt;&gt;(tomcatContextCustomizers);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link TomcatContextCustomizer}s that will be
&nbsp;	 * applied to the Tomcat {@link Context}.
&nbsp;	 * @return the listeners that will be applied
&nbsp;	 */
&nbsp;	public Collection&lt;TomcatContextCustomizer&gt; getTomcatContextCustomizers() {
<b class="nc">&nbsp;		return this.tomcatContextCustomizers;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void addContextCustomizers(TomcatContextCustomizer... tomcatContextCustomizers) {
<b class="nc">&nbsp;		Assert.notNull(tomcatContextCustomizers, &quot;TomcatContextCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatContextCustomizers.addAll(Arrays.asList(tomcatContextCustomizers));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link TomcatConnectorCustomizer}s that should be applied to the Tomcat
&nbsp;	 * {@link Connector}. Calling this method will replace any existing customizers.
&nbsp;	 * @param tomcatConnectorCustomizers the customizers to set
&nbsp;	 */
&nbsp;	public void setTomcatConnectorCustomizers(
&nbsp;			Collection&lt;? extends TomcatConnectorCustomizer&gt; tomcatConnectorCustomizers) {
<b class="nc">&nbsp;		Assert.notNull(tomcatConnectorCustomizers, &quot;TomcatConnectorCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatConnectorCustomizers = new LinkedHashSet&lt;&gt;(tomcatConnectorCustomizers);</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void addConnectorCustomizers(TomcatConnectorCustomizer... tomcatConnectorCustomizers) {
<b class="nc">&nbsp;		Assert.notNull(tomcatConnectorCustomizers, &quot;TomcatConnectorCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatConnectorCustomizers.addAll(Arrays.asList(tomcatConnectorCustomizers));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link TomcatConnectorCustomizer}s that will be
&nbsp;	 * applied to the Tomcat {@link Connector}.
&nbsp;	 * @return the customizers that will be applied
&nbsp;	 */
&nbsp;	public Collection&lt;TomcatConnectorCustomizer&gt; getTomcatConnectorCustomizers() {
<b class="nc">&nbsp;		return this.tomcatConnectorCustomizers;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set {@link TomcatProtocolHandlerCustomizer}s that should be applied to the Tomcat
&nbsp;	 * {@link Connector}. Calling this method will replace any existing customizers.
&nbsp;	 * @param tomcatProtocolHandlerCustomizer the customizers to set
&nbsp;	 * @since 2.2.0
&nbsp;	 */
&nbsp;	public void setTomcatProtocolHandlerCustomizers(
&nbsp;			Collection&lt;? extends TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; tomcatProtocolHandlerCustomizer) {
<b class="nc">&nbsp;		Assert.notNull(tomcatProtocolHandlerCustomizer, &quot;TomcatProtocolHandlerCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatProtocolHandlerCustomizers = new LinkedHashSet&lt;&gt;(tomcatProtocolHandlerCustomizer);</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add {@link TomcatProtocolHandlerCustomizer}s that should be added to the Tomcat
&nbsp;	 * {@link Connector}.
&nbsp;	 * @param tomcatProtocolHandlerCustomizers the customizers to add
&nbsp;	 * @since 2.2.0
&nbsp;	 */
&nbsp;	@Override
&nbsp;	public void addProtocolHandlerCustomizers(TomcatProtocolHandlerCustomizer&lt;?&gt;... tomcatProtocolHandlerCustomizers) {
<b class="nc">&nbsp;		Assert.notNull(tomcatProtocolHandlerCustomizers, &quot;TomcatProtocolHandlerCustomizers must not be null&quot;);</b>
<b class="nc">&nbsp;		this.tomcatProtocolHandlerCustomizers.addAll(Arrays.asList(tomcatProtocolHandlerCustomizers));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link TomcatProtocolHandlerCustomizer}s that
&nbsp;	 * will be applied to the Tomcat {@link Connector}.
&nbsp;	 * @return the customizers that will be applied
&nbsp;	 * @since 2.2.0
&nbsp;	 */
&nbsp;	public Collection&lt;TomcatProtocolHandlerCustomizer&lt;?&gt;&gt; getTomcatProtocolHandlerCustomizers() {
<b class="nc">&nbsp;		return this.tomcatProtocolHandlerCustomizers;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Add {@link Connector}s in addition to the default connector, e.g. for SSL or AJP.
&nbsp;	 * &lt;p&gt;
&nbsp;	 * {@link #getTomcatConnectorCustomizers Connector customizers} are not applied to
&nbsp;	 * connectors added this way.
&nbsp;	 * @param connectors the connectors to add
&nbsp;	 */
&nbsp;	public void addAdditionalTomcatConnectors(Connector... connectors) {
<b class="nc">&nbsp;		Assert.notNull(connectors, &quot;Connectors must not be null&quot;);</b>
<b class="nc">&nbsp;		this.additionalTomcatConnectors.addAll(Arrays.asList(connectors));</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns a mutable collection of the {@link Connector}s that will be added to the
&nbsp;	 * Tomcat.
&nbsp;	 * @return the additionalTomcatConnectors
&nbsp;	 */
&nbsp;	public List&lt;Connector&gt; getAdditionalTomcatConnectors() {
<b class="nc">&nbsp;		return this.additionalTomcatConnectors;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setUriEncoding(Charset uriEncoding) {
<b class="nc">&nbsp;		this.uriEncoding = uriEncoding;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Returns the character encoding to use for URL decoding.
&nbsp;	 * @return the URI encoding
&nbsp;	 */
&nbsp;	public Charset getUriEncoding() {
<b class="nc">&nbsp;		return this.uriEncoding;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void setBackgroundProcessorDelay(int delay) {
<b class="nc">&nbsp;		this.backgroundProcessorDelay = delay;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * Set whether the factory should disable Tomcat&#39;s MBean registry prior to creating
&nbsp;	 * the server.
&nbsp;	 * @param disableMBeanRegistry whether to disable the MBean registry
&nbsp;	 * @since 2.2.0
&nbsp;	 */
&nbsp;	public void setDisableMBeanRegistry(boolean disableMBeanRegistry) {
<b class="nc">&nbsp;		this.disableMBeanRegistry = disableMBeanRegistry;</b>
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link LifecycleListener} to disable persistence in the {@link StandardManager}. A
&nbsp;	 * {@link LifecycleListener} is used so not to interfere with Tomcat&#39;s default manager
&nbsp;	 * creation logic.
&nbsp;	 */
<b class="nc">&nbsp;	private static final class DisablePersistSessionListener implements LifecycleListener {</b>
&nbsp;
&nbsp;		@Override
&nbsp;		public void lifecycleEvent(LifecycleEvent event) {
<b class="nc">&nbsp;			if (event.getType().equals(Lifecycle.START_EVENT)) {</b>
<b class="nc">&nbsp;				Context context = (Context) event.getLifecycle();</b>
<b class="nc">&nbsp;				Manager manager = context.getManager();</b>
<b class="nc">&nbsp;				if (manager instanceof StandardManager standardManager) {</b>
<b class="nc">&nbsp;					standardManager.setPathname(null);</b>
&nbsp;				}
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private final class StaticResourceConfigurer implements LifecycleListener {
&nbsp;
&nbsp;		private static final String WEB_APP_MOUNT = &quot;/&quot;;
&nbsp;
&nbsp;		private static final String INTERNAL_PATH = &quot;/META-INF/resources&quot;;
&nbsp;
&nbsp;		private final Context context;
&nbsp;
<b class="nc">&nbsp;		private StaticResourceConfigurer(Context context) {</b>
<b class="nc">&nbsp;			this.context = context;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void lifecycleEvent(LifecycleEvent event) {
<b class="nc">&nbsp;			if (event.getType().equals(Lifecycle.CONFIGURE_START_EVENT)) {</b>
<b class="nc">&nbsp;				addResourceJars(getUrlsOfJarsWithMetaInfResources());</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;		private void addResourceJars(List&lt;URL&gt; resourceJarUrls) {
<b class="nc">&nbsp;			for (URL url : resourceJarUrls) {</b>
<b class="nc">&nbsp;				String path = url.getPath();</b>
<b class="nc">&nbsp;				if (path.endsWith(&quot;.jar&quot;) || path.endsWith(&quot;.jar!/&quot;)) {</b>
<b class="nc">&nbsp;					String jar = url.toString();</b>
<b class="nc">&nbsp;					if (!jar.startsWith(&quot;jar:&quot;)) {</b>
&nbsp;						// A jar file in the file system. Convert to Jar URL.
<b class="nc">&nbsp;						jar = &quot;jar:&quot; + jar + &quot;!/&quot;;</b>
&nbsp;					}
<b class="nc">&nbsp;					addResourceSet(jar);</b>
<b class="nc">&nbsp;				}</b>
&nbsp;				else {
<b class="nc">&nbsp;					addResourceSet(url.toString());</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private void addResourceSet(String resource) {
&nbsp;			try {
<b class="nc">&nbsp;				if (isInsideClassicNestedJar(resource)) {</b>
<b class="nc">&nbsp;					addClassicNestedResourceSet(resource);</b>
&nbsp;					return;
&nbsp;				}
<b class="nc">&nbsp;				WebResourceRoot root = this.context.getResources();</b>
<b class="nc">&nbsp;				URL url = new URL(resource);</b>
<b class="nc">&nbsp;				if (isInsideNestedJar(resource)) {</b>
<b class="nc">&nbsp;					root.addJarResources(new NestedJarResourceSet(url, root, WEB_APP_MOUNT, INTERNAL_PATH));</b>
&nbsp;				}
&nbsp;				else {
<b class="nc">&nbsp;					root.createWebResourceSet(ResourceSetType.RESOURCE_JAR, WEB_APP_MOUNT, url, INTERNAL_PATH);</b>
&nbsp;				}
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception ex) {</b>
&nbsp;				// Ignore (probably not a directory)
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		private void addClassicNestedResourceSet(String resource) throws MalformedURLException {
&nbsp;			// It&#39;s a nested jar but we now don&#39;t want the suffix because Tomcat
&nbsp;			// is going to try and locate it as a root URL (not the resource
&nbsp;			// inside it)
<b class="nc">&nbsp;			URL url = new URL(resource.substring(0, resource.length() - 2));</b>
<b class="nc">&nbsp;			this.context.getResources()</b>
<b class="nc">&nbsp;				.createWebResourceSet(ResourceSetType.RESOURCE_JAR, WEB_APP_MOUNT, url, INTERNAL_PATH);</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean isInsideClassicNestedJar(String resource) {
<b class="nc">&nbsp;			return !isInsideNestedJar(resource) &amp;&amp; resource.indexOf(&quot;!/&quot;) &lt; resource.lastIndexOf(&quot;!/&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;		private boolean isInsideNestedJar(String resource) {
<b class="nc">&nbsp;			return resource.startsWith(&quot;jar:nested:&quot;);</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private static final class LoaderHidingResourceRoot extends StandardRoot {
&nbsp;
&nbsp;		private LoaderHidingResourceRoot(TomcatEmbeddedContext context) {
<b class="nc">&nbsp;			super(context);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		protected WebResourceSet createMainResourceSet() {
<b class="nc">&nbsp;			return new LoaderHidingWebResourceSet(super.createMainResourceSet());</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	private static final class LoaderHidingWebResourceSet extends AbstractResourceSet {
&nbsp;
&nbsp;		private final WebResourceSet delegate;
&nbsp;
&nbsp;		private final Method initInternal;
&nbsp;
<b class="nc">&nbsp;		private LoaderHidingWebResourceSet(WebResourceSet delegate) {</b>
<b class="nc">&nbsp;			this.delegate = delegate;</b>
&nbsp;			try {
<b class="nc">&nbsp;				this.initInternal = LifecycleBase.class.getDeclaredMethod(&quot;initInternal&quot;);</b>
<b class="nc">&nbsp;				this.initInternal.setAccessible(true);</b>
&nbsp;			}
<b class="nc">&nbsp;			catch (Exception ex) {</b>
<b class="nc">&nbsp;				throw new IllegalStateException(ex);</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public WebResource getResource(String path) {
<b class="nc">&nbsp;			if (path.startsWith(&quot;/org/springframework/boot&quot;)) {</b>
<b class="nc">&nbsp;				return new EmptyResource(getRoot(), path);</b>
&nbsp;			}
<b class="nc">&nbsp;			return this.delegate.getResource(path);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String[] list(String path) {
<b class="nc">&nbsp;			return this.delegate.list(path);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public Set&lt;String&gt; listWebAppPaths(String path) {
<b class="nc">&nbsp;			return this.delegate.listWebAppPaths(path)</b>
<b class="nc">&nbsp;				.stream()</b>
<b class="nc">&nbsp;				.filter((webAppPath) -&gt; !webAppPath.startsWith(&quot;/org/springframework/boot&quot;))</b>
<b class="nc">&nbsp;				.collect(Collectors.toSet());</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean mkdir(String path) {
<b class="nc">&nbsp;			return this.delegate.mkdir(path);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean write(String path, InputStream is, boolean overwrite) {
<b class="nc">&nbsp;			return this.delegate.write(path, is, overwrite);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public URL getBaseUrl() {
<b class="nc">&nbsp;			return this.delegate.getBaseUrl();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void setReadOnly(boolean readOnly) {
<b class="nc">&nbsp;			this.delegate.setReadOnly(readOnly);</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public boolean isReadOnly() {
<b class="nc">&nbsp;			return this.delegate.isReadOnly();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public void gc() {
<b class="nc">&nbsp;			this.delegate.gc();</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		protected void initInternal() throws LifecycleException {
<b class="nc">&nbsp;			if (this.delegate instanceof LifecycleBase) {</b>
&nbsp;				try {
<b class="nc">&nbsp;					ReflectionUtils.invokeMethod(this.initInternal, this.delegate);</b>
&nbsp;				}
<b class="nc">&nbsp;				catch (Exception ex) {</b>
<b class="nc">&nbsp;					throw new LifecycleException(ex);</b>
<b class="nc">&nbsp;				}</b>
&nbsp;			}
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;	/**
&nbsp;	 * {@link Rfc6265CookieProcessor} that supports {@link CookieSameSiteSupplier
&nbsp;	 * supplied} {@link SameSite} values.
&nbsp;	 */
&nbsp;	private static class SuppliedSameSiteCookieProcessor extends Rfc6265CookieProcessor {
&nbsp;
&nbsp;		private final List&lt;CookieSameSiteSupplier&gt; suppliers;
&nbsp;
<b class="nc">&nbsp;		SuppliedSameSiteCookieProcessor(List&lt;CookieSameSiteSupplier&gt; suppliers) {</b>
<b class="nc">&nbsp;			this.suppliers = suppliers;</b>
&nbsp;		}
&nbsp;
&nbsp;		@Override
&nbsp;		public String generateHeader(Cookie cookie, HttpServletRequest request) {
<b class="nc">&nbsp;			SameSite sameSite = getSameSite(cookie);</b>
<b class="nc">&nbsp;			if (sameSite == null) {</b>
<b class="nc">&nbsp;				return super.generateHeader(cookie, request);</b>
&nbsp;			}
<b class="nc">&nbsp;			Rfc6265CookieProcessor delegate = new Rfc6265CookieProcessor();</b>
<b class="nc">&nbsp;			delegate.setSameSiteCookies(sameSite.attributeValue());</b>
<b class="nc">&nbsp;			return delegate.generateHeader(cookie, request);</b>
&nbsp;		}
&nbsp;
&nbsp;		private SameSite getSameSite(Cookie cookie) {
<b class="nc">&nbsp;			for (CookieSameSiteSupplier supplier : this.suppliers) {</b>
<b class="nc">&nbsp;				SameSite sameSite = supplier.getSameSite(cookie);</b>
<b class="nc">&nbsp;				if (sameSite != null) {</b>
<b class="nc">&nbsp;					return sameSite;</b>
&nbsp;				}
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			return null;</b>
&nbsp;		}
&nbsp;
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
