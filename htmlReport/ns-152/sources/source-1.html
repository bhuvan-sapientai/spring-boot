


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > CloudFoundryVcapEnvironmentPostProcessor</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.springframework.boot.cloud</a>
</div>

<h1>Coverage Summary for Class: CloudFoundryVcapEnvironmentPostProcessor (org.springframework.boot.cloud)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">CloudFoundryVcapEnvironmentPostProcessor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/72)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2012-2022 the original author or authors.
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *      https://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.springframework.boot.cloud;
&nbsp;
&nbsp;import java.util.Collection;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;import java.util.Properties;
&nbsp;
&nbsp;import org.apache.commons.logging.Log;
&nbsp;
&nbsp;import org.springframework.boot.SpringApplication;
&nbsp;import org.springframework.boot.context.config.ConfigDataEnvironmentPostProcessor;
&nbsp;import org.springframework.boot.env.EnvironmentPostProcessor;
&nbsp;import org.springframework.boot.json.JsonParser;
&nbsp;import org.springframework.boot.json.JsonParserFactory;
&nbsp;import org.springframework.boot.logging.DeferredLogFactory;
&nbsp;import org.springframework.core.Ordered;
&nbsp;import org.springframework.core.env.CommandLinePropertySource;
&nbsp;import org.springframework.core.env.ConfigurableEnvironment;
&nbsp;import org.springframework.core.env.Environment;
&nbsp;import org.springframework.core.env.MutablePropertySources;
&nbsp;import org.springframework.core.env.PropertiesPropertySource;
&nbsp;import org.springframework.util.StringUtils;
&nbsp;
&nbsp;/**
&nbsp; * An {@link EnvironmentPostProcessor} that knows where to find VCAP (a.k.a. Cloud
&nbsp; * Foundry) metadata in the existing environment. It parses out the VCAP_APPLICATION and
&nbsp; * VCAP_SERVICES metadata and dumps it in a form that is easily consumed by
&nbsp; * {@link Environment} users. If the app is running in Cloud Foundry then both metadata
&nbsp; * items are JSON objects encoded in OS environment variables. VCAP_APPLICATION is a
&nbsp; * shallow hash with basic information about the application (name, instance id, instance
&nbsp; * index, etc.), and VCAP_SERVICES is a hash of lists where the keys are service labels
&nbsp; * and the values are lists of hashes of service instance metadata. Examples are:
&nbsp; *
&nbsp; * &lt;pre class=&quot;code&quot;&gt;
&nbsp; * VCAP_APPLICATION: {&quot;instance_id&quot;:&quot;2ce0ac627a6c8e47e936d829a3a47b5b&quot;,&quot;instance_index&quot;:0,
&nbsp; *   &quot;version&quot;:&quot;0138c4a6-2a73-416b-aca0-572c09f7ca53&quot;,&quot;name&quot;:&quot;foo&quot;,
&nbsp; *   &quot;uris&quot;:[&quot;foo.cfapps.io&quot;], ...}
&nbsp; * VCAP_SERVICES: {&quot;rds-mysql-1.0&quot;:[{&quot;name&quot;:&quot;mysql&quot;,&quot;label&quot;:&quot;rds-mysql-1.0&quot;,&quot;plan&quot;:&quot;10mb&quot;,
&nbsp; *   &quot;credentials&quot;:{&quot;name&quot;:&quot;d04fb13d27d964c62b267bbba1cffb9da&quot;,&quot;hostname&quot;:&quot;mysql-service-public.clqg2e2w3ecf.us-east-1.rds.amazonaws.com&quot;,
&nbsp; *   &quot;host&quot;:&quot;mysql-service-public.clqg2e2w3ecf.us-east-1.rds.amazonaws.com&quot;,&quot;port&quot;:3306,&quot;user&quot;:&quot;urpRuqTf8Cpe6&quot;,
&nbsp; *   &quot;username&quot;:&quot;urpRuqTf8Cpe6&quot;,&quot;password&quot;:&quot;pxLsGVpsC9A5S&quot;}
&nbsp; * }]}
&nbsp; * &lt;/pre&gt;
&nbsp; *
&nbsp; * These objects are flattened into properties. The VCAP_APPLICATION object goes straight
&nbsp; * to {@code vcap.application.*} in a fairly obvious way, and the VCAP_SERVICES object is
&nbsp; * unwrapped so that it is a hash of objects with key equal to the service instance name
&nbsp; * (e.g. &quot;mysql&quot; in the example above), and value equal to that instances properties, and
&nbsp; * then flattened in the same way. E.g.
&nbsp; *
&nbsp; * &lt;pre class=&quot;code&quot;&gt;
&nbsp; * vcap.application.instance_id: 2ce0ac627a6c8e47e936d829a3a47b5b
&nbsp; * vcap.application.version: 0138c4a6-2a73-416b-aca0-572c09f7ca53
&nbsp; * vcap.application.name: foo
&nbsp; * vcap.application.uris[0]: foo.cfapps.io
&nbsp; *
&nbsp; * vcap.services.mysql.name: mysql
&nbsp; * vcap.services.mysql.label: rds-mysql-1.0
&nbsp; * vcap.services.mysql.credentials.name: d04fb13d27d964c62b267bbba1cffb9da
&nbsp; * vcap.services.mysql.credentials.port: 3306
&nbsp; * vcap.services.mysql.credentials.host: mysql-service-public.clqg2e2w3ecf.us-east-1.rds.amazonaws.com
&nbsp; * vcap.services.mysql.credentials.username: urpRuqTf8Cpe6
&nbsp; * vcap.services.mysql.credentials.password: pxLsGVpsC9A5S
&nbsp; * ...
&nbsp; * &lt;/pre&gt;
&nbsp; *
&nbsp; * N.B. this initializer is mainly intended for informational use (the application and
&nbsp; * instance ids are particularly useful). For service binding you might find that Spring
&nbsp; * Cloud is more convenient and more robust against potential changes in Cloud Foundry.
&nbsp; *
&nbsp; * @author Dave Syer
&nbsp; * @author Andy Wilkinson
&nbsp; * @since 1.3.0
&nbsp; */
&nbsp;public class CloudFoundryVcapEnvironmentPostProcessor implements EnvironmentPostProcessor, Ordered {
&nbsp;
&nbsp;	private static final String VCAP_APPLICATION = &quot;VCAP_APPLICATION&quot;;
&nbsp;
&nbsp;	private static final String VCAP_SERVICES = &quot;VCAP_SERVICES&quot;;
&nbsp;
&nbsp;	private final Log logger;
&nbsp;
&nbsp;	// Before ConfigDataEnvironmentPostProcessor so values there can use these
<b class="nc">&nbsp;	private int order = ConfigDataEnvironmentPostProcessor.ORDER - 1;</b>
&nbsp;
&nbsp;	/**
&nbsp;	 * Create a new {@link CloudFoundryVcapEnvironmentPostProcessor} instance.
&nbsp;	 * @param logFactory the log factory to use
&nbsp;	 * @since 3.0.0
&nbsp;	 */
<b class="nc">&nbsp;	public CloudFoundryVcapEnvironmentPostProcessor(DeferredLogFactory logFactory) {</b>
<b class="nc">&nbsp;		this.logger = logFactory.getLog(CloudFoundryVcapEnvironmentPostProcessor.class);</b>
&nbsp;	}
&nbsp;
&nbsp;	public void setOrder(int order) {
<b class="nc">&nbsp;		this.order = order;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public int getOrder() {
<b class="nc">&nbsp;		return this.order;</b>
&nbsp;	}
&nbsp;
&nbsp;	@Override
&nbsp;	public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) {
<b class="nc">&nbsp;		if (CloudPlatform.CLOUD_FOUNDRY.isActive(environment)) {</b>
<b class="nc">&nbsp;			Properties properties = new Properties();</b>
<b class="nc">&nbsp;			JsonParser jsonParser = JsonParserFactory.getJsonParser();</b>
<b class="nc">&nbsp;			addWithPrefix(properties, getPropertiesFromApplication(environment, jsonParser), &quot;vcap.application.&quot;);</b>
<b class="nc">&nbsp;			addWithPrefix(properties, getPropertiesFromServices(environment, jsonParser), &quot;vcap.services.&quot;);</b>
<b class="nc">&nbsp;			MutablePropertySources propertySources = environment.getPropertySources();</b>
<b class="nc">&nbsp;			if (propertySources.contains(CommandLinePropertySource.COMMAND_LINE_PROPERTY_SOURCE_NAME)) {</b>
<b class="nc">&nbsp;				propertySources.addAfter(CommandLinePropertySource.COMMAND_LINE_PROPERTY_SOURCE_NAME,</b>
&nbsp;						new PropertiesPropertySource(&quot;vcap&quot;, properties));
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				propertySources.addFirst(new PropertiesPropertySource(&quot;vcap&quot;, properties));</b>
&nbsp;			}
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void addWithPrefix(Properties properties, Properties other, String prefix) {
<b class="nc">&nbsp;		for (String key : other.stringPropertyNames()) {</b>
<b class="nc">&nbsp;			String prefixed = prefix + key;</b>
<b class="nc">&nbsp;			properties.setProperty(prefixed, other.getProperty(key));</b>
<b class="nc">&nbsp;		}</b>
&nbsp;	}
&nbsp;
&nbsp;	private Properties getPropertiesFromApplication(Environment environment, JsonParser parser) {
<b class="nc">&nbsp;		Properties properties = new Properties();</b>
&nbsp;		try {
<b class="nc">&nbsp;			String property = environment.getProperty(VCAP_APPLICATION, &quot;{}&quot;);</b>
<b class="nc">&nbsp;			Map&lt;String, Object&gt; map = parser.parseMap(property);</b>
<b class="nc">&nbsp;			extractPropertiesFromApplication(properties, map);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			this.logger.error(&quot;Could not parse VCAP_APPLICATION&quot;, ex);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return properties;</b>
&nbsp;	}
&nbsp;
&nbsp;	private Properties getPropertiesFromServices(Environment environment, JsonParser parser) {
<b class="nc">&nbsp;		Properties properties = new Properties();</b>
&nbsp;		try {
<b class="nc">&nbsp;			String property = environment.getProperty(VCAP_SERVICES, &quot;{}&quot;);</b>
<b class="nc">&nbsp;			Map&lt;String, Object&gt; map = parser.parseMap(property);</b>
<b class="nc">&nbsp;			extractPropertiesFromServices(properties, map);</b>
&nbsp;		}
<b class="nc">&nbsp;		catch (Exception ex) {</b>
<b class="nc">&nbsp;			this.logger.error(&quot;Could not parse VCAP_SERVICES&quot;, ex);</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return properties;</b>
&nbsp;	}
&nbsp;
&nbsp;	private void extractPropertiesFromApplication(Properties properties, Map&lt;String, Object&gt; map) {
<b class="nc">&nbsp;		if (map != null) {</b>
<b class="nc">&nbsp;			flatten(properties, map, &quot;&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void extractPropertiesFromServices(Properties properties, Map&lt;String, Object&gt; map) {
<b class="nc">&nbsp;		if (map != null) {</b>
<b class="nc">&nbsp;			for (Object services : map.values()) {</b>
&nbsp;				@SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;				List&lt;Object&gt; list = (List&lt;Object&gt;) services;</b>
<b class="nc">&nbsp;				for (Object object : list) {</b>
&nbsp;					@SuppressWarnings(&quot;unchecked&quot;)
<b class="nc">&nbsp;					Map&lt;String, Object&gt; service = (Map&lt;String, Object&gt;) object;</b>
<b class="nc">&nbsp;					String key = (String) service.get(&quot;name&quot;);</b>
<b class="nc">&nbsp;					if (key == null) {</b>
<b class="nc">&nbsp;						key = (String) service.get(&quot;label&quot;);</b>
&nbsp;					}
<b class="nc">&nbsp;					flatten(properties, service, key);</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;			}</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	@SuppressWarnings(&quot;unchecked&quot;)
&nbsp;	private void flatten(Properties properties, Map&lt;String, Object&gt; input, String path) {
<b class="nc">&nbsp;		input.forEach((key, value) -&gt; {</b>
<b class="nc">&nbsp;			String name = getPropertyName(path, key);</b>
<b class="nc">&nbsp;			if (value instanceof Map) {</b>
&nbsp;				// Need a compound key
<b class="nc">&nbsp;				flatten(properties, (Map&lt;String, Object&gt;) value, name);</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (value instanceof Collection) {</b>
&nbsp;				// Need a compound key
<b class="nc">&nbsp;				Collection&lt;Object&gt; collection = (Collection&lt;Object&gt;) value;</b>
<b class="nc">&nbsp;				properties.put(name, StringUtils.collectionToCommaDelimitedString(collection));</b>
<b class="nc">&nbsp;				int count = 0;</b>
<b class="nc">&nbsp;				for (Object item : collection) {</b>
<b class="nc">&nbsp;					String itemKey = &quot;[&quot; + (count++) + &quot;]&quot;;</b>
<b class="nc">&nbsp;					flatten(properties, Collections.singletonMap(itemKey, item), name);</b>
<b class="nc">&nbsp;				}</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			else if (value instanceof String) {</b>
<b class="nc">&nbsp;				properties.put(name, value);</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (value instanceof Number) {</b>
<b class="nc">&nbsp;				properties.put(name, value.toString());</b>
&nbsp;			}
<b class="nc">&nbsp;			else if (value instanceof Boolean) {</b>
<b class="nc">&nbsp;				properties.put(name, value.toString());</b>
&nbsp;			}
&nbsp;			else {
<b class="nc">&nbsp;				properties.put(name, (value != null) ? value : &quot;&quot;);</b>
&nbsp;			}
&nbsp;		});
&nbsp;	}
&nbsp;
&nbsp;	private String getPropertyName(String path, String key) {
<b class="nc">&nbsp;		if (!StringUtils.hasText(path)) {</b>
<b class="nc">&nbsp;			return key;</b>
&nbsp;		}
<b class="nc">&nbsp;		if (key.startsWith(&quot;[&quot;)) {</b>
<b class="nc">&nbsp;			return path + key;</b>
&nbsp;		}
<b class="nc">&nbsp;		return path + &quot;.&quot; + key;</b>
&nbsp;	}
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-01 11:12</div>
</div>
</body>
</html>
